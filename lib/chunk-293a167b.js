(globalThis.webpackChunk_croquet_microverse=globalThis.webpackChunk_croquet_microverse||[]).push([[506],{1478:(e,r,t)=>{"use strict";t.r(r),t.d(r,{startShell:()=>function startShell(){o=new Shell}});var a=t(4200);const s="croquet:microverse:";let o;r=new URL(window.location).searchParams,t=r.has("showSettings"),r=r.has("voiceChat"),t=r||t;let i=(t?function loadLocalStorage(){if(!window.localStorage)return null;try{var e=JSON.parse(window.localStorage.getItem("microverse-settings"));if(e&&"1"===e.version)return e;throw new Error("different version of data")}catch(e){return null}}():null)||{};i.voice=r,i.showSettings=t;class Shell{constructor(){var e=shellToCanonicalURL(location.href),e=(e!==location.href&&(console.log("shell: redirecting to canonical URL",e),location.href=e),console.log("shell: starting"),this.frames=new Map,this.portalData=new Map,this.awaitedFrameTypes={},this.awaitedRenders={},a.App.autoSession(),a.App.autoPassword(),this.primaryFrameId=this.addFrame(null,a.App.sessionURL)),r=frameToPortalURL(this.primaryFrame.src);window.history.replaceState({portalId:e},null,r),setTitle(r),document.getElementById("hud").remove(),document.getElementById("shell-hud").classList.toggle("is-shell",!0),window.addEventListener("message",e=>{if(e.data?.message?.startsWith?.(s)){var r,t,a=e.data.message.substring(s.length);for([r,{frame:t}]of this.frames)if(e.source===t.contentWindow)return void this.receiveFromPortal(r,t,a,e.data);console.warn(`shell: ignoring ${a} from removed frame`)}}),window.addEventListener("popstate",e=>{let r=e.state["portalId"],t=this.frameEntry(r)?.frame;if(!t){const o=frameToPortalURL(shellToCanonicalURL(location.href));for(var[a,{frame:s}]of this.frames)if(frameToPortalURL(s.src)===o){t=s,r=a;break}}t||location.reload();const o=frameToPortalURL(t.src);o===shellToCanonicalURL(location.href)?(this.activateFrame(r,!1),setTitle(o)):console.warn(`shell: popstate location=${location}
does not match portal-${r} frame.src=`+t.src)}),this.fullscreenBtn=document.getElementById("fullscreenBtn"),this.fullscreenBtn.onclick=e=>{e.stopPropagation(),e.preventDefault(),e.shiftKey?document.body.classList.toggle("tilt"):document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.body.requestFullscreen()},this.capturedPointers={},this.joystick=document.getElementById("joystick"),this.knob=document.getElementById("knob"),this.trackingknob=document.getElementById("trackingknob"),this.adjustJoystickKnob(),window.onresize=()=>this.adjustJoystickKnob(),document.head.querySelector("#joystick-css")||((e=document.createElement("link")).rel="stylesheet",e.type="text/css",e.id="joystick-css",e.onload=()=>{this.adjustJoystickKnob(),this._hudFlags&&(this.setButtonsVisibility(this._hudFlags),delete this._hudFlags)},r=window.microverseDir||"./",e.href=r+"assets/css/joystick.css",document.head.appendChild(e)),this.releaseHandler=e=>{for(var r in this.capturedPointers)this.trackingknob.releasePointerCapture(r);this.capturedPointers={},this.endMMotion(e)},this.trackingknob.onpointerdown=e=>{void 0!==e.pointerId&&(this.capturedPointers[e.pointerId]="hiddenKnob",this.trackingknob.setPointerCapture(e.pointerId)),this.startMMotion(e)},this.trackingknob.onpointermove=e=>this.updateMMotion(e),this.trackingknob.onpointerup=e=>this.releaseHandler(e),this.trackingknob.onpointercancel=e=>this.releaseHandler(e),this.trackingknob.onlostpointercapture=e=>this.releaseHandler(e)}adjustJoystickKnob(){var e=window.getComputedStyle(this.joystick),r=window.getComputedStyle(this.knob),e=(parseFloat(e.width)||120)/2,r=(parseFloat(r.width)||60)/2;this.joystickLayout={center:e,size:r,radius:e-r},this.trackingknob.style.transform="translate(0px, 0px)",this.knob.style.transform=`translate(${e-r}px, ${e-r}px)`}frameEntry(e){return this.frames.get(e)}frameFromId(e){return this.frameEntry(e)?.frame}portalId(e){for(var[r,{frame:t}]of this.frames)if(t===e)return r;return null}get primaryFrame(){return this.frameFromId(this.primaryFrameId)}addFrame(e,r){if(4<=this.frames.size)throw Error("shell: refusing to create more than 4 frames (this indicates a portal bug)");let t;for(;t=Math.random().toString(36).substring(2,15),this.frames.has(t););var a=document.createElement("iframe"),r=(a.src=portalToFrameURL(r,t),a.style.zIndex=-this.frames.size,a.style.setProperty("--tilt-z",-200*this.frames.size+"px"),{frame:a,owningFrame:e,ownedFrames:new Set});return e&&this.frameEntry(e)?.ownedFrames.add(t),this.frames.set(t,r),document.body.appendChild(a),this.sendFrameType(t),t}removeFrame(e){var r=this.frameEntry(e);if(r){var{frame:t,owningFrame:a,ownedFrames:s}=r;if(a&&(this.frameEntry(a)?.ownedFrames.delete(e),r.owningFrame=null),t!==this.primaryFrame){console.log("shell: removing frame "+e),t.remove(),this.frames.delete(e);for(const o of s.values())this.removeFrame(o);this.sortFrames(this.primaryFrame)}else console.log(`shell: primary frame ${e} is no longer owned`)}}sortFrames(t,a){var r=Array.from(this.frames.values()).map(e=>e.frame).sort((e,r)=>e===t?-1:r===t?1:e===a?-1:r===a?1:e.zIndex-r.zIndex);for(let e=0;e<r.length;e++){var s=r[e]["style"];s.zIndex=-e,s.display="",s.setProperty("--tilt-z",-200*e+"px")}}receiveFromPortal(r,e,t,a){switch(t){case"frame-ready":var s=r===this.primaryFrameId?"primary":"secondary";if(a.frameType!==s)return void console.log(`ignoring ${r} frame-ready (${a.frameType}) when expecting `+s);s=this.frameEntry(r);if(!s)return;s.isMicroverse=!0;break;case"avatar-ready":var s=r===this.primaryFrameId?"primary":"secondary";return a.frameType!==s?void console.log(`ignoring ${r} avatar-ready (${a.frameType}) when expecting `+s):(s=this.frameEntry(r))?(s.isMicroverse=!0,clearInterval(s.frameTypeInterval),s.frameTypeInterval=null,void(this.awaitedFrameTypes[r]&&(delete this.awaitedFrameTypes[r],0===Object.keys(this.awaitedFrameTypes).length)&&this.sendToPortal(this.primaryFrameId,"release-freeze"))):void 0;case"portal-open":var o;if(a.portalId)return s=portalToFrameURL(a.portalURL,a.portalId),void((o=this.frameEntry(a.portalId)?.frame)&&portalToFrameURL(o.src,a.portalId)!==s&&(console.warn("shell: portal-open",a.portalId,"replacing",o.src,"with",s),o.src=s));let e=this.findFrame(a.portalURL,e=>!e.owningFrame);return e?(this.frameEntry(e).owningFrame=r,this.frameEntry(r).ownedFrames.add(e)):e=this.addFrame(r,a.portalURL),this.sendToPortal(r,"portal-opened",{portalId:e}),void(r===this.primaryFrameId&&this.sortFrames(this.primaryFrame,this.frameFromId(e)));case"portal-close":return void this.removeFrame(a.portalId);case"portal-update":return r!==this.primaryFrameId?void console.log(`ignoring ${r} portal-update because it's no longer primary`):(this.awaitedRenders={},a.portalSpecs.forEach(e=>{var{portalId:e,cameraMatrix:r}=e,t=(this.sendToPortal(e,"portal-camera-update",{cameraMatrix:r}),this.frameEntry(e));t&&!t.frameTypeInterval&&null!==r&&(this.awaitedRenders[e]=!0),this.portalData.set(e,r)}),void(!this.portalRenderTimeout&&Object.keys(this.awaitedRenders).length&&(this.portalRenderTimeout=setTimeout(()=>{console.log("shell: portal render timed out"),delete this.portalRenderTimeout,this.awaitedRenders={},this.manuallyRenderPrimaryFrame()},200))));case"portal-world-rendered":return void(this.portalRenderTimeout&&this.awaitedRenders[r]&&(delete this.awaitedRenders[r],0===Object.keys(this.awaitedRenders).length)&&(clearTimeout(this.portalRenderTimeout),delete this.portalRenderTimeout,this.manuallyRenderPrimaryFrame()));case"primary-rendered":return void(r===this.primaryFrameId?this.pendingSortFrames&&this.pendingSortFrames&&(this.sortFrames(...this.pendingSortFrames),delete this.pendingSortFrames):console.warn("shell: ignoring primary-rendered from non-primary "+r));case"portal-enter":return void(r===this.primaryFrameId?this.activateFrame(a.portalId,!0,a.transferData):console.warn("shell: ignoring portal-enter from non-primary portal-"+r));case"world-enter":if(r===this.primaryFrameId){let e=this.findFrame(a.portalURL);e||(console.log("shell: world-enter creating frame for",a.portalURL),e=this.addFrame(this.primaryFrameId,a.portalURL)),this.activateFrame(e,!0,a.transferData)}else console.warn("shell: ignoring world-enter from non-primary portal-"+r);return;case"world-replace":if(r===this.primaryFrameId){console.log("shell: world-replace to "+a.targetURL),this.primaryFrame.style.background="black",this.primaryFrame.src="",this.primaryFrame.style.transition="opacity 1s",this.primaryFrame.style.opacity=0,this.removeFrame(this.primaryFrameId);let e=this.findFrame(a.targetURL);e||(console.log("shell: world-replace creating frame for",a.targetURL),e=this.addFrame(null,a.targetURL)),setTimeout(()=>{this.frameEntry(e).isMicroverse=!0,this.activateFrame(e,!0,a.transferData)},1e3)}else console.warn("shell: ignoring world-replace from non-primary portal-"+r);return;case"hud":return void this.setButtonsVisibility(a);case"send-configuration":return console.log("sending config",i),void this.sendToPortal(r,"local-configuration",{localConfig:i});case"update-configuration":return console.log("updated config",a.localConfig),(i=a.localConfig).userHasSet=!0,void function saveLocalStorage(e){if(window.localStorage)try{var{nickname:r,type:t,avatarURL:a,handedness:s}=e,o={version:"1",nickname:r,type:t,avatarURL:a,handedness:s};window.localStorage.setItem("microverse-settings",JSON.stringify(o))}catch(e){}}(a.localConfig);default:console.warn(`shell: received unknown command "${t}" from portal-`+r,a)}}setButtonsVisibility(e){var r=e.joystick,t=e.fullscreen;document.head.querySelector("#joystick-css")||(this._hudFlags={joystick:e.joystick,fullscreen:e.fullscreen}),void 0!==r&&this.joystick&&(r?this.joystick.style.removeProperty("display"):this.joystick.style.setProperty("display","none")),void 0!==t&&this.fullscreenBtn&&(t?this.fullscreenBtn.style.removeProperty("display"):this.fullscreenBtn.style.setProperty("display","none"))}manuallyRenderPrimaryFrame(){var e=!!this.pendingSortFrames;this.sendToPortal(this.primaryFrameId,"sync-render-now",{acknowledgeReceipt:e})}findFrame(e,r=null){e=portalToFrameURL(e,"");var t=["debug"];e:for(var[a,s]of this.frames)if(!r||r(s)){s=s["frame"];if(s.src===e)return a;var o=new URL(e,s.src);if(s.src===o.href)return a;const m=new URL(s.src);if(m.origin===o.origin&&m.pathname===o.pathname){t.forEach(e=>m.searchParams.delete(e));for(var[i,n]of o.searchParams)if(!t.includes(i)){var l=m.searchParams.get(i);if(m.searchParams.delete(i),("portal"!==i&&"anchor"!==i||n&&l)&&l!==n)continue e}if(""===m.searchParams.toString()){s=new URLSearchParams(o.hash.slice(1)),o=new URLSearchParams(m.hash.slice(1));if(s.sort(),o.sort(),s.toString()===o.toString())return a}}}return null}sendToPortal(e,r,t={}){var a=this.frameFromId(e);a?(t.message=s+r,a.contentWindow?.postMessage(t,"*")):console.warn(`shell: sending "${r}" to portal-${e} failed: portal not found`)}sendFrameType(t,e=null){var r=this.primaryFrameId&&this.primaryFrameId!==t?"secondary":"primary";const a=this.frameEntry(t);if(a.frameTypeArgs={frameType:r,spec:e},!a.frameTypeInterval){const s=Date.now();a.frameTypeInterval=setInterval(()=>{var e,r;this.frameEntry(t)?2e4<Date.now()-s&&!a.isMicroverse?(console.log('shell: abandoning "frame-type" send for timed-out portal-'+t),clearInterval(a.frameTypeInterval)):("secondary"===(e=a.frameTypeArgs).frameType&&(r=this.portalData.get(t))&&(e.cameraMatrix=r),this.sendToPortal(t,"frame-type",e)):(console.log('shell: abandoning "frame-type" send for removed portal-'+t),clearInterval(a.frameTypeInterval))},200)}}activateFrame(r,e=!0,t=null){var a=this.frameEntry(r);if(a.isMicroverse){var s=this.primaryFrameId,o=this.primaryFrame,i=this.frameFromId(r),n=frameToPortalURL(i.src);if(this.pendingSortFrames=[i,o],this.pendingSortTimeout&&clearTimeout(this.pendingSortTimeout),this.pendingSortTimeout=setTimeout(()=>{this.pendingSortFrames&&(console.warn("sorting frames after timeout"),this.sortFrames(...this.pendingSortFrames),delete this.pendingSortFrames)},2e3),t&&!t.crossingBackwards&&(o.style.display="none"),e)try{window.history.pushState({portalId:r},null,n)}catch(e){new URL(n,location.href).origin===window.location.origin&&console.error(e),window.history.pushState({portalId:r},null,function portalToShellURL(e){var e=new URL(e,location.href),r=new URL(location.href);for(var[t,a]of e.searchParams)r.searchParams.set(t,a);return e.search="",r.hash=e.hash,e.hash="",r.searchParams.set("canonical",e.href),r.toString()}(n))}setTitle(n),this.primaryFrameId=r,this.portalData.delete(r),this.awaitedRenders={},this.awaitedFrameTypes={},this.frameEntry(s).owningFrame?(console.log('shell: sending frame-type "secondary" to portal-'+s,{portalURL:n}),this.sendFrameType(s,{portalURL:n}),this.awaitedFrameTypes[s]=!0):(console.log("shell: removing unowned secondary frame "+s),this.removeFrame(s)),console.log('shell: sending frame-type "primary" to portal-'+r,t),this.primaryFrame.focus(),this.sendFrameType(r,t),this.awaitedFrameTypes[r]=!0,this.awaitedFramesTimeout&&clearTimeout(this.awaitedFramesTimeout),this.awaitedFramesTimeout=setTimeout(()=>{Object.keys(this.awaitedFrameTypes).length&&(console.warn("releasing freeze after timeout"),this.awaitedFrameTypes={},this.sendToPortal(this.primaryFrameId,"release-freeze"))},2e3),this.activeMMotion&&({dx:i,dy:o}=this.activeMMotion,this.sendToPortal(this.primaryFrameId,"motion-start",{dx:i,dy:o}))}else window.location.href=a.frame.src}startMMotion(e){e.preventDefault(),e.stopPropagation(),this.knobX=e.clientX,this.knobY=e.clientY,this.activeMMotion={dx:0,dy:0},this.sendToPortal(this.primaryFrameId,"motion-start")}endMMotion(e){e.preventDefault(),e.stopPropagation(),this.activeMMotion=null;e=this.joystickLayout.radius;this.trackingknob.style.transform="translate(0px, 0px)",this.knob.style.transform=`translate(${e}px, ${e}px)`,this.sendToPortal(this.primaryFrameId,"motion-end")}updateMMotion(t){if(t.preventDefault(),t.stopPropagation(),this.activeMMotion){let e=t.clientX-this.knobX,r=t.clientY-this.knobY;this.sendToPortal(this.primaryFrameId,"motion-update",{dx:e,dy:r}),this.activeMMotion.dx=e,this.activeMMotion.dy=r,this.trackingknob.style.transform=`translate(${e}px, ${r}px)`;var t=this.joystickLayout["radius"],a=e**2+r**2;t**2<a&&(a=Math.sqrt(a),e=t*e/a,r=t*r/a),this.knob.style.transform=`translate(${t+e}px, ${t+r}px)`}}}function portalToFrameURL(e,r){e=new URL(e,location.href),e.searchParams.set("portal",r),r=e.searchParams.get("world"),"default"===r&&e.searchParams.delete("world"),r=e.pathname.split("/").pop(),"index.html"===r&&(e.pathname=e.pathname.slice(0,-10)),r=[...e.searchParams.entries()].sort((e,r)=>"world"===e[0]||"world"!==r[0]&&"portal"!==e[0]&&("portal"===r[0]||"q"!==e[0]&&("q"===r[0]||e[0]<r[0]))?-1:1);return e.search=new URLSearchParams(r).toString(),e.toString()}function frameToPortalURL(e){var e=new URL(e,location.href),r=(e.searchParams.delete("portal"),e.searchParams.get("world")),r=("default"===r&&e.searchParams.delete("world"),e.pathname.split("/").pop());return"index.html"===r&&(e.pathname=e.pathname.slice(0,-10)),e.toString()}function shellToCanonicalURL(e){var r=new URL(e),t=r.searchParams.get("canonical");if(!t)return e;r.searchParams.delete("canonical");e=new URL(t);return e.search=r.search,e.hash=r.hash,e.toString()}function setTitle(e){e=e.startsWith(location.origin)?e.substr(location.origin.length+1):e.substr(e.indexOf("://")+3),document.title=e}},3700:()=>{}}]);