(globalThis.webpackChunk_croquet_microverse=globalThis.webpackChunk_croquet_microverse||[]).push([[128],{3128:(e,t,s)=>{"use strict";s.d(t,{q:()=>MultiBlaster});t=s(4200),s=s(3654);class MultiBlaster extends s.Z4{get pawn(){return MultiBlasterDisplay}init(e){super.init(e),this.beWellKnownAs("multiBlaster"),this.ships=new Map,this.asteroids=new Set,this.blasts=new Set,this.subscribe(this.sessionId,"view-join",this.viewJoined),this.subscribe(this.sessionId,"view-exit",this.viewExited),this.subscribe(this.sessionId,"switch-pause",this.switchPause),Asteroid.create({}),this.active=!0,this.mainLoop()}switchPause(){console.log("switchPaused!!!!"),this.active=!this.active}viewJoined(e){var t=Ship.create({viewId:e});this.ships.set(e,t)}viewExited(e){var t=this.ships.get(e);this.ships.delete(e),t.destroy()}checkCollisions(){for(const a of this.asteroids)if(!a.wasHit){var e=a.x-a.size,t=a.x+a.size,s=a.y-a.size,i=a.y+a.size;for(const r of this.blasts)if(r.x>e&&r.x<t&&r.y>s&&r.y<i){a.hitBy(r);break}for(const o of this.ships.values())if(!o.wasHit&&o.x+10>e&&o.x-10<t&&o.y+10>s&&o.y-10<i&&(o.score||!(Math.abs(o.x-512)+Math.abs(o.y-512)<40))){o.hitBy(a);break}}}mainLoop(){if(this.active){for(const e of this.ships.values())e.move();for(const t of this.asteroids)t.move();for(const s of this.blasts)s.move();this.checkCollisions()}this.future(50).mainLoop()}}MultiBlaster.register("MultiBlaster");class Ship extends t.Actor{init({viewId:e}){super.init(),this.viewId=e,this.reset(),this.subscribe(e,"left-thruster",this.leftThruster),this.subscribe(e,"right-thruster",this.rightThruster),this.subscribe(e,"forward-thruster",this.forwardThruster),this.subscribe(e,"fire-blaster",this.fireBlaster)}reset(){this.x=512,this.y=512,this.a=-Math.PI/2,this.dx=0,this.dy=0,this.left=!1,this.right=!1,this.forward=!1,this.score=0,this.wasHit=0}leftThruster(e){this.wasHit||(this.left=e)}rightThruster(e){this.wasHit||(this.right=e)}forwardThruster(e){this.wasHit||(this.forward=e)}fireBlaster(){var e,t,s,i;this.wasHit||(e=20*Math.cos(this.a),t=20*Math.sin(this.a),s=this.x+e,i=this.y+t,Blast.create({x:s,y:i,dx:e,dy:t,ship:this}))}move(){this.wasHit?60<++this.wasHit&&this.reset():(this.forward&&(this.dx+=.5*Math.cos(this.a),this.dy+=.5*Math.sin(this.a),10<this.dx&&(this.dx=10),this.dx<-10&&(this.dx=-10),10<this.dy&&(this.dy=10),this.dy<-10)&&(this.dy=-10),this.left&&(this.a-=.2),this.right&&(this.a+=.2),this.a<0&&(this.a+=2*Math.PI),this.a>2*Math.PI&&(this.a-=2*Math.PI)),this.x+=this.dx,this.y+=this.dy,this.x<0&&(this.x+=1024),1024<this.x&&(this.x-=1024),this.y<0&&(this.y+=1024),1024<this.y&&(this.y-=1024)}hitBy(e){this.wasHit=1,e.wasHit=1}}Ship.register("Ship");class Asteroid extends t.Actor{init({size:e,x:t,y:s,a:i,dx:a,dy:r,da:o}){super.init(),e?(this.size=e,this.x=t,this.y=s,this.a=i,this.dx=a,this.dy=r,this.da=o):(this.size=40,this.x=400*Math.random()-200,this.y=400*Math.random()-200,this.a=Math.random()*Math.PI*2,e=4*Math.random()+1,this.dx=Math.cos(this.a)*e,this.dy=Math.sin(this.a)*e,this.da=(.02+.03*Math.random())*(Math.random()<.5?1:-1),this.wasHit=0,this.move()),this.wellKnownModel("multiBlaster").asteroids.add(this)}move(){this.wasHit&&++this.wasHit>this.size&&this.destroy(),this.x+=this.dx,this.y+=this.dy,this.x<0&&(this.x+=1024),1024<this.x&&(this.x-=1024),this.y<0&&(this.y+=1024),1024<this.y&&(this.y-=1024),this.wasHit||(this.a+=this.da,this.a<0&&(this.a+=2*Math.PI),this.a>2*Math.PI&&(this.a-=2*Math.PI))}hitBy(e){e.ship.wasHit||e.ship.score++,20<this.size?(this.size*=.7,this.da*=1.5,this.dx=10*-e.dy/this.size,this.dy=10*e.dx/this.size,Asteroid.create({size:this.size,x:this.x,y:this.y,a:this.a,dx:-this.dx,dy:-this.dy,da:this.da})):this.wasHit=1,e.destroy()}destroy(){var e=this.wellKnownModel("multiBlaster").asteroids;e.delete(this),super.destroy(),e.size<5&&Asteroid.create({})}}Asteroid.register("Asteroid");class Blast extends t.Actor{init({x:e,y:t,dx:s,dy:i,ship:a}){super.init(),this.ship=a,this.x=e,this.y=t,this.dx=s,this.dy=i,this.t=0,this.wellKnownModel("multiBlaster").blasts.add(this)}move(){++this.t<30?(this.x+=this.dx,this.y+=this.dy,this.x<0&&(this.x+=1024),1024<this.x&&(this.x-=1024),this.y<0&&(this.y+=1024),1024<this.y&&(this.y-=1024)):this.destroy()}destroy(){this.wellKnownModel("multiBlaster").blasts.delete(this),super.destroy()}}Blast.register("Blast");class MultiBlasterDisplay extends s.Df{constructor(e){super(e),this.addEventListener("pointerDown","onPointerDown"),this.addEventListener("pointerMove","onPointerMove"),this.addEventListener("pointerUp","onPointerUp"),this.addEventListener("keyDown","onKeyDown"),this.addEventListener("keyUp","onKeyUp"),this.smoothing=new WeakMap,this.context=this.canvas.getContext("2d"),this.future(50).doUpdate()}onPointerDown(e){e.uv&&(this.joystick=this.uv2xy(e.uv),this.knob=this.joystick)}onPointerMove(e){var t;e.uv&&(this.knob=this.uv2xy(e.uv),e=this.knob[0]-this.joystick[0],t=this.knob[1]-this.joystick[1],30<e?this.right||(this.publish(this.viewId,"right-thruster",!0),this.right=!0):this.right&&(this.publish(this.viewId,"right-thruster",!1),this.right=!1),e<-30?this.left||(this.publish(this.viewId,"left-thruster",!0),this.left=!0):this.left&&(this.publish(this.viewId,"left-thruster",!1),this.left=!1),t<-30?this.forward||(this.publish(this.viewId,"forward-thruster",!0),this.forward=!0):this.forward&&(this.publish(this.viewId,"forward-thruster",!1),this.forward=!1))}onPointerUp(e){e.uv&&(this.right||this.left||this.forward||this.publish(this.viewId,"fire-blaster"),this.right&&(this.publish(this.viewId,"right-thruster",this.false),this.right=!1),this.left&&(this.publish(this.viewId,"left-thruster",!1),this.left=!1),this.forward&&(this.publish(this.viewId,"forward-thruster",!1),this.forward=!1),this.joystick=null,this.knob=null)}onPointerCancel(e){this.onPointerUp(e)}onKeyDown(e){if(!e.repeat)switch(e.key){case"a":case"A":case"ArrowLeft":this.publish(this.viewId,"left-thruster",!0);break;case"d":case"D":case"ArrowRight":this.publish(this.viewId,"right-thruster",!0);break;case"w":case"W":case"ArrowUp":this.publish(this.viewId,"forward-thruster",!0);break;case" ":this.publish(this.viewId,"fire-blaster");break;case"p":case"P":this.publish(this.actor.sessionId,"switch-pause")}}onKeyUp(e){if(!e.repeat)switch(e.key){case"a":case"A":case"ArrowLeft":this.publish(this.viewId,"left-thruster",!1);break;case"d":case"D":case"ArrowRight":this.publish(this.viewId,"right-thruster",!1);break;case"w":case"W":case"ArrowUp":this.publish(this.viewId,"forward-thruster",!1)}}setup(){}doUpdate(){if(this.actor.active){this.context.clearRect(0,0,1024,1024),this.context.font="40px sans-serif",this.context.fillStyle="rgba(255, 255, 255, 0.5)",this.context.lineWidth=3,this.context.strokeStyle="white";for(const l of this.actor.ships.values()){var{x:e,y:t,a:s}=this.smoothPosAndAngle(l);this.context.save(),this.context.translate(e,t),l.score&&this.context.fillText(l.score,30,15),this.context.rotate(s),l.wasHit?this.drawShipDebris(l.wasHit):this.drawShip(l.forward,l.viewId===this.viewId),this.context.restore()}for(const h of this.actor.asteroids){var{x:i,y:a,a:r}=this.smoothPosAndAngle(h);this.context.save(),this.context.translate(i,a),this.context.rotate(r),h.wasHit?this.drawAsteroidDebris(h.size,2*h.wasHit):this.drawAsteroid(h.size),this.context.restore()}for(const d of this.actor.blasts){var{x:o,y:n}=this.smoothPos(d);this.context.save(),this.context.translate(o,n),this.drawBlast(),this.context.restore()}this.joystick&&this.drawJoystick(),this.texture.needsUpdate=!0}this.future(50).doUpdate()}smoothPos(e){this.smoothing.has(e)||this.smoothing.set(e,{x:e.x,y:e.y,a:e.a});var t=this.smoothing.get(e),s=e.x-t.x,i=e.y-t.y;return Math.abs(s)<50?t.x+=.3*s:t.x=e.x,Math.abs(i)<50?t.y+=.3*i:t.y=e.y,t}smoothPosAndAngle(e){var t=this.smoothPos(e),s=e.a-t.a;return Math.abs(s)<1?t.a+=.3*s:t.a=e.a,t}drawJoystick(){this.drawCircle(this.joystick,50,!1),this.drawCircle(this.knob,25,!0)}drawCircle(e,t,s){this.context.fillStyle="#ffffff",this.context.beginPath(),this.context.arc(e[0],e[1],t,0,2*Math.PI,!0),s?this.context.fill():this.context.stroke()}drawShip(e,t){this.context.beginPath(),this.context.moveTo(20,0),this.context.lineTo(-20,10),this.context.lineTo(-20,-10),this.context.closePath(),this.context.stroke(),t&&this.context.fill(),e&&(this.context.beginPath(),this.context.moveTo(-20,5),this.context.lineTo(-30,0),this.context.lineTo(-20,-5),this.context.stroke())}drawShipDebris(e){this.context.beginPath(),this.context.moveTo(20+e,0+e),this.context.lineTo(-20+e,10+e),this.context.moveTo(-20-1.4*e,10),this.context.lineTo(-20-1.4*e,-10),this.context.moveTo(-20+e,-10-e),this.context.lineTo(20+e,0-e),this.context.stroke()}drawAsteroid(e){this.context.beginPath(),this.context.moveTo(+e,0),this.context.lineTo(0,+e),this.context.lineTo(-e,0),this.context.lineTo(0,-e),this.context.closePath(),this.context.stroke()}drawAsteroidDebris(e,t){this.context.beginPath(),this.context.moveTo(+e+t,0+t),this.context.lineTo(0+t,+e+t),this.context.moveTo(-e-t,0-t),this.context.lineTo(0-t,-e-t),this.context.moveTo(-e-t,0+t),this.context.lineTo(0-t,+e+t),this.context.moveTo(+e+t,0-t),this.context.lineTo(0+t,-e-t),this.context.stroke()}drawBlast(){this.context.beginPath(),this.context.ellipse(0,0,2,2,0,0,2*Math.PI),this.context.closePath(),this.context.stroke()}}},2691:(e,t,s)=>{"use strict";s.d(t,{CN:()=>o,vJ:()=>r,w9:()=>a});var i=s(4200);const a=e=>class extends e{init(e){super.init(e),this.eventListeners=new Map,this.listen("dispatchEvent",this.dispatchEvent)}dispatchEvent(e){let{eventName:t,evt:i}=e;e=this.eventListeners.get(t);e&&e.forEach(e=>{var{moduleName:e,behaviorName:t,listener:s}=e;e&&t?this.call(e+"$"+t,s,i):this[s](i)})}addEventListener(t,s){var e=s;"function"==typeof s&&(s=s.name);let i,a;var r=s.indexOf("$"),r=(1<=r&&(a=s.slice(0,r),s=s.slice(r+1)),s.indexOf(".")),r=(1<=r&&(i=s.slice(0,r),s=s.slice(r+1)),this._behavior);!a&&r&&(a=r.module.externalName),!i&&r&&(i=r.$behaviorName);let o=this.eventListeners.get(t);o||(o=[],this.eventListeners.set(t,o)),0<=o.findIndex(e=>e.eventName===t&&e.listener===s&&e.moduleName===a&&e.behaviorName===i)&&this.removeEventListener(t,e,!0),o.push({moduleName:a,behaviorName:i,eventName:t,listener:s}),this.say("registerEventListener",{eventName:t,listener:s})}removeEventListener(e,t,s){"function"==typeof t&&(t=t.name);let i=this._behavior.$behaviorName,a=this._behavior.module.externalName;var r,o=this.eventListeners.get(e);!o||(r=o.findIndex(e=>e.behaviorName===i&&e.moduleName===a&&e.listener===t))<0||(o.splice(r,1),0===o.length&&(s||this.eventListeners.delete(e),this.say("unregisterEventListener",{eventName:e,listener:t})))}},r=((0,i.RegisterMixin)(a),e=>class extends e{constructor(e){super(e),this.eventListeners=new Map,this.modelListeners=new Map,this.listen("registerEventListener","registerEventListener"),this.listen("unregisterEventListener","unregisterEventListener"),this.registerAllEventListeners()}destroy(){var e=this.actor.service("PlayerManager").players.get(this.viewId),e=(0,i.GetPawn)(e.id);e&&(e.hoverPawn===this&&(e.hoverPawn=null),e.focusPawn===this)&&(e.focusPawn=null),super.destroy()}addEventListener(t,e,s){var i=e;"string"==typeof e?(s=e,e=e=>this[s](e)):s=s||e.name;let a=this.eventListeners.get(t);a||(a=[],this.eventListeners.set(t,a)),a.find(e=>e.name===s&&e.eventName===t)&&this.removeEventListener(t,i,s),a.push({name:s,eventName:t,listener:e})}removeEventListener(t,e,s){s="string"==typeof e?e:s||e.name;var i,e=this.eventListeners.get(t);!e||(i=e.findIndex(e=>e.name===s&&e.eventName===t))<0||e.splice(i,1)}registerEventListener(e){let t=e["eventName"];e=e=>this.say("dispatchEvent",{eventName:t,evt:e});this.modelListeners.set(t,e),this.addEventListener(t,e,"dispatch_"+t)}unregisterEventListener(e){var e=e["eventName"],t=this.modelListeners.get(e);t&&this.removeEventListener(e,t,"dispatch_"+e)}registerAllEventListeners(){if(this.actor.eventListeners)for(var e of this.actor.eventListeners.keys())this.registerEventListener({eventName:e})}}),o=e=>class extends e{constructor(e){super(e),this.isMyPlayerPawn&&(this.subscribe("input","pointerDown",this.doPointerDown),this.subscribe("input","pointerUp",this.doPointerUp),this.subscribe("input","pointerMove",this.doPointerMove),this.subscribe("input","click",this.doPointerClick),this.subscribe("input","wheel",this.doPointerWheel),this.subscribe("input","doubleDown",this.doPointerDoubleDown),this.subscribe("input","tap",this.doPointerTap),this.subscribe("input","keyDown",this.doKeyDown),this.subscribe("input","keyUp",this.doKeyUp),this.firstResponders=new Map,this.lastResponders=new Map)}modifierEqual(e,t){return!!e.altKey==!!t.altKey&&!!e.ctrlKey==!!t.ctrlKey&&!!e.metaKey==!!t.metaKey&&!!e.shiftKey==!!t.shiftKey}addResponder(e,s,i,a){a._target&&(a=a._target);let r=["altKey","shiftKey","ctrlKey","metaKey"],o=e.get(s);o||(o=[],e.set(s,o)),function has(){for(let e=0;e<o.length;e++){var s=o[e];let t=!0;for(let e=0;e<r.length;e++)t=t&&s.eventMask[r[e]]===i[r[e]];if(s.pawn===a&&t)return 1}}()||(o.forEach(t=>{for(let e=0;e<r.length;e++)if(t.eventMask[r[e]]&&i[r[e]])throw new Error(r[e]+" is already handled for "+s)}),o.unshift({eventMask:i,pawn:a}))}removeResponder(e,t,a,s){s._target&&(s=s._target);e=e.get(t);e&&0<=(t=e.findIndex(t=>{var s=["altKey","shiftKey","ctrlKey","metaKey"];let i=!0;for(let e=0;e<s.length;e++)t.eventMask[s[e]]&&(i=i&&a[s[e]]);return i}))&&e[t].pawn===s&&e.splice(t,1)}findResponder(e,r,t,o){e=e.get(t);return e&&0<=(t=e.findIndex(t=>{var s=["altKey","shiftKey","ctrlKey","metaKey"];let i=!0,a=!1;for(let e=0;e<s.length;e++)r[s[e]]&&(a=!0,i=i&&t.eventMask[s[e]]);return!(!o||0!==Object.keys(t.eventMask).length||a)||!(o&&!a)&&i}))?e[t].pawn:null}addFirstResponder(e,t,s){return this.addResponder(this.firstResponders,e,t,s)}removeFirstResponder(e,t,s){return this.removeResponder(this.firstResponders,e,t,s)}findFirstResponder(e,t){return this.findResponder(this.firstResponders,e,t,!0)}addLastResponder(e,t,s){return this.addResponder(this.lastResponders,e,t,s)}removeLastResponder(e,t,s){return this.removeResponder(this.lastResponders,e,t,s)}findLastResponder(e,t){return this.findResponder(this.lastResponders,e,t,!1)}destroy(){super.destroy()}getTargets(t,e){var s=this.service("ThreeRenderManager");return(e?s.threeLayerUnion("pointer","walk"):s.threeLayer("pointer")).filter(e=>{e=e.wcPawn.eventListeners.get(t);return e&&0!==e.length})}invokeListeners(e,t,s,i){var a=t.eventListeners.get(e);let r;r=s?this.pointerEvent(s,i):i;s=this.actor._cardData.avatarEventHandler;this.has(s+"$AvatarPawn","handlingEvent")&&this.call(s+"$AvatarPawn","handlingEvent",e,t,r),a&&a.forEach(e=>e.listener.call(t,r))}pointerCapture(e){this.focusPawn=e}doPointerDown(e){var t="pointerDown";let s;s=e.source?this.pointerRaycast(e.source,this.getTargets(t)):this.pointerRaycast(e.xy,this.getTargets(t));var i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(0===e.button&&(this.isPointerDown=!0,this.focusPawn!==s.pawn)&&(this.focusPawn=s.pawn),this.focusPawn)this.invokeListeners(t,this.focusPawn,s,e);else{i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doPointerUp(e){var t="pointerUp";let s;s=e.source?this.pointerRaycast(e.source,this.getTargets(t)):this.pointerRaycast(e.xy,this.getTargets(t)),this.isPointerDown=!1;var i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);this.focusPawn&&this.invokeListeners(t,this.focusPawn,s,e);i=this.findLastResponder(e,t);return i?this.invokeListeners(t,i,s,e):void 0}doPointerMove(e){var t="pointerMove";let s;s=e.source?this.pointerRaycast(e.source,this.getTargets(t)):this.pointerRaycast(e.xy,this.getTargets(t));var i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(this.hoverPawn!==s.pawn&&(this.hoverPawn&&this.invokeListeners("pointerLeave",this.hoverPawn,s,e),this.hoverPawn=s.pawn,this.hoverPawn)&&this.invokeListeners("pointerEnter",this.hoverPawn,s,e),this.isPointerDown&&this.focusPawn&&this.focusPawn===s.pawn)this.invokeListeners(t,this.focusPawn,s,e);else{i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doPointerClick(e){var t="click",s=this.pointerRaycast(e.xy,this.getTargets(t)),i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(s.pawn)this.invokeListeners(t,s.pawn,s,e);else{i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doPointerDoubleDown(e){var t="pointerDoubleDown",s=this.pointerRaycast(e.xy,this.getTargets(t,!0),!0),i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);s.pawn&&this.invokeListeners(t,s.pawn,s,e)}doPointerWheel(e){var t="pointerWheel",s=this.pointerRaycast(e.xy,this.getTargets(t,!0),!0),i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(s.pawn)this.invokeListeners(t,s.pawn,s,e);else{i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doPointerTap(e){var t="pointerTap";let s;s=e.source?this.pointerRaycast(e.source,this.getTargets(t)):this.pointerRaycast(e.xy,this.getTargets(t));var i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(s.pawn)this.invokeListeners(t,s.pawn,s,e);else{i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doKeyDown(e){var t="keyDown",s=this.findFirstResponder(e,t);if(s)return this.invokeListeners(t,s,null,e);if(this.focusPawn)this.invokeListeners(t,this.focusPawn,null,e);else{s=this.findLastResponder(e,t);if(s)return this.invokeListeners(t,s,null,e)}}doKeyUp(e){var t="keyUp",s=this.findFirstResponder(e,t);if(s)return this.invokeListeners(t,s,null,e);this.focusPawn&&this.invokeListeners(t,this.focusPawn,null,e);s=this.findLastResponder(e,t);return s?this.invokeListeners(t,s,null,e):void 0}pointerEvent(e,t){var s={avatarId:this.actor.id};return e.pawn&&(s.targetId=e.pawn.actor.id,s.xyz=e.xyz,s.uv=e.uv,s.normal=e.normal,s.distance=e.distance),s.ctrlKey=t.ctrlKey,s.altKey=t.altKey,s.shiftKey=t.shiftKey,s.metaKey=t.metaKey,s.xy=t.xy,s.id=t.id,s.button=t.button,s.buttons=t.buttons,e.ray&&(s.ray={origin:e.ray.origin.toArray(),direction:e.ray.direction.toArray()}),void 0!==t.deltaY&&(s.deltaY=t.deltaY),s}}},5679:(e,t,s)=>{"use strict";s.r(t),s.d(t,{PM_ThreeCamera:()=>k,PM_ThreeVisible:()=>T,THREE:()=>C,THREE_MESH_BVH:()=>i,ThreeRenderManager:()=>ThreeRenderManager});var t=s(9477),i=s(5919),a=s(2108),r=s(4458),o=s(8304),n=s(1154),l=s(3194),h=s(8025),d=s(9778),c=s(7011),u=s(6023),p=s(1217),m=s(452),f=s(6065),v=s(2854),g=s(1367),y=s(1259),w=s(140),_=s(7157),x=s(1711),b=s(5484),M=s(8939),E=s(9018),P=s(2583),S=s(4200);const T=e=>class extends(0,S.PM_Visible)(e){constructor(...e){super(...e),this.listen("viewGlobalChanged",this.refreshDrawTransform)}destroy(){super.destroy();var e=this.service("ThreeRenderManager");e&&e.scene&&(this.renderObject&&e.scene.remove(this.renderObject),this.colliderObject)&&e.scene.remove(this.colliderObject)}refreshDrawTransform(){this.renderObject&&(this.renderObject.matrix.fromArray(this.global),this.renderObject.matrixWorldNeedsUpdate=!0),this.colliderObject&&(this.colliderObject.matrix.fromArray(this.global),this.colliderObject.matrixWorldNeedsUpdate=!0)}setRenderObject(e){var t=this.service("ThreeRenderManager");t&&t.dirtyAllLayers(),(e.wcPawn=this).renderObject=e,this.renderObject.matrixAutoUpdate=!1,this.renderObject.matrix.fromArray(this.global),this.renderObject.matrixWorldNeedsUpdate=!0,t&&t.scene&&t.scene.add(this.renderObject),this.onSetRenderObject&&this.onSetRenderObject(e)}setColliderObject(e){var t=this.service("ThreeRenderManager");t&&t.dirtyAllLayers(),(e.wcPawn=this).colliderObject=e,this.colliderObject.matrixAutoUpdate=!1,this.colliderObject.matrix.fromArray(this.global),this.colliderObject.matrixWorldNeedsUpdate=!0,t&&t.scene&&t.scene.add(this.colliderObject)}},k=e=>class extends(0,S.PM_Camera)(e){constructor(...e){super(...e),this.isMyPlayerPawn&&((e=this.service("ThreeRenderManager")).camera.matrix.fromArray(this.lookGlobal),e.camera.matrixAutoUpdate=!1,e.camera.matrixWorldNeedsUpdate=!0,this.listen("lookGlobalChanged",this.refreshCameraTransform),this.listen("viewGlobalChanged",this.refreshCameraTransform))}refreshCameraTransform(){var e=this.service("ThreeRenderManager");e.camera.matrix.fromArray(this.lookGlobal),e.camera.matrixWorldNeedsUpdate=!0}setRayCast(e){var t=e[0]/window.innerWidth*2-1,e=2*-(e[1]/window.innerHeight)+1,s=this.service("ThreeRenderManager");return this.raycaster||(this.raycaster=new C.Raycaster),this.raycaster.setFromCamera({x:t,y:e},s.camera),this.raycaster.params.Line={threshold:.2},this.raycaster.params.Point={threshold:.2},this.raycaster}setXRRayCast(e){var t=new C.Vector3(0,0,-1);t.applyEuler(e.target.rotation),this.raycaster||(this.raycaster=new C.Raycaster),this.raycaster.set(e.target.position,t)}pointerRaycast(e,t,s){Array.isArray(e)?this.setRayCast(e):this.setXRRayCast(e);var e=this.service("ThreeRenderManager"),i=this.raycaster.intersectObjects(t||e.threeLayer("pointer"));if(0===i.length)return{ray:this.raycaster.ray.clone()};let a,r;if(s)for(let s=0;s<i.length;s++){let e=i[s].object,t=e.wcPawn;for(;!t&&e;)e=e.parent,t=e.wcPawn;if(t){r=t.hitNormal,Array.isArray(r)&&(r=new C.Vector3(...r)),a=i[s];break}}for(let e=0;e<i.length;e++)if(1e3<i[e].object.renderOrder){a=i[e];break}return a=a||i[0],(r=a.face&&!r?a.face.normal:r)&&(t=(new C.Matrix3).getNormalMatrix(a.object.matrixWorld),r=r.clone().applyMatrix3(t).normalize()),{pawn:this.getPawn(a.object),xyz:a.point.toArray(),uv:a.uv?a.uv.toArray():void 0,normal:r?r.toArray():void 0,distance:a.distance,ray:this.raycaster.ray.clone()}}getPawn(e){let t=e;for(;!t.wcPawn;){if(!t.parent)return null;t=t.parent}return t.wcPawn}};class XRController{constructor(i){this.manager=i,this.controllerModelFactory=new P.i,this.raycaster=new C.Raycaster,[0,1].forEach(t=>{var e="controller"+t;this[e]=i.renderer.xr.getController(t);let s=this[e];s.addEventListener("selectstart",e=>function selectStart(e,t){i.avatar&&i.avatar.doPointerDown({button:0,buttons:1,id:1,source:t}),e.userData.pointerDown=!0,e.userData.pointerDownTime=Date.now()}(s,e)),s.addEventListener("selectend",e=>function selectEnd(e,t){i.avatar&&(t={button:0,buttons:1,id:1,source:t},e.userData.pointerDownTime&&Date.now()-e.userData.pointerDownTime<400&&i.avatar.doPointerTap(t),i.avatar.doPointerUp(t)),e.userData.pointerDown=!1,e.userData.pointerDownTime=null}(s,e)),s.userData.pointerDown=!1,s.addEventListener("connected",e=>{s.add(this.buildController(e.data,t))}),s.addEventListener("disconnected",()=>{s.remove(s.children[0]),i.origReferenceSpace=null}),i.scene.add(s);e="controllerGrip"+t,this[e]=i.renderer.xr.getControllerGrip(t),e=this[e];e.add(this.controllerModelFactory.createControllerModel(e)),i.scene.add(e)}),this.lastDelta=[0,0]}buildController(e,t){let s,i;switch(e.gamepad&&(this["gamepad"+t]=e.gamepad),this.manager.origReferenceSpace||(this.manager.origReferenceSpace=this.manager.renderer.xr.getReferenceSpace()),e.targetRayMode){case"tracked-pointer":return(s=new C.BufferGeometry).setAttribute("position",new C.Float32BufferAttribute([0,0,0,0,0,-1],3)),s.setAttribute("color",new C.Float32BufferAttribute([.5,.5,.5,0,0,0],3)),i=new C.LineBasicMaterial({vertexColors:!0,blending:C.AdditiveBlending}),new C.Line(s,i);case"gaze":return s=new C.RingGeometry(.02,.04,32).translate(0,0,-1),i=new C.MeshBasicMaterial({opacity:.5,transparent:!0}),new C.Mesh(s,i)}}update(e){var t=0,s=0,t=(t+=this.gamepad0?.axes[2]||0)+(this.gamepad1?.axes[2]||0),s=(s+=this.gamepad0?.axes[3]||0)+(this.gamepad1?.axes[3]||0);0!==this.lastDelta[0]||0!==this.lastDelta[1]||0===t&&0===s||e.startMotion(),0===t&&0===s||e.updateMotion(80*t,80*s),0===this.lastDelta[0]&&0===this.lastDelta[1]||0!==t||0!==s||e.endMotion(),this.lastDelta=[t,s],this.controller0.userData.pointerDown&&(t={button:0,buttons:1,id:1,source:{target:this.controller0}},e.doPointerMove(t)),this.controller1.userData.pointerDown&&(s={button:0,buttons:1,id:1,source:{target:this.controller1}},e.doPointerMove(s))}}class ThreeRenderManager extends S.RenderManager{constructor(e={},t){super(e,t||"ThreeRenderManager"),this.threeLayers={},this.scene=new C.Scene,this.camera=new C.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,1e4),e.canvas||(this.canvas=document.createElement("canvas"),this.canvas.id="ThreeCanvas",this.canvas.style.cssText="position: absolute; left: 0; top: 0; z-index: 0",document.body.insertBefore(this.canvas,null),e.canvas=this.canvas),this.setupRenderer(e)}setupRenderer(e){this.renderer&&this.renderer.dispose(),this.vrButton&&this.vrButton.remove(),this.canvas&&(e.canvas=this.canvas),this.renderer=new C.WebGLRenderer(e),this.renderer.shadowMap.enabled=!0,this.hasXR().then(e=>{e?(this.vrButton=E.N.createButton(this.renderer),this.observer&&(this.observer.disconnect(),this.observer=null),this.observer=new MutationObserver((t,e)=>{let s=!1;for(let e=0;e<t.length;e++)if("attributes"===t[e].type){s=!0;break}s&&"ENTER VR"===this.vrButton.textContent&&this.vrButton.style.left&&(this.vrButton.style.removeProperty("left"),this.vrButton.style.setProperty("right","20px"))}),this.observer.observe(this.vrButton,{attributes:!0,attributeFilter:["style"]}),document.body.appendChild(this.vrButton),this.renderer.xr.enabled=!0,this.xrController=new XRController(this)):(this.composer=new a.xC(this.renderer),this.renderPass=new r.C(this.scene,this.camera),this.composer.addPass(this.renderPass)),this.resize(),this.subscribe("input","resize",()=>this.resize()),this.setRender(!0)})}installOutlinePass(){this.outlinePass||(this.outlinePass=new M.f(new C.Vector2(window.innerWidth,window.innerHeight),this.scene,this.camera),this.outlinePass.edgeStrength=3,this.outlinePass.edgeGlow=.1,this.outlinePass.edgeThickness=1.5,this.outlinePass.pulsePeriod=2,this.outlinePass.visibleEdgeColor.set("#88ff88"),this.outlinePass.hiddenEdgeColor.set("#ff0000"),this.outlinePass.selectedObjects=[],this.composer.addPass(this.outlinePass))}addToOutline(e){this.outlinePass||this.installOutlinePass(),this.outlinePass.selectedObjects.push(e)}clearOutline(){this.outlinePass.selectedObjects=[]}setRender(e){this.doRender=e}async hasXR(){try{return await navigator.xr.isSessionSupported("immersive-vr")}catch(e){return!1}}destroy(){super.destroy(),this.renderer.dispose(),this.canvas&&this.canvas.remove()}resize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.composer&&this.composer.setSize(window.innerWidth,window.innerHeight)}dirtyLayer(e){this.threeLayers[e]=null}dirtyAllLayers(){this.threeLayers={}}threeLayer(e){return this.layers[e]?(this.threeLayers[e]||(this.threeLayers[e]=Array.from(this.layers[e]).map(e=>e.colliderObject||e.renderObject)),this.threeLayers[e]):[]}threeLayerUnion(...e){let t=[];for(;0<e.length;){var s=this.threeLayer(e.pop());t=t.concat(s.filter(e=>t.indexOf(e)<0))}return t}update(){this.doRender&&(this.composer?this.composer.render():this.renderer.render(this.scene,this.camera)),this.xrController&&this.avatar&&this.xrController.update(this.avatar)}}const C={...t,Pass:o.w,UnrealBloomPass:b.m,CopyShader:n.C,CSMFrustum:l.$,CSMShader:h.G,CSM:d.j,OBJLoader:c.L,MTLLoader:u.v,GLTFLoader:p.E,FBXLoader:m.y,VRMLLoader:f.W,DRACOLoader:v._,SVGLoader:g.u,EXRLoader:y.I,BufferGeometryUtils:w,FontLoader:_.J,Font:_.Z,TextGeometry:x.M}},3782:(e,t,s)=>{"use strict";s.d(t,{Bg:()=>function addMeshProperties(e,t,s,i,a){e.traverse(e=>{e.material&&(i&&(e.material.fog=!1),s&&(e.material.side=a.FrontSide),e.material.format=a.RGBAFormat,t)&&(e.castShadow=!0,e.receiveShadow=!0)})},bp:()=>function normalizeSVG(e,t,s,i){h=i;let a=boundingBox(e),r=function extent3D(e,t){var s=new h.Vector3;t=t||boundingBox(e);t&&(s.copy(t.max),s.sub(t.min));return s}(e,a),o=function center3D(e,t){var s=new h.Vector3;t=t||boundingBox(e);t&&(s.copy(t.max),s.add(t.min),s.multiplyScalar(.5));return s}(e,a),n=(e.scale.y*=-1,o.y*=-1,Math.max(r.x,r.y));{var l;0<n&&(r.y&&(e.aspect=r.x/r.y),e.position.set(-o.x,-o.y,-o.z),e.position.multiplyScalar(i=1/n),l=e.scale,t?e.scale.set(l.x*i,l.y*i,t):e.scale.multiplyScale(i))}e.traverse(e=>{e.material&&(function normalizeUV(t,s,e){let i=[e.max.x-e.min.x,e.max.y-e.min.y],a=(i[0]=0<i[0]?1/i[0]:1,i[1]=0<i[1]?1/i[1]:1,[e.min.x,e.min.y]),r=0,o=0;for(let e=0;e<t.length;e++)o+=r,2+!s[3*o]&&(t[e]=(t[e]-a[r])*i[r],r)&&(t[e]=1-t[e]),r=0===r?1:0}(e.geometry.attributes.uv.array,e.geometry.attributes.normal.array,a),s)&&(e.castShadow=!0,e.receiveShadow=!0)})},iF:()=>function addTexture(e,t){e.traverse(e=>{e.material&&(Array.isArray(e.material)?e.material[0].map=t:e.material.map=t)})},me:()=>AssetManager});let h;function isZip(e){return 80===e[0]&&75===e[1]&&3===e[2]&&4===e[3]}class ImportChecker{constructor(){this.totalSize=0}addItem(e){return!!this.withinLimits&&(this.totalSize+=e.buffer.byteLength,this.withinLimits)}get withinLimits(){return this.totalSize<=104857600}get totalBytes(){return this.totalSize}}class AssetManager{constructor(){this.assetCache={},this.supportedFileTypes=new Set(["zip","glb","obj","fbx","wrl","svg","png","jpeg","jpg","gif","exr","pdf","vrse"])}fetchFile(e){e=e.getAsFile();const t=this.getFileType(e.name);if(e&&t)return this.fetchSpecForDroppedFile(e,t).then(e=>{if(this.supportedFileTypes.has(t))return{type:t,buffer:e.buffer};throw new Error("unsupported file type")});throw new Error("could not read a file")}async handlePasteText(e){for(const t of e)if("string"===t.kind&&"text/plain"===t.type)return new Promise(e=>t.getAsString(e))}async handleFiles(e){var t=new ImportChecker,e=(1<e.length&&console.warn("multiple files or dirs dropped"),e[0]),s=e.getAsEntry?e.getAsEntry():e.webkitGetAsEntry?e.webkitGetAsEntry():null;if(s&&s.isDirectory)try{return this.analyzeDirectory(s,t)}catch(e){throw Error("directory could not be zipped")}t=await this.fetchFile(e);return s&&(t.fileName=s.fullPath),t}async analyzeDirectory(e,o){const n=[{path:e.fullPath,entry:e,depth:0}];let l=new JSZip,h;const s=()=>{const{path:i,entry:a,depth:r}=n.pop();return a.isDirectory?new Promise((s,e)=>{a.createReader().readEntries(e=>{for(const t of e)n.push({path:t.fullPath,entry:t,depth:r+1});s(!0)})}):new Promise((s,t)=>{a.file(async e=>{var t=this.getFileType(e.name),e=await this.fetchSpecForDroppedFile(e,t);if("obj"===e.type&&(h="obj"),e.path=i,e.depth=r,o.addItem(e),!o.withinLimits)throw new Error("directory too large");l.file(i,e.buffer),s(!0)},e=>{t(e)})})};return new Promise(async(e,t)=>{for(;0<n.length;)await s();e(!0)}).then(()=>({zip:l,type:h}))}getFileType(e){var t=e.lastIndexOf(".");return 0<=t?e.slice(t+1).toLowerCase():null}async fetchSpecForDroppedFile(s,t){const i=new FileReader;return new Promise((e,t)=>{i.onload=()=>e(i.result),i.onerror=t,i.readAsArrayBuffer(s)}).then(e=>({name:s.name,type:t,blob:s,buffer:e})).catch(e=>{throw console.error(e),new Error("reading a file failed")})}async drop(e){var t,s,i,a;return[...e.types].includes("Files")?({zip:a,buffer:t,type:s,fileName:i}=await this.handleFiles(e.items),a?a.generateAsync({type:"uint8array"}):{fileName:i,type:s,buffer:t}):(a=await this.handlePasteText(e.items))?{type:"pastedtext",buffer:a}:null}setupHandlersOn(e,i){const t=async e=>{var t,s,e=await this.drop(e);e?({buffer:e,fileName:t,type:s}=e,i&&i(e,t,s)):console.log("not a file")};e.ondragover=e=>e.preventDefault(),e.ondrop=e=>{e.preventDefault(),t(e.dataTransfer)},e.onpaste=e=>{e.preventDefault(),t(e.clipboardData||window.clipboardData)}}setCache(e,t,s){this.assetCache[e]?(this.assetCache[e].ids.delete("0"),this.assetCache[e].ids.add(s)):this.assetCache[e]={data:t,ids:new Set([s])}}getCache(e){e=this.assetCache[e];return e?e.data:null}fillCacheIfAbsent(e,t,s){var i=this.assetCache[e];return i?(this.assetCache[e].ids.add(s),i.data):(i=t(),this.setCache(e,i,s),i)}revoke(e,t){var s=this.assetCache[e];s&&(s.ids.delete(t),0===s.ids.size)&&delete this.assetCache[e]}async load(e,t,s,i){var a={glb:"importGLB",obj:"importOBJ",fbx:"importFBX",wrl:"importVRML",svg:"importSVG",png:"importIMG",jpg:"importIMG",jpeg:"importIMG",gif:"importIMG",exr:"importEXR"};if(isZip(e)){var r=await(new JSZip).loadAsync(e),o=Object.keys(r.files);for(let t in a)if(o.find(e=>e.endsWith("."+t)))return(new Loader)[a[t]](e,i,s)}else for(var n in a)if(t===n)return(new Loader)[a[n]](e,i,s);throw new Error("unknown file type")}}class Loader{localName(e){var t=e.lastIndexOf("/");return 0<=t?e.slice(t+1):e}imgType(e){return e.endsWith(".png")?"png":e.endsWith(".jpeg")||e.endsWith(".jpg")?"jpeg":null}async setupFilesInZip(e,i){let o=await(new JSZip).loadAsync(e),n={},a=Object.keys(o.files);e=Object.keys(i).map(t=>{var e=i[t],s=a.find(e=>e.endsWith("."+t));return o.file(s).async(e).then(e=>({type:t,blob:URL.createObjectURL(new Blob([e]))}))});let t={};await Promise.all(e).then(e=>{e.forEach(e=>{t[e.type]=e.blob})});e=a.map(e=>({name:e,type:this.imgType(e)})).filter(e=>e.type).map(e=>{let{name:t,type:a}=e,r=this.localName(t);return o.file(t).async("uint8array").then(e=>{let s=new Blob([e],{type:"image/"+a}),i=new FileReader;return new Promise((e,t)=>(i.addEventListener("load",()=>{n[r]=i.result,e(i.result)}),i.readAsDataURL(s)))})});return await Promise.all(e),{...t,imgContents:n}}setURLModifierFor(e,s){s&&e.setURLModifier(e=>{var t;return this.imgType(e)?(t=this.localName(e),s[t]||""):e})}async importOBJ(e,t,s){let i;let a=await(isZip(e)?this.setupFilesInZip(e,{obj:"string",mtl:"string"}):(e={obj:URL.createObjectURL(new Blob([e]))},Promise.resolve(e)));e=new s.LoadingManager;if(this.setURLModifierFor(e,a.imgContents),a.mtl){const o=new s.MTLLoader(e);i=await new Promise((e,t)=>{o.load(a.mtl,e,null,t)})}const r=new s.OBJLoader(e);s=await new Promise((e,t)=>{i&&r.setMaterials(i),r.load(a.obj,e,null,t)});return Object.keys(a).forEach(e=>{a[e]&&"imgContents"!==e&&URL.revokeObjectURL(a[e])}),s}async importFBX(e,t,s){let i=await(isZip(e)?this.setupFilesInZip(e,{fbx:"ArrayBuffer"}):(e={fbx:URL.createObjectURL(new Blob([e]))},Promise.resolve(e)));e=new s.LoadingManager;this.setURLModifierFor(e,i.imgContents);const a=new s.FBXLoader(e);e=await new Promise((e,t)=>a.load(i.fbx,e,null,t)).then(e=>{var t;return 0<e.animations.length&&(t=new s.AnimationMixer(e),e._croquetAnimation={lastTime:0,mixer:t,animations:e.animations}),e});return Object.keys(i).forEach(e=>{i[e]&&"imgContents"!==e&&URL.revokeObjectURL(i[e])}),e}async importVRML(e,t,s){let i=await(isZip(e)?this.setupFilesInZip(e,{wrl:"ArrayBuffer"}):(e={wrl:URL.createObjectURL(new Blob([e]))},Promise.resolve(e)));e=new s.LoadingManager;this.setURLModifierFor(e,i.imgContents);const a=new s.VRMLLoader(e);e=await new Promise((e,t)=>a.load(i.wrl,e,null,t)).then(e=>{var t;return 0<e.animations.length&&(t=new s.AnimationMixer(e),e._croquetAnimation={lastTime:0,mixer:t,animations:e.animations}),e});return Object.keys(i).forEach(e=>{i[e]&&"imgContents"!==e&&URL.revokeObjectURL(i[e])}),e}async importGLB(s,e,r){return(async()=>{var e,t;return isZip(s)?(e=await(new JSZip).loadAsync(s),t=Object.keys(e.files).find(e=>e.endsWith(".glb")),e.files[t].async("ArrayBuffer")):Promise.resolve(s.buffer)})().then(i=>{let a=new r.GLTFLoader;return new Promise((t,e)=>{var s=new r.DRACOLoader;return s.setDecoderConfig({type:"wasm"}),s.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),a.setDRACOLoader(s),a.parse(i,null,e=>t(e))}).then(e=>{var t,{scene:e,animations:s}=e;return 0<s.length&&(t=new r.AnimationMixer(e),e._croquetAnimation={lastTime:0,mixer:t,animations:s}),e})})}async importSVG(e,i,f){e={svg:URL.createObjectURL(new Blob([e]))};let a=await Promise.resolve(e);e=await new Promise((h,e)=>{const{fullBright:t,color:d,frameColor:c,depth:u}=i,p=t?f.MeshBasicMaterial:f.MeshStandardMaterial;var s=new f.SVGLoader;let m=0;s.load(a.svg,e=>{var t=e.paths,i=new f.Group;for(let e=0;e<t.length;e++){var a=t[e],r=a.userData.style.fill;if(void 0!==r&&"none"!==r){let s=new p({color:(new f.Color).setStyle(r),opacity:a.userData.style.fillOpacity,side:u?f.FrontSide:f.DoubleSide});d&&(s.color=new f.Color(d)),u&&(s=[s,new f.MeshStandardMaterial({color:c,metalness:1})]);var o=f.SVGLoader.createShapes(a);for(let t=0;t<o.length;t++){var n=o[t];let e;e=u?new f.ExtrudeGeometry(n,{depth:1+m,bevelEnabled:!1}):new f.ShapeGeometry(n);n=new f.Mesh(e,s);n.position.z+=u,m+=.002,i.add(n)}}r=a.userData.style.stroke;if(void 0!==r&&"none"!==r){var s=new p({color:(new f.Color).setStyle(r),opacity:a.userData.style.strokeOpacity,side:f.DoubleSide});for(let e=0,t=a.subPaths.length;e<t;e++){var l=a.subPaths[e],l=f.SVGLoader.pointsToStroke(l.getPoints(),a.userData.style);l&&(l=new f.Mesh(l,s),i.add(l))}}}h(i)})});return Object.keys(a).forEach(e=>{a[e]&&"imgContents"!==e&&URL.revokeObjectURL(a[e])}),e}async importIMG(e,t,s){let i=URL.createObjectURL(new Blob([e])),a=new s.TextureLoader,r=new Promise((t,e)=>{a.load(i,e=>{e.width=e.image.width,e.height=e.image.height,t(e)},null,e)});return r.then(()=>(URL.revokeObjectURL(i),r))}async importEXR(e,t,s){let i=await(isZip(e)?this.setupFilesInZip(e,{exr:"ArrayBuffer"}):(e={exr:URL.createObjectURL(new Blob([e]))},Promise.resolve(e)));e=new Promise((e,t)=>{(new s.EXRLoader).load(i.exr,e,null,t)});return Object.keys(i).forEach(e=>{i[e]&&"imgContents"!==e&&URL.revokeObjectURL(i[e])}),e}}function boundingBox(e,t,s){var i;return t||(t=new h.Box3,s=0),e.geometry&&(e.geometry.boundingBox||e.geometry.computeBoundingBox(),(i=e.geometry.boundingBox.clone()).applyMatrix4(e.matrixWorld),t.union(i)),e.children&&e.children.forEach(e=>boundingBox(e,t,s+1)),t}},8858:(e,t,s)=>{"use strict";s.d(t,{b:()=>AvatarActor});var f=s(4200),v=s(5679),c=s(3917),t=s(2691),i=s(3654),a=s(188),r=s(5072);const o=1.676,l=(0,f.m4_rotationY)(Math.PI);let n;class AvatarActor extends(0,f.mix)(i.Z4).with(f.AM_Player){init(e){var t=e.playerId;delete e.playerId,super.init(e),this._playerId=t,this._layers=e.layers,this.addLayer("avatar"),this.lookPitch=0,this.lookYaw=0,this.lookOffset=(0,f.v3_zero)(),this.fall=!1,this.tug=.05,this.set({tickStep:30}),this.listen("goHome",this.goHome),this.listen("goThere",this.goThere),this.listen("startFalling",this.startFalling),this.listen("avatarLookTo",this.onLookTo),this.listen("comeToMe",this.comeToMe),this.listen("followMeToWorld",this.followMeToWorld),this.listen("continuePresenting",this.continuePresenting),this.listen("continueFollowing",this.continueFollowing),this.listen("stopPresentation",this.stopPresentation),this.listen("inWorldSet",this.inWorldSet),this.listen("nameSet",this.nameSet),this.listen("fileUploaded","fileUploaded"),this.listen("addSticky",this.addSticky),this.listen("textPasted",this.textPasted),this.listen("resetStartPosition",this.resetStartPosition),this.subscribe("playerManager","presentationStarted",this.presentationStarted),this.subscribe("playerManager","presentationStopped",this.presentationStopped),this.subscribe("actorManager","destroyed",this.actorDestroyed),this.listen("leavePresentation",this.leavePresentation),this.listen("setAvatarData","setAvatarData"),this.listen("setWorldState","setWorldState"),this.listen("addOrCycleGizmo","addOrCycleGizmo"),this.listen("removeGizmo","removeGizmo"),this.future(0).tick()}setAndPublish(e){this.set(e),this.publish("playerManager","detailsUpdated")}get pawn(){return AvatarPawnFactory}get lookNormal(){return(0,f.v3_rotate)([0,0,-1],this.rotation)}get collisionRadius(){return this._cardData.collisionRadius||.8}get inWorld(){return!!this._inWorld}ensureNicknameCard(){var e,t,s,i;this.inWorld&&!this._cardData.noNicknameCard&&((e=this._name)?(t=.005,this.nicknameCard||(this.nicknameCard=this.createCard({name:"nickname",behaviorModules:["Billboard"],translation:[0,1,-.1],type:"text",depth:.02,margins:{left:16,top:22.000000000000004},backgroundColor:3145849,frameColor:4194441,fullBright:!0,opacity:.8,runs:[],width:.1,height:.1,textScale:t,readOnly:!0,noDismissButton:!0,noSave:!0,avatarParts:!0,parent:this})),i=this.getTextFieldActorClass().defaultMeasurement(e),s=Math.min(i.width*t+.2,2),i=Math.min(i.height*t+.2,.4),this.nicknameCard.load([{text:e,style:{color:"white"}}]),this.nicknameCard.setExtent({width:s/t,height:i/t})):this.nicknameCard&&(this.nicknameCard.destroy(),this.nicknameCard=null))}removeNicknameCard(){this.nicknameCard&&this.nicknameCard.destroy(),this.nicknameCard=null}leavePresentation(){var e;this.follow&&(e=this.service("PlayerManager")).presentationMode&&this.follow!==this.playerId&&(this.presentationStopped(),this.say("setLookAngles",{lookOffset:[0,0,0]}),e.leavePresentation(this.playerId))}setWorldState(e){this.set(e)}stopPresentation(){this.service("PlayerManager").stopPresentation()}inWorldSet({o:e,v:t}){!e!=!t&&this.service("PlayerManager").playerInWorldChanged(this),t&&this.ensureNicknameCard()}nameSet({o:e,v:t}){e!==t&&this.ensureNicknameCard()}startFalling(){this.fall=!0}resetStartPosition(){this.goTo(this.translation,this.rotation,!1)}onLookTo(e){var[e,t,s]=e;void 0!==e&&(this.lookPitch=e),void 0!==t&&(this.lookYaw=t),void 0!==s&&(this.lookOffset=s),this.rotateTo((0,f.q_euler)(0,this.lookYaw,0)),this.restoreTargetId=void 0}goHome(){let e,t;t=this._anchor?(e=this._anchor.translation,this._anchor.rotation):(e=(0,f.v3_zero)(),(0,f.q_identity)()),this.goTo(e,t,!1),this.lookOffset=(0,f.v3_zero)(),this.lookPitch=0,this.lookYaw=0,this.say("setLookAngles",{pitch:0,yaw:0,lookOffset:this.lookOffset})}goTo(e,t,s){this.leavePresentation(),this.vStart=[...this.translation],this.qStart=[...this.rotation],this.vEnd=e,this.qEnd=t,this.fall=s,this.goToStep(.1)}goThere(t){if(this.leavePresentation(),this.vStart=[...this.translation],this.qStart=[...this.rotation],this.fall||t.targetId!==this.restoreTargetId){this.fall=!1,this.restoreRotation=[...this.rotation],this.restoreTranslation=[...this.translation],this.restoreTargetId=t.targetId;let e=[...t.normal||this.lookNormal];var s=t.xyz,s=(this.vEnd=(0,f.v3_add)(s,(0,f.v3_scale)(e,t.offset||o)),(e[1]=0,f.v3_sqrMag)(e));s<1e-4?this.qEnd=this.rotation:(e=(0,f.v3_normalize)(e),s=Math.atan2(e[0],e[2]),this.qEnd=(0,f.q_euler)(0,s,0)),t.look&&(s=(0,f.q_pitch)(this.qEnd),t=(0,f.q_yaw)(this.qEnd),this.lookPitch=s,this.lookYaw=t,this.say("setLookAngles",{pitch:s,yaw:t}))}else this.vEnd=this.restoreTranslation,this.qEnd=this.restoreRotation,this.restoreRotation=void 0,this.restoreTranslation=void 0,this.restoreTargetId=void 0;this.goToStep(.1)}comeToMe(){this.service("PlayerManager").startPresentation(this.playerId)}followMeToWorld(e){var t=this.service("PlayerManager");if(t.presentationMode===this.playerId){var s={...e};s.following=s.presenting,delete s.presenting;for(const i of t.followers)i!==this.playerId&&t.player(i).followToWorld(s)}}followToWorld(e){this.say("followToWorld",{followerTransferData:e})}presentationStarted(){var{presenter:e,followers:t}=this.service("PlayerManager");e.playerId!==this.playerId&&t.has(this.playerId)&&(this._translation=[...e.translation],this._rotation=[...e.rotation],this.say("forceOnPosition"),this.follow=e.playerId,this.fall=!1,this._anchor=e._anchor)}presentationStopped(){this.follow=null}continuePresenting(e){this.service("PlayerManager").continuePresenting(this,e)}continueFollowing(e){this.service("PlayerManager").continueFollowing(this,e)}goToStep(e,t){var s=(0,f.v3_lerp)(this.vStart,this.vEnd,t=1<=(t=t||e)?1:t),i=(0,f.q_slerp)(this.qStart,this.qEnd,t);this.positionTo({v:s,q:i}),this.say("forceOnPosition"),t<1&&this.future(50).goToStep(e,t+e)}tick(e){var t;this.follow&&((t=this.service("PlayerManager").players.get(this.follow))?(this.positionTo({v:t._translation,q:t._rotation}),this.lookOffset=t.lookOffset,this.lookPitch=t.lookPitch,this.lookYaw=t.lookYaw,this.say("setLookAngles",{pitch:t.lookPitch,yaw:t.lookYaw,lookOffset:t.lookOffset})):this.presentationStopped()),this.doomed||this.future(this._tickStep).tick(this._tickStep)}dropPose(e,t){var s,i=this.lookNormal,a=this.translation,r=this.rotation;return t?(s=(0,f.q_euler)(0,-Math.PI/2,0),s=(0,f.v3_rotate)(i,s),t=(0,f.v3_multiply)(t,s),{translation:(0,f.v3_add)((0,f.v3_add)((0,f.v3_scale)(i,e),a),t),rotation:r}):{translation:(0,f.v3_add)((0,f.v3_scale)(i,e),a),rotation:r}}fileUploaded(e){var{dataId:e,fileName:t,type:s,translation:i,rotation:a,animationClipIndex:r,dataScale:o}=e,n="exr"===s?"lighting":"svg"===s||"img"===s||"pdf"===s?"2d":"3d";let l={name:t,translation:i,rotation:a,type:n,fileName:t,modelType:s,shadow:!0,singleSided:!0};void 0!==r&&(l.animationClipIndex=r),"3d"==n&&o&&(l.dataScale=o),l="img"===s?{...l,textureLocation:e,textureType:"image",scale:[4,4,4],cornerRadius:.02,fullBright:!0}:"pdf"===s?{...l,behaviorModules:["PDFView"],scale:[4,4,4],layers:["pointer"],type:"2d",frameColor:16777215,color:8947848,depth:.05,fullBright:!0,pdfLocation:e}:{...l,dataLocation:e},"exr"!==s?this.createCard(l):(i=[...this.service("ActorManager").actors.values()].find(e=>"lighting"===e._cardData.type))&&i.updateOptions({...i._cardData,dataLocation:e,dataType:"exr"}),this.publish(this.sessionId,"triggerPersist")}textPasted({string:e,translation:t,rotation:s}){e.startsWith("http://")||e.startsWith("https://")?this.createPortal(t,s,e):this.behaviorManager.hasBehavior("StickyNote")&&this.createStickyNote(t,s,e)}addSticky(s){if(this.behaviorManager.hasBehavior("StickyNote")){var i=(0,f.v3_add)(s.xyz,(0,f.v3_scale)(s.normal,.1));let e=[...s.normal],t;1e-4<(e[1]=0,f.v3_sqrMag)(e)?(e=(0,f.v3_normalize)(e),s=Math.atan2(e[0],e[2]),t=(0,f.q_euler)(0,s,0)):(t=this.rotation,i[1]+=2),this.createStickyNote(i,t)}}createStickyNote(e,t,s){var i=[],s=(i.push({text:s=s||""}),{name:"sticky note",className:"TextFieldActor",behaviorModules:["StickyNote"],translation:e,rotation:t,type:"text",depth:.05,margins:{left:20,top:20,right:20,bottom:20},backgroundColor:16048214,frameColor:16439570,runs:i,width:1,height:1,textScale:.002});this.createCard(s),this.publish(this.sessionId,"triggerPersist")}actorDestroyed(e){this.gizmo?.target?.id===e&&this.removeGizmo()}addOrCycleGizmo(e){var{target:e,viewId:t}=e;this.gizmo?this.publish(this.gizmo.id,"cycleModes"):this.behaviorManager.modules.get("Gizmo")&&(this.gizmo=this.createCard({translation:(0,f.m4_getTranslation)(e.global),name:"gizmo",behaviorModules:["Gizmo"],type:"object",noSave:!0}),this.gizmo.target=e,this.gizmo.creatorId=t)}removeGizmo(){this.gizmo?.destroy(),delete this.gizmo,this.say("clearGizmo")}createPortal(e,t,s){t=(0,f.q_multiply)((0,f.q_euler)(0,Math.PI,0),t),this.createCard({name:"portal",className:"PortalActor",translation:e,rotation:t,type:"2d",layers:["pointer"],color:16737996,frameColor:8947848,width:3,height:3,depth:.2,cornerRadius:.05,portalURL:s,sparkle:!1}),this.publish(this.sessionId,"triggerPersist")}setAvatarData(e){console.log("setAvatarData",e),this.setupAvatarBehavior(e),this.updateOptions(e)}setupAvatarBehavior(e){console.log("setupAvatarBehavior"),e.avatarEventHandler||(e.avatarEventHandler="AvatarEventHandler");var t=e.avatarEventHandler,s=this.service("BehaviorModelManager");s&&s.modules.get(t)&&(e.behaviorModules?e.behaviorModules.includes(t)||(e.behaviorModules=[...e.behaviorModules,t]):e.behaviorModules=[t])}destroy(){this.removeGizmo(),super.destroy()}}AvatarActor.register("AvatarActor");class AvatarPawnFactory extends f.View{constructor(e){return super(e),new(this.viewId===e.playerId?AvatarPawn:RemoteAvatarPawn)(e)}}s=e=>class extends e{constructor(e){super(e),this.throttle=125,this.ignore("scaleSet"),this.ignore("rotationSet"),this.ignore("translationSet"),this.ignore("positionSet")}globalChanged(){this._global||!this.renderObject||this.renderObject.matrixWorldNeedsUpdate||(this.refreshDrawTransform(),this.children&&this.children.forEach(e=>e.onGlobalChanged()))}positionTo(e,t,s){if(!this.actor.follow){if(s=s||this.throttle,(0,f.v3_equals)(this.actor.translation,e,0)&&(0,f.q_equals)(this.actor.rotation,t,0))return;this._translation=e,this._rotation=t,this.onLocalChanged(),this.isTranslating=!1,this.isRotating=!1}super.positionTo(e,t,s),this.globalChanged()}scaleTo(e,t){this.actor.follow||(t=t||this.throttle,this._scale=e,this.onLocalChanged(),this.isScaling=!1),super.scaleTo(e,t),this.globalChanged()}rotateTo(e,t){this.actor.follow||(t=t||this.throttle,this._rotation=e,this.onLocalChanged(),this.isRotating=!1),super.rotateTo(e,t),this.globalChanged()}translateTo(e,t){this.actor.follow||(t=t||this.throttle,this._translation=e,this.isTranslating=!1,this.onLocalChanged()),super.translateTo(e,t),this.globalChanged()}};function setModelOpacity(e,t,s){let i=1!==s;e.visible=t,e.traverse(e=>{e.renderOrder=1e4,e.material&&e.material.opacity!==s&&(e.material.opacity=s,e.material.transparent=i,e.material.side=v.THREE.DoubleSide,e.material.needsUpdate=!0)})}class RemoteAvatarPawn extends(0,f.mix)(i.Df).with(f.PM_Player,v.PM_ThreeVisible){constructor(e){super(e),this.lastUpdateTime=0,this.spin=(0,f.q_identity)(),this.velocity=[0,0,0],this.lookPitch=this.actor.lookPitch,this.lookYaw=this.actor.lookYaw,this.lookOffset=[0,0,0],this.tug=.06,this.subscribe(this.id,"3dModelLoaded","modelLoaded")}addChild(e){super.addChild(e),delete this.lastOpacity}setOpacity(s){if(this.shape){var e=this.actor._cardData.avatarEventHandler;let t=1!==(s=this.hasBehavior(e+"$AvatarPawn","mapOpacity")?this.call(e+"$AvatarPawn","mapOpacity",s):s);this.shape.visible=this.actor.inWorld&&0!==s,this.shape.traverse(e=>{e.material&&(e.material.opacity=s,e.material.transparent=t,e.material.side=v.THREE.DoubleSide,e.material.needsUpdate=!0)})}}removeChild(e){super.removeChild(e),delete this.lastOpacity}modelLoaded(){console.log("remote avatar model loaded"),delete this.lastOpacity,delete this.lastInWorld,this.modelLoadTime=Date.now(),setModelOpacity(this.shape.children[0],!0,0)}detach(){delete this.modelLoadTime,super.detach()}}let d=null,h=!0;class AvatarPawn extends(0,f.mix)(i.Df).with(f.PM_Player,s,v.PM_ThreeVisible,v.PM_ThreeCamera,t.CN){constructor(i){super(i),console.log("LocalAvatarPawn"),this.lastUpdateTime=0,this.lastCollideTime=0,this.lastCollideTranslation=this.actor.translation,this.spin=(0,f.q_identity)(),this.velocity=(0,f.v3_zero)(),this.lookPitch=this.actor.lookPitch,this.lookYaw=this.actor.lookYaw,this.lookOffset=(0,f.v3_zero)(),this._rotation=(0,f.q_euler)(0,this.lookYaw,0),this.portalLookExternal=n,this.isMobile=!!("ontouchstart"in window),this.isFalling=!1;const h=this.service("ThreeRenderManager");this.camera=h.camera,this.scene=h.scene,(h.avatar=this).lastHeight=o,this.yawDirection=this.isMobile?-1:1,this.pitchDirection=this.isMobile?1:-1,this.portalcaster=new v.THREE.Raycaster(new v.THREE.Vector3,new v.THREE.Vector3,0,.4),this.fadeNearby(),this.fadeNearbyInterval&&(clearInterval(this.fadeNearbyInterval),this.fadeNearbyInterval=null),this.fadeNearbyInterval=setInterval(()=>this.fadeNearby(),100),document.getElementById("homeBtn").onclick=()=>this.goHome(),(0,a.gA)(document.getElementById("homeBtn")),document.getElementById("editModeBtn").setAttribute("mobile",this.isMobile),document.getElementById("editModeBtn").setAttribute("pressed",!1);var i=document.getElementById("editModeBtn"),i=(i.onpointerdown=e=>this.setEditMode(e),i.onpointerup=e=>this.clearEditMode(e),(0,a.TV)(this,f.App,this.sessionId),(window.myAvatar=this).eyeHeight=o,this.fallDistance=o/12,this.maxFall=-15,this.service("WalkManager").setupDefaultWalkers(),this.actor.behaviorManager.hasBehavior("FileDragAndDropHandler")&&this.service("AssetManager").assetManager.setupHandlersOn(document,(e,t,s)=>{"pastedtext"===s?this.pasteText(e):"vrse"===s?this.loadvrse(e):this.analyzeAndUploadFile(new Uint8Array(e),t,s)}),this.isPrimary=c.isPrimaryFrame,this.portalClip=new v.THREE.Plane(new v.THREE.Vector3(0,0,-1),0),this.setPortalClipping(),this.shellListener=(e,{frameType:t,spec:s,cameraMatrix:i,dx:a,dy:r,acknowledgeReceipt:o})=>{var n=this.actor._cardData.avatarEventHandler;switch(e){case"frame-type":var l="primary"===t;s&&this.setWorldSwitchFreeze(!0),l!==this.isPrimary&&this.frameTypeChanged(l,s),i&&this.portalCameraUpdate(i),(0,c.sendToShell)("avatar-ready",{frameType:t});break;case"release-freeze":this.setWorldSwitchFreeze(!1),this.refreshCameraTransform(),this.updatePortalRender(!0);break;case"sync-render-now":this.frozenForWorldSwitch?console.log((0,c.frameName)(),"ignoring sync-render while frozen"):(this.refreshCameraTransform(),h.composer.render(),o&&(0,c.sendToShell)("primary-rendered"));break;case"portal-camera-update":this.setWorldSwitchFreeze(!1),this.portalCameraUpdate(i);break;case"motion-start":this.hasBehavior(n+"$AvatarPawn","startMotion")?this.call(n+"$AvatarPawn","startMotion",a,r):this.startMotion(a,r);break;case"motion-end":this.hasBehavior(n+"$AvatarPawn","endMotion")?this.call(n+"$AvatarPawn","endMotion",a,r):this.endMotion(a,r);break;case"motion-update":this.hasBehavior(n+"$AvatarPawn","updateMotion")?this.call(n+"$AvatarPawn","updateMotion",a,r):this.updateMotion(a,r)}},(0,c.addShellListener)(this.shellListener),this.isPrimary);if(this.spectator)this.goHome();else{let e,t,s;i&&d?((e=d).inWorld=!0,d=null,t=e.cardData,s=e.name,t.name=s):(e={inWorld:i},(i=this.anchorFromURL(window.location,!this.isPrimary))&&(e.anchor=i,e.translation=i.translation,e.rotation=i.rotation),i=this.makeCardSpecFrom(window.settingsMenuConfiguration,this.actor,s),t={...i}),this.say("setWorldState",{inWorld:e.inWorld,translation:e.translation,rotation:e.rotation,anchor:e.anchor}),this.say("setAvatarData",t),this.say("resetStartPosition")}this.subscribe("playerManager","playerCountChanged",this.showNumbers),this.listen("setLookAngles",this.setLookAngles),this.listenImmediate("followToWorld",this.followToWorld),this.showNumbers(),this.listen("forceOnPosition",this.onPosition),this.listen("goThere",this.stopFalling),this.subscribe(this.id,"3dModelLoaded","modelLoaded"),this.listen("clearGizmo",this.clearGizmo),this.subscribe("playerManager","presentationStarted",this.presentationStarted),this.subscribe("playerManager","presentationStopped",this.presentationStopped),this.wasdVelocity=[0,0,0],this.wasdMap={w:!1,a:!1,d:!1,s:!1},console.log((0,c.frameName)(),"MyPlayerPawn created",this,"primary:",this.isPrimary)}detach(){this.setDormantAvatarSpec(this.specForRevival()),this.fadeNearbyInterval&&(clearInterval(this.fadeNearbyInterval),this.fadeNearbyInterval=null),this.gizmoTargetPawn?.unselectEdit(),delete this.gizmoTargetPawn,delete this.modelLoadTime,super.detach()}startMotion(e,t){this.spin=(0,f.q_identity)(),this.velocity=(0,f.v3_zero)(),this.say("startFalling"),(e||t)&&this.updateMotion(e,t)}endMotion(e,t){this.activeMMotion=!1,this.spin=(0,f.q_identity)(),this.velocity=(0,f.v3_zero)()}updateMotion(e,t){t*=3e-5,t=Math.min(Math.max(t,-.015),.015),e*=this.isMobile?-.001:-4e-4;this.spin=(0,f.q_euler)(0,e,0),this.velocity=[0,0,t],this.maybeLeavePresentation()}get presenting(){return this.actor.service("PlayerManager").presentationMode===this.viewId}get spectator(){return!!this.wellKnownModel("modelRoot").broadcastMode&&!this.actor.broadcaster&&"true"!==new URLSearchParams(window.location.search).get("broadcastMode")}setWorldSwitchFreeze(e){this.frozenForWorldSwitch=e}onPosition(){this._rotation=this.actor.rotation,this._translation=this.actor.translation,this.onLocalChanged()}setLookAngles(e){var{pitch:e,yaw:t,lookOffset:s}=e;void 0!==e&&(this.lookPitch=e),void 0!==t&&(this.lookYaw=t),void 0!==s&&(this.lookOffset=s)}async analyzeAndUploadFile(e,t,s){var i=await f.Data.store(this.sessionId,e,!0),i=f.Data.toId(i),a=this.service("AssetManager").assetManager;let r,o,n;try{"pdf"!==s&&(r=await a.load(e,s,v.THREE,{}))}catch(e){return void console.warn("dropped file could not be processed",e)}r&&r.isObject3D&&(a.setCache(i,e,"0"),r._croquetAnimation&&(o=0),a=new v.THREE.Vector3(0,0,0),(new v.THREE.Box3).setFromObject(r).getSize(a),e=4/Math.max(a.x,a.y,a.z),n=[e,e,e]);a=this.dropPose(6);this.say("fileUploaded",{dataId:i,fileName:t,type:/^(jpe?g|png|gif)$/.test(s)?"img":s,translation:a.translation,rotation:a.rotation,animationClipIndex:o,dataScale:n})}async uploadFile(e,t,s){var e=await f.Data.store(this.sessionId,e),e=f.Data.toId(e),i=this.dropPose(6);this.say("fileUploaded",{dataId:e,fileName:t,type:/^(jpe?g|png|gif)$/.test(s)?"img":s,translation:i.translation,rotation:i.rotation})}async pasteText(e){2e3<e.length&&(console.warn("Paste too long, truncating"),e=e.substr(0,2e3));var t=this.dropPose(6);this.say("textPasted",{string:e,translation:t.translation,rotation:t.rotation})}loadvrse(e){e=new TextDecoder("utf-8").decode(e);let s;try{s=JSON.parse(e)}catch(e){console.log("vrse file is not in JSON format")}if(s){var i=s.data.cards;let t=0;for(let e=0;e<i.length;e++)i[e].card.parent||t++;var a=2<=t;this.loadFromFile(e,a,!a)}}dropPose(e,t){return this.actor.dropPose(e,t)}anchorFromURL(e,t){var s=this.actor.service("ActorManager")["actors"],e=new URL(e)["searchParams"],i=e.get("anchor");if(!i){if(t)for(const l of s.values())if(l.isPortal)return l;for(const h of s.values())if("default"===h._cardData.spawn)return h;return null}for(const d of s.values())if(d.name===i)return d;var a,r,o,n,e=i.split(",").map(e=>parseFloat(e));return 7!==e.length||e.some(e=>isNaN(e))?null:([t,s,e,a,r,o,n]=e,{translation:[t,s,e],rotation:[a,r,o,n]})}showNumbers(){var s=this.actor.service("PlayerManager");let i=document.getElementById("userCountDisplay");if(this.service("AgoraChatManager"))i&&i.remove();else{i||((a=document.createElement("div")).innerHTML='<div id="userCountDisplay"><div id="userCountReadout">0</div></div>',i=a.firstChild,document.body.appendChild(i),this.service("DolbyChatManager")&&600<=window.innerWidth&&(i.style.left="40%"));var a=i.querySelector("#userCountReadout");if(a){let e=s.players.size;var r,o=s.playersInWorld().length,n=1===o?"user":"users";let t=o+` ${1===o?"user is":"users are"} in this world`;o!==e&&(r=e-o,t+=`, ${r} ${1==r?"user has":"users have"} not entered yet`,e=o+"+"+r),s.presentationMode?(o=s.followers.size,a.textContent=`${o}/${e} `+n,t=o+` ${1===o?"user":"users"} in guided tour, `+t):a.textContent=e+" "+n,i.setAttribute("title",t),a.setAttribute("presenting",this.presenting)}}}presentationStarted(){(0,a._s)(this)}presentationStopped(){(0,a._s)(this)}modelLoaded(){console.log("avatar model loaded"),delete this.lastOpacity,delete this.lastInWorld,this.modelLoadTime=Date.now(),setModelOpacity(this.shape.children[0],!0,0)}setEditMode(e){e.target.setAttribute("pressed",!0),e.target.setPointerCapture(e.pointerId),e.stopPropagation(),this.service("InputManager").setModifierKeys({ctrlKey:!0})}clearEditMode(e){e.target.setAttribute("pressed",!1),e.target.releasePointerCapture(e.pointerId),e.stopPropagation(),this.service("InputManager").setModifierKeys({ctrlKey:!1})}maybeLeavePresentation(){this.actor.follow&&this.say("leavePresentation")}lookTo(e,t,s){this.maybeLeavePresentation(),this.setLookAngles({pitch:e,yaw:t,lookOffset:s}),this.say("avatarLookTo",[e,t,s],30);e=(0,f.q_euler)(0,this.lookYaw,0);this._rotation=e,this.onLocalChanged(),this.isRotating=!1}destroy(){(0,c.removeShellListener)(this.shellListener),super.destroy()}get lookGlobal(){return this.lookOffset?!this.isPrimary&&this.portalLookExternal?this.portalLook:this.walkLook():this.global}walkLook(){var e,t=this.actor._cardData.avatarEventHandler;return this.hasBehavior(t+"$AvatarPawn","walkLook")?this.call(t+"$AvatarPawn","walkLook"):(t=(0,f.q_axisAngle)([1,0,0],this.lookPitch),e=(0,f.m4_translation)(this.lookOffset),t=(0,f.m4_rotationQ)(t),t=(0,f.m4_multiply)(t,e),(0,f.m4_multiply)(t,this.global))}get portalLook(){var e=this.anchor||this.actor._anchor||{translation:[0,0,0],rotation:[0,0,0,1]},t=(0,f.m4_translation)(e.translation),s=(0,f.m4_rotationQ)(e.rotation),i=(0,f.m4_multiply)(s,l),i=(0,f.m4_multiply)(i,t),t=(0,f.m4_multiply)(this.portalLookExternal,i),i=(this.portalClip.normal.set(0,0,-1),this.portalClip.constant=0,new v.THREE.Matrix4),s=(i.set(...s),i.invert(),this.portalClip.applyMatrix4(i),new v.THREE.Vector3(...e.translation));return this.portalClip.constant=-this.portalClip.distanceToPoint(s),t}specForRevival(){return{translation:this._translation,rotation:this._rotation,lookPitch:this.lookPitch,lookYaw:this.lookYaw,lookOffset:this.lookOffset,cardData:this.actor._cardData,name:this.actor._name,inChat:!1,behaviorModules:this.actor._behaviorModules}}setDormantAvatarSpec(e){h&&(d=e)}useDormantAvatarSpec(e){h=e}specForPortal(e,t,s){var t=(0,f.m4_translation)(t),t=(0,f.m4_multiply)(this.global,t),i=(0,f.m4_invert)(e.global),t=(0,f.m4_multiply)(t,i),i={translation:(0,f.m4_getTranslation)(t),rotation:(0,f.m4_getRotation)(t),lookPitch:this.lookPitch,lookYaw:this.lookYaw,lookOffset:this.lookOffset,cardData:this.actor._cardData,name:this.actor._name,url:e.resolvePortalURL(),crossingBackwards:s};return this.presenting&&(i.presenting=f.Data.hash(this.viewId)),i}frameTypeChanged(e,s){var t=this.isPrimary=e,e=!e,i={inWorld:t};if(s?.cardData&&(i.cardData=s.cardData),s?.name&&(i.name=s.name),t&&s?.translation){let{translation:e,rotation:t}=s;var a,r,o,n=this.anchorFromURL(s.url,!0);n&&(o=(0,f.m4_translation)(e),a=(0,f.m4_rotationQ)(t),a=(0,f.m4_multiply)(a,o),o=(0,f.m4_translation)(n.translation),r=(0,f.m4_rotationQ)(n.rotation),r=(0,f.m4_multiply)(r,l),r=(0,f.m4_multiply)(r,o),o=(0,f.m4_multiply)(a,r),e=(0,f.m4_getTranslation)(o),t=(0,f.m4_getRotation)(o),this.anchor=i.anchor=n),i.translation=e,i.rotation=t,this._translation=e,this._rotation=t,this.onLocalChanged(),s.lookPitch&&(this.lookPitch=s.lookPitch),s.lookYaw&&(this.lookYaw=s.lookYaw),s.lookOffset&&(this.lookOffset=s.lookOffset)}e&&(a=this.actor._cardData.avatarEventHandler,this.call(a+"$AvatarPawn","endMotion")),console.log((0,c.frameName)()+" setting actor",i),this.say("_set",i),t&&(delete this.modelLoadTime,this.say("setAvatarData",i.cardData||{}),s?.presenting?this.actor.service("PlayerManager").presentationMode||this.say("continuePresenting",s.presenting):s?.following&&this.say("continueFollowing",s.following)),this.setPortalClipping()}followToWorld({followerTransferData:e}){var{url:t,following:s}=e;this.isPrimary?(console.log((0,c.frameName)()+` sending world-enter to ${t} following: `+s),this.setWorldSwitchFreeze(!0),e.cardData=this.actor._cardData,e.name=this.actor._name,(0,c.sendToShell)("world-enter",{portalURL:t,transferData:e})):console.log((0,c.frameName)()+" not sending world-enter to "+t)}update(t,s){var e;this.frozenForWorldSwitch||(this.actor.follow||this.actor.remoteControlled?(this.tug=.06,super.update(t,s)):(this.tug=.2,e=this.actor.service("PlayerManager"),this.throttle=e.presentationMode===this.actor.playerId?60:125,(this.actor.inWorld||this.spectator)&&(e=this.updatePose(s),e=this.service("WalkManager").walk(this,e,t,s),this.positionTo(e.v,e.q,this.throttle),this.refreshCameraTransform(),this.updateRequests)&&this.updateRequests.forEach(e=>{this.call(...e,t,s)})),this.updateXRReference(),this.updatePortalRender())}updateXRReference(){var e,t,s,i=this.service("ThreeRenderManager");i.origReferenceSpace&&(e=i.renderer.xr,s=(0,f.m4_invert)(this.global),t=(0,f.m4_getTranslation)(s),s=(0,f.m4_getRotation)(s),t=new XRRigidTransform({x:t[0],y:t[1],z:t[2]},{x:s[0],y:s[1],z:s[2],w:s[3]}),s=i.origReferenceSpace.getOffsetReferenceSpace(t),e.setReferenceSpace(s))}updatePose(e){let t,s,i=this.tug;return e&&(i=Math.min(1,i*e/15)),t=(0,f.q_isZero)(this.spin)?this.rotation:(0,f.q_normalize)((0,f.q_slerp)(this.rotation,(0,f.q_multiply)(this.rotation,this.spin),i)),{v:s=(0,f.v3_isZero)(this.velocity)?this.translation:(e=(0,f.v3_scale)(this.velocity,e),e=(0,f.v3_transform)(e,(0,f.m4_rotationQ)(this.rotation)),(0,f.v3_add)(this.translation,e)),q:t}}setPortalClipping(){var e,t=this.service("ThreeRenderManager").renderer["clippingPlanes"];this.isPrimary?0<=(e=t.indexOf(this.portalClip))&&t.splice(e,1):t.includes(this.portalClip)||t.push(this.portalClip)}updatePortalRender(e=!1){if(this.isPrimary){const i=[];let t=!1;this.publish("avatar","gatherPortalSpecs",{callback:e=>{i.push(e),t|=!!e.cameraMatrix},force:e});var s=this.service("ThreeRenderManager");i.length?(0,c.sendToShell)("portal-update",{portalSpecs:i}):s.setRender(!0),e&&!t&&(console.log((0,c.frameName)(),"no portals in sight; rendering immediately"),s.composer.render(),(0,c.sendToShell)("primary-rendered"))}else this.actor._anchor&&this.refreshCameraTransform()}portalCameraUpdate(e){this.lastCameraMatrix=e;const t=this.service("ThreeRenderManager");t.setRender(!1),e&&(this.endMovementTimeout&&clearTimeout(this.endMovementTimeout),this.endMovementTimeout=setTimeout(()=>{var e=!!this.lastCameraMatrix&&!this.frozenForWorldSwitch;t.setRender(e)},50),this.portalLookExternal=e,n=e,this.isPrimary||this.frozenForWorldSwitch||(this.refreshCameraTransform(),t.composer.render(),(0,c.sendToShell)("portal-world-rendered")))}checkFloor(t){var s=this.service("ThreeRenderManager").threeLayer("walk").filter(e=>e.collider);let i=!1;for(let e=0;e<s.length;e++){var a=s[e],r=new v.THREE.Matrix4,o=(r.copy(a.matrixWorld).invert(),new v.THREE.Vector3(0,-1,0)),o=new v.THREE.Ray(new v.THREE.Vector3(...t.v),o),r=(o.applyMatrix4(r),a.children[0].geometry.boundsTree.raycastFirst(o));i=i||r}return i}collideBVH(s,e){let n=new v.THREE.Vector3,l=new v.THREE.Vector3;const h=this.actor.collisionRadius;let i=!1;var d=(0,f.v3_sub)(e.v,this.translation);let c=e.v,u=!1;for(let e=0;e<s.length;e++){var p=s[e],m=p.children[0].matrixWorld.clone();m.invert();let a=new v.THREE.Line3(new v.THREE.Vector3(c[0],c[1],c[2]),new v.THREE.Vector3(c[0],c[1]-.838,c[2])),t=new v.THREE.Box3,r=(t.makeEmpty(),t.expandByPoint(a.start),t.expandByPoint(a.end),t.min.addScaledVector(new v.THREE.Vector3(-1,-1,-1),h),t.max.addScaledVector(new v.THREE.Vector3(1,1,1),h),a.applyMatrix4(m),t.applyMatrix4(m),[]),o;p.children[0].geometry.boundsTree.shapecast({intersectsBounds:e=>e.intersectsBox(t),intersectsTriangle:e=>{var t,s,i=e.closestPointToSegment(a,l,n);i<h&&(i=h-i,s=n.sub(l).normalize(),t=Math.sqrt(s.x**2+s.z**2),s=s.y,t<.1&&.9<s&&(!o||i>o.depth)?(o=e.clone(),r.unshift(o)):r.push(e.clone()))}}),r.forEach(e=>{var t,e=e.closestPointToSegment(a,l,n);e<h&&(e=h-e,t=n.sub(l).normalize(),a.start.addScaledVector(t,e),a.end.addScaledVector(t,e),i=!0)});m=a.start.clone();m.applyMatrix4(p.children[0].matrixWorld),c=m.toArray(),u=u||i&&d[1]<-.1&&Math.abs(d[0])<.001&&Math.abs(d[2])<.001}return u?(this.isFalling=!1,{v:this.translation,q:e.q}):i?(this.isFalling=!0,{v:c,q:e.q}):(this.isFalling=!0,e)}pawnFrom3D(e){for(;e;){if(e.wcPawn)return e.wcPawn;e=e.parent}}collidePortal(t){if(!this.frozenForWorldSwitch){var s=this.service("ThreeRenderManager"),i=s.threeLayer("portal");if(i){var a=(0,f.v3_sub)(t.v,this.translation),r=(0,f.v3_magnitude)(a);if(0!==r){a=(0,f.v3_normalize)(a),this.portalcaster.far=5,this.portalcaster.ray.direction.set(...a),this.portalcaster.ray.origin.set(...this.translation);i=this.portalcaster.intersectObjects(i,!0)[0];if(i){var o=this.pawnFrom3D(i.object);if(!o)return!1;var n=o.globalPlane;if(!(0<n.normal.dot(new v.THREE.Vector3(...a))))return!1;let e=i.distance<=r;if(e||(r=n.distanceToPoint(new v.THREE.Vector3(...t.v)),e=-.4<=r),!e)return!1;t=s["camera"],r=t.getWorldDirection(new v.THREE.Vector3),t=n.normal.dot(r)<0,r=(this.anchor=o.actor,console.log((0,c.frameName)(),"player",this.viewId,"enter portal",o.portalId),s.setRender(!1),this.setWorldSwitchFreeze(!0),(0,f.v3_scale)(a,i.distance)),r=(0,f.v3_add)(r,(0,f.v3_scale)(n.normal.toArray(),.4)),s=this.specForPortal(o,r,t);if((0,c.sendToShell)("portal-enter",{portalId:o.portalId,transferData:s}),this.presenting){const{cardData:l,name:h,...d}=s;this.say("followMeToWorld",d)}return!0}}}}return!1}keyDown(e){var t=this.wasdVelocity;let s;var i=.0075;if(e.ctrlKey||e.altKey)switch(e.key){case"a":console.log("My avatar pawn",this),console.log("translation: ",this.actor.translation),console.log("rotation (euler):",(0,f.q_pitch)(this.actor.rotation),(0,f.q_yaw)(this.actor.rotation),(0,f.q_roll)(this.actor.rotation)),console.log("scale:",this.actor.scale);break;case"r":var a=this.service("ThreeRenderManager").renderer;console.log("Renderer",a),console.log("Scene polycount:",a.info.render.triangles),console.log("Active Drawcalls:",a.info.render.calls),console.log("Textures in Memory",a.info.memory.textures),console.log("Geometries in Memory",a.info.memory.geometries)}else switch(e.key){case"Tab":this.jumpToNote(e);break;case"w":case"W":case"a":case"A":case"d":case"D":case"s":case"S":switch(this.wasdMap[e.key.toLowerCase()]=!0,e.key){case"w":case"W":s=t[2]===i?0:-i,this.wasdVelocity=[t[0],t[1],s];break;case"a":case"A":s=t[0]===i?0:-i,this.wasdVelocity=[s,t[1],t[2]];break;case"d":case"D":s=t[0]===-i?0:i,this.wasdVelocity=[s,t[1],t[2]];break;case"s":case"S":s=t[2]===-i?0:i,this.wasdVelocity=[t[0],t[1],s]}this.velocity=this.wasdVelocity,this.maybeLeavePresentation()}}keyUp(s){switch(s.key){case"w":case"W":case"a":case"A":case"d":case"D":case"s":case"S":this.wasdMap[s.key.toLowerCase()]=!1;let e;e=this.wasdMap.a&&!this.wasdMap.d?-.01:!this.wasdMap.a&&this.wasdMap.d?.01:0;let t;t=this.wasdMap.w&&!this.wasdMap.s?-.01:!this.wasdMap.w&&this.wasdMap.s?.01:0,this.wasdVelocity=[e,0,t],this.velocity=this.wasdVelocity}}addSticky(e){var t;e.shiftKey&&(t=this.service("ThreeRenderManager"),t=this.pointerRaycast(e.xy,t.threeLayerUnion("pointer","walk")),t=this.pointerEvent(t,e),this.say("addSticky",t))}stopFalling(){this.isFalling=!1}xy2yp(e){var t=this.service("ThreeRenderManager").camera.fov/2,s=window.innerHeight/2,i=window.innerWidth/2,t=t*Math.PI/180/s;return[t*(e[0]-i),t*(s-e[1])]}clearGizmo(){this.gizmoTargetPawn=null}pointerDown(e){var t,s=this.service("ThreeRenderManager"),s=this.pointerRaycast(e.xy,s.threeLayerUnion("pointer")),s=(this.targetDistance=s.distance,this.pointerEvent(s,e)),s=(0,f.GetPawn)(s.targetId),i=s&&s.actor.isGizmoManipulator;this.gizmoTargetPawn&&!i&&s!==this.gizmoTargetPawn&&(this.gizmoTargetPawn.unselectEdit(),this.gizmoTargetPawn=null,this.publish(this.actor.id,"removeGizmo")),e.ctrlKey||e.altKey?(t=this.actor.behaviorManager.modules.get("Gizmo"),s&&t?(i?console.log("Tried to gizmo gizmo"):(this.gizmoTargetPawn!=s&&s.selectEdit(),this.gizmoTargetPawn=s),this.publish(this.actor.id,"addOrCycleGizmo",{target:this.gizmoTargetPawn.actor,viewId:this.viewId})):this.publish(this.actor.id,"removeGizmo")):(this.gizmoTargetPawn?(this.gizmoTargetPawn.unselectEdit(),this.gizmoTargetPawn=null,this.publish(this.actor.id,"removeGizmo")):(this.dragWorld=this.xy2yp(e.xy),this.lookYaw=(0,f.q_yaw)(this._rotation)),t=this.actor._cardData.avatarEventHandler,this.hasBehavior(t+"$AvatarPawn","handlingEvent")&&this.call(t+"$AvatarPawn","handlingEvent","pointerDown",this,e),i||this.publish(this.actor.id,"removeGizmo"))}pointerMove(e){!this.focusPawn&&this.isPointerDown&&e.xy&&this.dragWorld&&(i=this.xy2yp(e.xy),t=this.lookYaw+(this.dragWorld[0]-i[0])*this.yawDirection,s=1<(s=this.lookPitch+(this.dragWorld[1]-i[1])*this.pitchDirection)?1:s<-1?-1:s,this.dragWorld=i,this.lookTo(s,t));var t,s,i=this.actor._cardData.avatarEventHandler;this.hasBehavior(i+"$AvatarPawn","handlingEvent")&&this.call(i+"$AvatarPawn","handlingEvent","pointerMove",this,e)}pointerUp(e){if(this.firstResponders)for(var[t,s]of this.firstResponders)for(let e=s.length-1;0<=e;e--)s[e].pawn!==this&&s.splice(e,1);var i=this.actor._cardData.avatarEventHandler;this.hasBehavior(i+"$AvatarPawn","handlingEvent")&&this.call(i+"$AvatarPawn","handlingEvent","pointerUp",this,e)}pointerTap(e){}pointerWheel(e){var t=this.lookOffset[2],e=(t+=Math.max(1,t)*e.deltaY/1e3,t=Math.min(100,Math.max(t,0)),this.lookOffset=[this.lookOffset[0],t,t],(11*this.lookPitch+Math.max(-t/2,-Math.PI/4))/12);this.lookTo(e,(0,f.q_yaw)(this._rotation),this.lookOffset)}fadeNearby(){var e,t,s=this.actor.service("PlayerManager"),i=s.presentationMode,a=(e,t)=>{var s=e.actor.inWorld;if(e.modelLoadTime&&(e.lastOpacity!==t||e.lastInWorld!==s)){e.lastOpacity=t,e.lastInWorld=s;var i=t,a=e.actor._cardData.avatarEventHandler,a=(e.hasBehavior(a+"$AvatarPawn","mapOpacity")&&(t=e.call(a+"$AvatarPawn","mapOpacity",this,t)),e.shape.children[0]);if(a){var r=s&&0!==t;if(setModelOpacity(a,r,t),e._children)for(var o of e._children)o.actor._cardData.avatarParts&&(o.shape.visible=r);s=this.shape.getObjectByName("ghostfoot");s&&(s.visible=e.actor.inWorld&&0!==i)}}};for([e,t]of s.players){var r,o,n=(0,f.GetPawn)(t.id);n&&(this.actor.inWorld?t.follow||(n===this&&(0,f.v3_isZero)(t.lookOffset)||t._playerId===i&&this.actor.follow)&&(0,f.v3_isZero)(t.lookOffset)?a(n,0):(o=this.lookGlobal,r=new v.THREE.Vector3(o[12],o[13],o[14]),o=t.global,o=new v.THREE.Vector3(o[12],o[13],o[14]),a(n,Math.min(Math.max((r.distanceToSquared(o)-.7)/10,0),1))):a(n,1))}}addChild(e){super.addChild(e),delete this.lastOpacity}removeChild(e){super.removeChild(e),delete this.lastOpacity}makeCardSpecFrom(e,t,s){let i={...t._cardData},a=this.actor._cardData.avatarEventHandler;var t=t._behaviorModules||[],r=e.avatarType,o=i.dataLocation;if(["dataLocation","dataTranslation","dataScale","dataRotation","handedness","modelType","type","name","shadow","avatarType"].forEach(e=>{delete i[e]}),"wonderland"===r||!e.type)return"initial"===(r={name:s||e.nickname||this.actor._name,dataScale:[.3,.3,.3],dataRotation:(0,f.q_euler)(0,Math.PI,0),dataTranslation:[0,-.4,0],dataLocation:o||`./assets/avatars/${this.actor._name}.zip`,modelType:"glb",type:"3d",behaviorModules:t,...i}).type&&(r.type="3d"),r;let n={type:"3d",modelType:"glb",dataLocation:e.avatarURL,name:e.nickname,dataRotation:[0,Math.PI,0],handedness:e.handedness,shadow:!0,behaviorModules:t,...i};return"initial"===n.type&&(n.type="3d"),"ReadyPlayerMe"===e.type?0<=(n={...n,avatarEventHandler:"HalfBodyAvatarEventHandler",dataScale:[1.5,1.5,1.5],dataTranslation:[0,-.7,0],behaviorModules:[...n.behaviorModules,"HalfBodyAvatarEventHandler"]}).behaviorModules.indexOf(a)&&(n.behaviorModules=n.behaviorModules.filter(e=>e!==a)):n={...n,dataScale:[.3,.3,.3],dataTranslation:[0,-.4,0]},n}showSettingsMenu(){new Promise((e,t)=>{var s=f.Constants.ShowCaseSpec;(0,r.$)(!1,s&&!s.useAvatar,e)}).then(e=>{e&&(e=window.settingsMenuConfiguration,(0,c.sendToShell)("update-configuration",{localConfig:e}),e=this.makeCardSpecFrom(window.settingsMenuConfiguration,this.actor),delete this.modelLoadTime,this.say("setAvatarData",e),this.modelHasLoaded=!1)})}showShareMenu(){(0,r.Y)(this)}goHome(){if(this.spectator){let e=this.anchorFromURL(window.location.href);var t=[...(e=e||{translation:(0,f.v3_zero)(),rotation:(0,f.q_identity)()}).translation];(this.lastCollideTranslation=t)[0]+=1e-5,this.positionTo(t,e.rotation)}else this.say("goHome")}comeToMe(){var e=this.actor.service("PlayerManager");e.presentationMode?e.presentationMode===this.viewId&&this.say("stopPresentation"):this.say("comeToMe")}jumpToNote(e){var t=this.actor.queryCards({methodName:"filterNotes"},this);let s;void 0===this.lastCardId?s=0:(s=t.findIndex(e=>e.id===this.lastCardId),e.shiftKey?s--:s++);var i,e=t[s=(s=s>=t.length?0:s)<0?t.length-1:s];e&&(this.lastCardId=e.id,t=(0,f.GetPawn)(e.id))&&(i=t.getJumpToPose?t.getJumpToPose():null)&&(i={xyz:i[0],offset:i[1],look:!0,targetId:e.id,normal:t.hitNormal||[0,0,1]},this.say("goThere",i))}filterNotes(e){return e._behaviorModules&&e._behaviorModules.includes("StickyNote")}loadFromFile(e,t,s){var i=this.actor.wellKnownModel("ModelRoot"),a=(new TextEncoder).encode(e);let r=0;var o=Math.random();for(this.publish(i.id,"loadStart",o);r<a.length;){var n=a.slice(r,r+2880);this.publish(i.id,"loadOne",{key:o,buf:n}),r+=2880}e=s?this.dropPose(6):null;this.publish(i.id,"loadDone",{asScene:t,key:o,pose:e})}}},3654:(e,t,s)=>{"use strict";s.d(t,{Z4:()=>CardActor,Df:()=>CardPawn,q7:()=>MicroverseAppManager,Wh:()=>o});var c=s(4200),_=s(5679),t=s(2691),x=s(3782),u=s(4355);class DynamicTexture{constructor(e,t,s,i){(2048<e||2048<t)&&console.warn("large texture: "+e+"x"+t);var a=e=>2**Math.round(Math.log(e)/Math.LN2),r=a(e),a=a(t);r===e&&a===t||console.log("TDynamicTexture: "+e+"x"+t+" becomes "+r+"x"+a),this.canvas=document.createElement("canvas"),this.canvas.width=this.width=r,this.canvas.height=this.height=a,this.context=this.canvas.getContext("2d"),this.texture=new _.THREE.CanvasTexture(this.canvas),this.extractMipmapLevel=3,this.fontName="Arial",this.fontHeight=32,this.fillStyle=s||"black",this.clearStyle=i,this.setFont("normal 32px Arial"),this.align="left",this.scale=1}asMaterial(){return new _.THREE.MeshStandardMaterial({color:16777215,roughness:1,emissive:3355443,map:this.texture,transparent:!1})}getTexture(){return this.texture}getMiniTexture(){if(!this.miniTexture){var t=this.texture,s=this.extractMipmapLevel,i=2**s,a=this.width/i,i=this.height/i,r=this.service("ThreeRenderManager").renderer.getContext(),o=r.createTexture(),n=r.RGBA,l=r.RGBA,h=r.UNSIGNED_BYTE,d=(r.bindTexture(r.TEXTURE_2D,o),_.THREE.WebGLUtils(r)),d=(r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t.flipY),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),r.pixelStorei(r.UNPACK_ALIGNMENT,t.unpackAlignment),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,d.convert(t.wrapS)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,d.convert(t.wrapT)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,d.convert(t.magFilter)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,d.convert(t.minFilter)),r.texImage2D(r.TEXTURE_2D,0,n,l,h,this.canvas),r.generateMipmap(r.TEXTURE_2D),r.createFramebuffer());r.bindFramebuffer(r.FRAMEBUFFER,d),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,o,s);let e;t=r.checkFramebufferStatus(r.FRAMEBUFFER),n=t===r.FRAMEBUFFER_COMPLETE;if(n?(e=new Uint8Array(a*i*4),r.readPixels(0,0,a,i,r.RGBA,r.UNSIGNED_BYTE,e)):console.log("frame buffer not ready; status="+t),r.deleteFramebuffer(d),r.deleteTexture(o),!n)return null;l=document.createElement("canvas"),h=l.getContext("2d"),s=(l.width=a,l.height=i,h.createImageData(a,i));s.data.set(e),h.putImageData(s,0,0),this.miniTexture=new _.THREE.CanvasTexture(l),this.miniTexture.flipY=!1}return this.miniTexture}discardMiniTexture(){delete this.miniTexture}setFont(e){this.context.font=this.font=this.lastContextFont=e}setContextFont(e){e!==this.lastContextFont&&(this.context.font=this.lastContextFont=e)}setFillStyle(e){this.fillStyle=e}setAlign(e){this.align=e}doWithClip(e,t,s,i,a){var r=this.context;r.save(),r.beginPath(),r.rect(e,t,s,i),r.clip(),a(),r.restore(),this.lastContextFont=this.font}fill(e){this.context.save(),this.context.scale(1/this.scale,1/this.scale),this.fillRect(0,0,this.canvas.width,this.canvas.height,e),this.context.restore()}clear(){this.context.save(),this.context.scale(1/this.scale,1/this.scale),this.clearRect(0,0,this.canvas.width,this.canvas.height),this.texture.needsUpdate=!0,this.context.restore()}fillRect(e,t,s,i,a){this.context.fillStyle=a||this.fillStyle,this.context.fillRect(e,t,s,i),this.texture.needsUpdate=!0}clearRect(e,t,s,i){void 0!==this.clearStyle?(this.context.fillStyle=this.clearStyle,this.context.fillRect(e,t,s,i)):this.context.clearRect(e,t,s,i),this.texture.needsUpdate=!0}drawImage(...e){this.context.drawImage(...e),this.texture.needsUpdate=!0}drawText(e,t,s,i,a,r){if(!function isNumber(e){return!isNaN(parseFloat(e))&&isFinite(e)}(t))return this.drawTextCentered(e,s,i,a,r);this.setContextFont(a||this.font);a=this.context;a.textAlign=this.align,r||(a.fillStyle="black",a.fillText(e,t+1,s+1)),a.fillStyle=i||this.fillStyle,a.fillText(e,t,s),this.texture.needsUpdate=!0}drawTextCentered(e,t,s,i,a){this.setContextFont(i||this.font);var i=this.context.measureText(e).width,r=this.fontHeight,i=(this.canvas.width-i)/2;"number"!=typeof t&&(t=(this.canvas.height+r)/2-2),a||(this.context.fillStyle="black",this.context.fillText(e,1+i,t+1)),this.context.fillStyle=s||this.fillStyle,this.context.fillText(e,i,t),this.texture.needsUpdate=!0}drawTextRight(e,t,s,i,a){this.setContextFont(i||this.font);var i=this.context.measureText(e).width+2,r=this.fontHeight,i=this.canvas.width-i;"number"!=typeof t&&(t=(this.canvas.height+r)/2-2),a||(this.context.fillStyle="black",this.context.fillText(e,1+i,t+1)),this.context.fillStyle=s||this.fillStyle,this.context.fillText(e,i,t),this.texture.needsUpdate=!0}drawTextLeft(e,t,s,i){this.setContextFont(i||this.font);i=this.fontHeight,t=t||(this.canvas.height+i)/2-2;this.context.fillStyle="black",this.context.fillText(e,3,t+1),this.context.fillStyle=s||this.fillStyle,this.context.fillText(e,2,t),this.texture.needsUpdate=!0}drawRect(e,t,s,i,a,r){this.context.beginPath(),this.context.lineWidth=r||"4",this.context.strokeStyle=a||"green",this.context.rect(e,t,s,i),this.context.stroke(),this.texture.needsUpdate=!0}drawLine(e,t,s,i,a,r){this.context.lineWidth=r||"1",this.context.strokeStyle=a||"white",this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(s,i),this.context.stroke(),this.texture.needsUpdate=!0}drawPoly(t,e,s){this.context.lineWidth=s||"1",this.context.strokeStyle=e||"white",this.context.beginPath(),this.context.moveTo(t[0],t[1]);for(let e=2;e<t.length;e+=2)this.context.lineTo(t[e],t[e+1]);this.context.stroke(),this.texture.needsUpdate=!0}drawPath(e){this.context.stroke(e),this.texture.needsUpdate=!0}drawImage(e,t,s,i,a){this.context.drawImage(e,t,s,i,a),this.texture.needsUpdate=!0}changed(){this.texture.needsUpdate=!0,this.mipmapTexture.dispose(),this.mipmapTexture=null}setScale(e){this.scale=e,this.context.scale(e,e)}}var i=s(6946),a=s(4072);const r=_.THREE_MESH_BVH["MeshBVH"],o=["translation","scale","rotation","layers","parent","behaviorModules","multiuser","name","noSave"];class CardActor extends(0,c.mix)(c.Actor).with(c.AM_Smoothed,t.w9,i.Xl){static okayToIgnore(){return["$local","$global","$rigidBody"]}init(e){var{cardOptions:t,cardData:s}=this.separateOptions(e);t.layers||(t.layers=["pointer"]),this.scriptListeners=new Map,super.init(t),this._cardData=s,this.noSave=e.noSave,this.createShape(s),this.listen("selectEdit",this.saySelectEdit),this.listen("unselectEdit",this.sayUnselectEdit),this.listen("showControls",this.showControls),this.listen("setCardData",this.setCardData),this.listen("setAnimationClipIndex",this.setAnimationClipIndex)}destroy(){this.publish("actorManager","destroyed",this.id),super.destroy()}separateOptions(t){let s={},i={};return Object.keys(t).forEach(e=>{0<=o.indexOf(e)?s[e]=t[e]:i[e]=t[e]}),{cardOptions:s,cardData:i}}updateOptions(e){console.log("updateOptions",e);var{cardOptions:t,cardData:s}=this.separateOptions(e);this.updateBehaviors(e),this.set({...t}),this.set({cardData:s}),this.say("updateShape",e)}addBehaviorModule(e){let t;if(this._behaviorModules){if(this._behaviorModules.includes(e))return;t=[...this._behaviorModules,e]}else t=[e];this.updateBehaviors({behaviorModules:t})}removeBehaviorModule(e){var t;!this._behaviorModules||(e=this._behaviorModules.indexOf(e))<0||((t=[...this._behaviorModules]).splice(e,1),this.updateBehaviors({behaviorModules:t}))}updateBehaviors(e){if(e.behaviorModules){let s=this.behaviorManager,i=[],a=[],t=(e.behaviorModules.forEach(e=>{var t=s.modules.get(e);t?(t.actorBehaviors&&i.push(...t.actorBehaviors.values()),t.pawnBehaviors&&a.push(...t.pawnBehaviors.values())):console.error(`unknown module ${e} is specified for update`)}),[]),r=[];this._behaviorModules&&this._behaviorModules.forEach(e=>{e=s.modules.get(e);e.actorBehaviors&&t.push(...e.actorBehaviors.values()),e.pawnBehaviors&&r.push(...e.pawnBehaviors.values())}),t.forEach(e=>{i.includes(e)||s.modelUnuse(this,e)}),r.forEach(e=>{a.includes(e)||s.viewUnuse(this,e)}),i.forEach(e=>{t.includes(e)||s.modelUse(this,e)}),a.forEach(e=>{r.includes(e)||s.viewUse(this,e)}),this._behaviorModules=[...e.behaviorModules]}}addLayer(e){this._layers&&this._layers.includes(e)||this.set({layers:[...this._layers||[],e]})}removeLayer(t){this._layers.includes(t)&&(this._layers=this._layers.filter(e=>e!==t))}setCardData(e){var t={...this._cardData,...e};this.set({cardData:t}),this.updateBehaviors(e)}createShape(e){var t=e.type;"text"===t?this.subscribe(this.id,"changed","textChanged"):"code"===t?(this.subscribe(this.id,"changed","textChanged"),this.subscribe(this.id,"text","codeAccepted")):"3d"===t||"3D"===t?void 0!==this._cardData.animationClipIndex&&void 0===this._cardData.animationStartTime&&(this._cardData.animationStartTime=this.now()):"2d"!==t&&"2D"!==t&&"lighting"!==t&&"object"!==t&&"initial"!==t&&console.log("unknown type for a card: ",e.type)}get pawn(){return CardPawn}get layers(){return this._layers}get isCard(){return!0}get name(){return this._name||"Card"}get color(){return this._color||16777215}uv2xy(e){return[this._cardData.textureWidth*e[0],this._cardData.textureHeight*(1-e[1])]}textChanged(){this._cardData.runs=this.content.runs,this.publish(this.sessionId,"triggerPersist")}sayDeck(e,t){if(this._parent)return this.publish(this._parent.id,e,t);this.publish(this.id,e,t)}listenDeck(e,t){if(this._parent)return this.subscribe(this._parent.id,e,t);this.subscribe(this.id,e,t)}rotateBy(e){e=3===e.length?(0,c.q_euler)(...e):e,e=(0,c.q_multiply)(this.rotation,e);this.rotateTo(e)}translateBy(e){var e=Array.isArray(e)?e:[0,0,e],t=this.translation;this.translateTo([t[0]+e[0],t[1]+e[1],t[2]+e[2]])}forwardBy(e){var e=Array.isArray(e)?e:[0,0,e],e=(0,c.v3_rotate)(e,this.rotation),t=this.translation;this.translateTo([t[0]+e[0],t[1]+e[1],t[2]+e[2]])}scaleBy(e){var e=Array.isArray(e)?e:[e,e,e],t=this.scale;this.scaleTo([t[0]+e[0],t[1]+e[1],t[2]+e[2]])}nop(){}duplicate(){var e=new a.H(CardActor).collectCardData(this),t=(delete e.parent,this.translation);e.translation=[t[0]+2,t[1],t[2]],this.createCard(e)}saveCard(e){this.say("saveCard",e)}allChildrenMap(t){return t=t||new Map,this.noSave||t.set(this.id,this),this.children&&this.children.forEach(e=>e.allChildrenMap(t)),t}showControls(e){var t=this.service("ActorManager").actors.get(e.avatar),e=e.distance||6,e=Math.min(.7*e,4);t&&(t=t.dropPose(e,[1,1,0]),this.behaviorManager.modules.get("PropertySheet"))&&this.createCard({name:"property panel",behaviorModules:["PropertySheet"],translation:t.translation,rotation:t.rotation,type:"object",fullBright:!0,color:16777215,frameColor:6710886,width:3,height:3.2,cornerRadius:.02,depth:.02,noSave:!0,target:this.id}).call("PropertySheet$PropertySheetActor","setObject",this)}setAnimationClipIndex(e){this._cardData.animationClipIndex=e,void 0===this._cardData.animationStartTime&&(this._cardData.animationStartTime=this.now()),this.say("animationStateChanged")}intrinsicProperties(){return o}saySelectEdit(e){console.log("saySelectEdit says doSelectEdit",e),this.editBox=e,this.say("doSelectEdit")}sayUnselectEdit(){this.say("doUnselectEdit")}collectCardData(){return new a.H(CardActor).collectCardData(this,!0)}static load(e,t,s){let i,d;if(Array.isArray(e)?i=e:(i=e.array,d=e.nameMap),"1"!==s)return[];{let n=t.service("MicroverseAppManager"),l=t.service("BehaviorModelManager"),h=new Map;return i.map(({id:e,card:t})=>{let s,i={...t},a;"code"===i.type?(i.behaviorModule&&([o,r]=i.behaviorModule.split("."),a=l.lookup(o,r)),o=[{text:a?a.code:""}],i={backgroundColor:13421772,textScale:i.textScale||.002,...i,runs:o},s=u.T0):"text"===t.type?s=u.T0:t.className?(s=n.get(t.className),delete i.className):s=CardActor,t.parent&&"object"!=typeof t.parent&&(r=h.get(t.parent),i.parent=r),Array.isArray(t.rotation)&&3===t.rotation.length&&(i.rotation=(0,c.q_euler)(...t.rotation)),Array.isArray(t.dataRotation)&&3===t.dataRotation.length&&(i.dataRotation=(0,c.q_euler)(...t.dataRotation)),d&&i.behaviorModules&&(i.behaviorModules=i.behaviorModules.map(e=>d.get(e)||e)),"string"==typeof i.parent&&(console.log("encountered parent as string",i.parent),delete i.parent);var r,o=s.create(i);return e&&h.set(e,o),"code"===i.type&&a&&o.subscribe(a.id,"setCode","loadAndReset"),o})}}get rigidBody(){return this._oldRapier07?{applyForce:()=>{},applyTorque:()=>{}}:this.call("Physics$PhysicsActor","getRigidBody")}setPhysicsWorld(e){return this._physicsWorld=e}get physicsWorld(){var e=this.service("PhysicsManager");return e.globalWorld||this._physicsWorld||(this._parent?this._parent._physicsWorld:void 0)}collisionEvent(e,t,s){return this.call(this.collisionEventHandlerBehavior,this.collisionEventHandlerMethod,e,t,s)}getTextFieldActorClass(){return u.T0}}CardActor.register("CardActor");class CardPawn extends(0,c.mix)(c.Pawn).with(c.PM_Smoothed,_.PM_ThreeVisible,t.vJ,i.AH){constructor(e){super(e),this.addToLayers(...e.layers),this.addEventListener("pointerDoubleDown","onPointerDoubleDown"),this.listen("doSelectEdit",this.doSelectEdit),this.listen("doUnselectEdit",this.doUnselectEdit),this.listen("cardDataSet",this.cardDataUpdated),this.listen("updateShape",this.updateShape),this.listen("layersSet",this.updateLayers),this.listen("saveCard",this.saveCard),this.listen("animationStateChanged",this.tryStartAnimation),this.animationInterval=null,this.subscribe(this.id,"3dModelLoaded",this.tryStartAnimation),this.constructCard(),this._editMode=!1}sayDeck(e,t){void 0!==this.actor._parent?this.publish(this.actor._parent.id,e,t):this.publish(this.actor.id,e,t)}listenDeck(e,t){void 0!==this.actor._parent?this.subscribe(this.actor._parent.id,e,t):this.subscribe(this.actor.id,e,t)}constructCard(){this.shape=new _.THREE.Group,this.shape.name=this.actor.name,this.setRenderObject(this.shape),this.constructShape(this.actor._cardData)}constructShape(e){var t=e.type;"3d"===t||"3D"===t?this.construct3D(e):"2d"===t||"2D"===t?(this.isFlat=!0,this.construct2D(e)):"text"!==t&&"code"!==t||(this.isFlat=!0)}destroy(){var e=this.actor._cardData,t=this.service("AssetManager").assetManager;e.dataLocation&&t.revoke(e.dataLocation,this.id),e.textureLocation&&t.revoke(e.textureLocation,this.id),this.cleanupColliderObject(),super.destroy()}ensureColliderObject(){var e;this.colliderObject||(e=new _.THREE.Group,this.setColliderObject(e),e.collider=!0)}cleanupColliderObject(){this.colliderObject&&([...this.colliderObject.children].forEach(e=>{e.geometry&&(e.geometry.dispose(),this.colliderObject.remove(e))}),this.colliderObject.geometry&&this.colliderObject.geometry.dispose(),this.colliderObject.removeFromParent(),delete this.colliderObject)}updateLayers(){var e=this.layers();let t=[];e.forEach(e=>{this.actor.layers.includes(e)||t.push(e)}),0<t.length&&this.removeFromLayers(...t);e=this.actor._layers;e&&this.addToLayers(...e)}cleanupShape(e){this.updateLayers(),delete this.isFlat,this.placeholder&&(this.placeholder.children.forEach(e=>{e.geometry.dispose(),e.material.dispose()}),this.shape.remove(this.placeholder),delete this.placeholder),delete this.video,this.texture&&(this.texture.dispose(),delete this.texture),this.objectURL&&(URL.revokeObjectURL(this.objectURL),delete this.objectURL),this.material&&this.material.dispose(),delete this.name,delete this.properties2D,delete this.animationSpec,this.animationInterval&&(clearInterval(this.animationInterval),this.animationInterval=null),this.cleanupColliderObject(),this.shape&&(this.shape.traverse(e=>{e!==this.shape&&(e.geometry&&e.geometry.dispose(),e.material)&&(e.material.dispose?e.material.dispose():e.material.forEach(e=>e.dispose()))}),[...this.shape.children].forEach(e=>this.shape.remove(e)))}updateShape(e){this.cleanupShape(e),this.constructShape(this.actor._cardData)}construct3D(i){let a=i.dataLocation,t=i.modelType;if(i.placeholder){var s=i.placeholderSize||[40,1,40],r=i.placeholderColor||8421504,o=i.placeholderOffset||[0,-1.7,0],n=new Image;let e=new _.THREE.Texture(n);n.onload=()=>e.needsUpdate=!0,n.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOnAAADusBZ+q87AAAAJtJREFUeJzt0EENwDAAxLDbNP6UOxh+NEYQ5dl2drFv286598GrA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAa4AO0BqgA7QG6ACtATpAu37AD8eaBH5JQdVbAAAAAElFTkSuQmCC",e.wrapS=_.THREE.RepeatWrapping,e.wrapT=_.THREE.RepeatWrapping,e.repeat.set(s[0],s[2]);n=new _.THREE.BoxGeometry(...s),s=new _.THREE.MeshStandardMaterial({map:e,color:r,side:_.THREE.FrontSide}),r=new _.THREE.Mesh(n,s);r.receiveShadow=!0,this.placeholder=r,this.placeholder.position.set(...o),this.placeholder.name="placeholder",0<=this.actor.layers.indexOf("walk")&&this.constructCollider(this.placeholder),this.shape.add(this.placeholder)}let l=this.actor.name,h=void 0===i.shadow||i.shadow,d=void 0!==i.singleSided&&i.singleSided,c=void 0!==i.noFog&&i.noFog;if(a&&this._model3dLoading!==a){this._model3dLoading=a;let s=this.service("AssetManager").assetManager;this.getBuffer(a).then(e=>(s.setCache(a,e,this.id),s.load(e,t,_.THREE))).then(e=>{var t;a!==this._model3dLoading?console.log("model load has been superseded"):(this.setupObj(e,i),this.setupAnimation(e),e.updateMatrixWorld(!0),i.placeholder&&(console.log("delete collider for placeholder"),s.revoke(a,this.id),this.cleanupColliderObject(),this.shape.remove(this.placeholder)),i.flatten&&(t=this.flattenObj(e))!==e&&(e.traverse(e=>{e.geometry&&(e.geometry.dispose(),e.material.dispose())}),e=t),(0,x.Bg)(e,h,d,c,_.THREE),0<=this.actor.layers.indexOf("walk")&&this.constructCollider(e),this.shape.add(e),e.updateMatrixWorld(!0),l&&(e.name=l),Array.isArray(e.material)&&(e.material.dispose=arrayDispose),delete this._model3dLoading,this.publish(this.id,"3dModelLoaded"))}).catch(e=>{delete this._model3dLoading})}}construct2D(t){let s=t.dataLocation,i=t.textureLocation;var e=t.textureType;let a,r=void 0!==t.depth?t.depth:.05,o=void 0!==t.width?t.width:1,n=void 0!==t.height?t.height:1,l=void 0!==t.textureWidth?t.textureWidth:512,h=void 0!==t.textureHeight?t.textureHeight:512;var d,c,u=t.name||this.id;let p=t.color,m=t.frameColor||6710886,f=void 0!==t.fullBright&&t.fullBright,v=void 0===t.shadow||t.shadow,g=void 0!==t.cornerRadius?t.cornerRadius:0,y=(this.properties2D={depth:r,width:o,height:n,textureWidth:l,textureHeight:h,name:u,color:p,frameColor:m,fullBright:f,shadow:v,cornerRadius:g},"video"===e?(d=void 0===this.actor._cardData.muted||this.actor._cardData.muted,c=void 0!==this.actor._cardData.loop&&this.actor._cardData.loop,this.video=document.createElement("video"),this.video.autoplay=!0,this.video.muted=d,this.video.loop=c,this.video.controls=!1,this.video.width=l,this.video.height=h,this.getBuffer(i).then(e=>{e=URL.createObjectURL(new Blob([e],{type:"video/mp4"}));this.video.src=e,this.videoLoaded=!0,this.objectURL=e}),this.texture=new _.THREE.VideoTexture(this.video),a=Promise.resolve({width:this.video.width,height:this.video.height,texture:this.texture})):"image"===e?a=this.getBuffer(i).then(e=>{if(e.texture)return this.texture=e.texture,Promise.resolve(e);let s=URL.createObjectURL(new Blob([e]));return this.objectURL=s,new Promise((t,e)=>{this.texture=(new _.THREE.TextureLoader).load(s,e=>{URL.revokeObjectURL(s),t({width:e.image.width,height:e.image.height,texture:e})},null,e)})}):"canvas"===e?(this.canvas=document.createElement("canvas"),this.canvas.id=u,this.canvas.width=l,this.canvas.height=h,this.texture=new _.THREE.CanvasTexture(this.canvas),a=Promise.resolve({width:l,height:h,texture:this.texture})):"dynamic"===e&&(this.dynamic=new DynamicTexture(l,h,t.fillStyle,t.clearStyle),this.texture=this.dynamic.texture,a=Promise.resolve({width:l,height:h,texture:this.texture})),a=a||Promise.resolve(void 0),{texture:this.texture,color:p,frameColor:m,fullBright:f,shadow:v,depth:r}),w=this.service("AssetManager").assetManager;return s?this.getBuffer(s).then(e=>(w.setCache(s,e,this.id),w.load(e,"svg",_.THREE,y))).then(e=>((0,x.bp)(e,r,v,_.THREE),e)).then(e=>{this.texture&&(0,x.iF)(e,this.texture),t.dataTranslation&&e.position.set(...t.dataTranslation),e.name="2d",Array.isArray(e.material)&&(e.material.dispose=arrayDispose),this.objectCreated(e),this.shape.add(e),this.publish(this.id,"2dModelLoaded")}):a.then(e=>{e&&e.texture&&(l=e.width,h=e.height,t=1/Math.max(l,h),o=l*t,n=h*t,i&&w.setCache(i,e,this.id),this.properties2D={...this.properties2D,width:o,height:n,textureWidth:l,textureHeight:h});var t=this.roundedCornerGeometry(o,n,r,g),e=this.makePlaneMaterial(r,p||16777215,m,f),t=(this.texture&&(e[0].map=this.texture),this.material=e,new _.THREE.Mesh(t,e));t.castShadow=v,t.name="2d",this.objectCreated(t),this.shape.add(t),this.publish(this.id,"2dModelLoaded")})}flattenObj(t){let i=new _.THREE.Group,a=[],r=0,o=0;try{t.traverse(e=>{var t,s;r++,e.geometry&&((t=e.geometry.clone()).applyMatrix4(e.matrixWorld),t.index?(t.attributes.uv2&&(delete t.attributes.uv2,delete t.attributes.texcoord_2),s=e.material.map?e.material.map.id:0,a[s]||(a[s]={material:e.material.clone(),geometries:[]}),a[s].geometries.push(t)):console.warn("skipping a geometry in the model that is not indexed"))});let s=_.THREE.BufferGeometryUtils;a.forEach(e=>{o++;var t=s.mergeBufferGeometries(e.geometries,!1),t=new _.THREE.Mesh(t,e.material);i.add(t)})}catch(e){return console.error("failed to build the static for:",t),console.error(e),t}return console.log("Static - before:",r,"end:",o,"object:",t),i}constructCollider(t){let i=[];this.ensureColliderObject();let e;try{t.traverse(e=>{if(e.geometry){var t=e.geometry.clone();t.applyMatrix4(e.matrixWorld);for(const s in t.attributes)"position"!==s&&t.deleteAttribute(s);t.index?i.push(t):console.warn("skipping a geometry in the model that is not indexed")}});var s=window.THREE.BufferGeometryUtils;(e=s.mergeBufferGeometries(i,!1)).boundsTree=new r(e,{lazyGeneration:!1})}catch(e){return console.error("failed to build the BVH collider for:",t),void console.error(e)}s=new _.THREE.Mesh(e);s.material.wireframe=!0,s.material.opacity=.5,s.matrixWorld=t.matrixWorld.clone(),s.updateMatrixWorld(!0),s.visible=!1,this.colliderObject.add(s)}setupObj(e,t){t.dataScale&&e.scale.set(...t.dataScale),t.dataTranslation&&e.position.set(...t.dataTranslation),t.dataRotation&&(t=3===t.dataRotation.length?(0,c.q_euler)(...t.dataRotation):t.dataRotation,e.quaternion.set(...t))}setupAnimation(e){e._croquetAnimation&&(e=e._croquetAnimation)&&(this.animationSpec=e,this.tryStartAnimation())}objectCreated(){}roundedCornerGeometry(e,i,t,s){var a=i/2,r=e/2,o=t/2,s=void 0===s?0:s,n=new _.THREE.Shape,s=(n.moveTo(-a,-r+s),n.lineTo(-a,r-s),n.quadraticCurveTo(-a,r,-a+s,r),n.lineTo(a-s,r),n.quadraticCurveTo(a,r,a,r-s),n.lineTo(a,-r+s),n.quadraticCurveTo(a,-r,a-s,-r),n.lineTo(-a+s,-r),n.quadraticCurveTo(-a,-r,-a,-r+s),new _.THREE.LineCurve3(new _.THREE.Vector3(0,0,o),new _.THREE.Vector3(0,0,-o))),n=(s.arcLengthDivisions=3,new _.THREE.ExtrudeGeometry(n,{extrudePath:s})),s=(n.parameters.width=e,n.parameters.height=i,n.parameters.depth=t,new _.THREE.Box3(new _.THREE.Vector3(-a,-r,-o),new _.THREE.Vector3(a,r,o))),l=n.getAttribute("uv").array,i=(e=s).max.x-e.min.x,e=e.max.y-e.min.y;if(i&&e){let t=1,s=1;i<e?s=e/i:e<i&&(t=i/e);for(let e=0;e<l.length;e+=2)l[e]=l[e]*t+.5,l[e+1]=l[e+1]*s+.5}return n}makePlaneMaterial(e,t,s,i){this.material&&this.material.dispose();let a;return a=i?new _.THREE.MeshBasicMaterial({color:t,side:_.THREE.FrontSide,toneMapped:!1}):new _.THREE.MeshPhongMaterial({color:t,side:_.THREE.FrontSide}),0<e&&(i=new _.THREE.MeshPhongMaterial({color:s,side:_.THREE.FrontSide}),a=[a,i]),this.material=a,Array.isArray(this.material)&&(this.material.dispose=arrayDispose),a}dataType(e){return e.startsWith("data:")?"dataUri":e.startsWith("http://")||e.startsWith("https://")||e.startsWith(".")||e.startsWith("/")?"url":"dataId"}getBuffer(e){var t=this.service("AssetManager").assetManager.getCache(e);return t?Promise.resolve(t):"url"===(t=this.dataType(e))||"dataUri"===t?fetch(e).then(e=>{if(e.ok)return e.arrayBuffer();throw Error(`fetch failed: ${e.status} `+e.statusText)}).then(e=>new Uint8Array(e)):"dataId"===t?(t=c.Data.fromId(e),c.Data.fetch(this.sessionId,t)):void 0}cardDataUpdated(e){if(this.didPropertyChange(e,["type","dataLocation","dataRotation","dataScale"]))return this.updateShape();var t,s,i,a,r,o,n,l;"2d"===e.v.type&&(l=this.shape.children.find(e=>"2d"===e.name))&&l.children&&0!==l.children.length&&(l=l.children[0],this.didPropertyChange(e,["depth","width","height","color","frameColor","cornerRadius","fullBright"]))&&({depth:t,width:s,height:i,color:o,frameColor:n,cornerRadius:a,fullBright:r}=e.v,s=void 0!==s?s:1,i=void 0!==i?i:1,a=void 0!==a?a:0,o=this.makePlaneMaterial(t=void 0!==t?t:.05,o=o||16777215,n=n||6710886,r=void 0!==r&&r),this.didPropertyChange(e,["depth","width","height","cornerRadius"])&&(n=this.roundedCornerGeometry(s,i,t,a),l.geometry=n),l.material=o)}didPropertyChange({o:t,v:s},e){return Array.isArray(e)?e.some(e=>t[e]!==s[e]):t[e]!==s[e]}uv2xy(e){return this.actor.uv2xy(e)}onPointerDoubleDown(e){var t;e.targetId&&((t=this.getJumpToPose?this.getJumpToPose():null)&&(e.xyz=t[0],e.offset=t[1],e.look=!0),this.publish(e.avatarId,"goThere",e))}showControls(e){this.say("showControls",e)}getJumpToPose(){if(!this.isFlat)return null;var e=this.renderObject.localToWorld(new _.THREE.Vector3).toArray(),t=this.service("ThreeRenderManager"),s=t.camera.aspect,i=t.canvas.width,t=t.canvas.height,a=t/2*Math.sqrt(3),r=this.renderObject.matrix,o=new _.THREE.Vector3(0,0,0);try{var n=new _.THREE.Vector3(0,0,0),l=(n.setFromMatrixScale(r),new _.THREE.Matrix4);l.makeScale(n.x,n.y,n.z),this.renderObject.matrix=l,(new _.THREE.Box3).setFromObject(this.renderObject).getSize(o)}finally{this.renderObject.matrix=r}return[e,1.1*(o.x/o.y<s?o.y*a/t:o.x*a/i)]}verticalNorm(e){var t=[...e];return(t[1]=0,c.v3_sqrMag)(t)<.001&&(t[0]=0,t[1]=e[1],t[2]=0),(0,c.v3_normalize)(t)}dragPlane(e,t){this._plane||(s=t.normal||t.lookNormal,s=this.verticalNorm(s),i=(0,c.v3_dot)(t.xyz,s),this._plane=new _.THREE.Plane(new _.THREE.Vector3(...s),-i),this._parentInvert=this._parent?(0,c.m4_invert)(this._parent.global):(0,c.m4_identity)(),this.startDrag=(0,c.v3_transform)(t.xyz,this._parentInvert),this._startTranslation=this._translation);var s=new _.THREE.Vector3,i=(e.ray.intersectPlane(this._plane,s),s.toArray()),t=(0,c.v3_transform)(i,this._parentInvert),e=(0,c.v3_sub)(t,this.startDrag);this.set({translation:(0,c.v3_add)(this._startTranslation,e)})}rotatePlane(e,t){if(!this._plane){let e=[...t.lookNormal];e[1]=0,e=(0,c.v3_normalize)(e);var s=(0,c.v3_dot)(t.xyz,e);this._plane=new _.THREE.Plane(new _.THREE.Vector3(...e),-s),this.startDrag=t.xyz,this.baseRotation=this._rotation,this.rotAngle=0}s=new _.THREE.Vector3,e.ray.intersectPlane(this._plane,s),e=s.toArray(),s=(0,c.v3_sub)(this.startDrag,e);let i=(s[1]=0,c.v3_magnitude)(s);(0,c.v3_cross)(t.lookNormal,s)[1]<0&&(i=-i);e=(0,c.q_euler)(0,i,0);this.set({rotation:(0,c.q_multiply)(this.baseRotation,e)})}tryStartAnimation(){void 0===this.actor._cardData.animationClipIndex&&0<this.animationSpec?.animations.length&&this.say("setAnimationClipIndex",0),this.runAnimation()}runAnimation(){var e=this.animationSpec;if(e){this.animationInterval||(this.animationInterval=setInterval(()=>this.runAnimation(),50));var t=this.actor._cardData.animationClipIndex;if(void 0!==t&&!(t<0)){var s=this.now(),i=this.actor._cardData.animationStartTime,{mixer:a,lastTime:r,lastAnimationClipIndex:o}=e;if(t!==o){a.stopAllAction();o=e.animations[t];if(!o)return;a.clipAction(o).play(),e.lastAnimationClipIndex=t}o=(s-i)/1e3;a.update(o-r),e.lastTime=o}}else this.animationInterval&&(clearInterval(this.animationInterval),this.animationInterval=null)}selectEdit(){this.say("selectEdit",this.getBox(this.renderObject))}unselectEdit(){this.say("unselectEdit"),delete this._plane}doSelectEdit(){this._editMode=!0,console.log("doSelectEdit")}doUnselectEdit(){this._editMode=!1,console.log("doUnselectEdit")}getBox(e){var t=new _.THREE.Matrix4,s=e.matrix;let i;try{e.matrix=t,i=(new _.THREE.Box3).setFromObject(e)}finally{e.matrix=s}return[...i.min.toArray(),...i.max.toArray()]}nop(){}getMyAvatar(){var e=this.actor.service("PlayerManager").players.get(this.viewId);if(e)return(0,c.GetPawn)(e.id)}addWireBox(e){var t=new _.THREE.Matrix4,s=e.matrix;let i;try{e.matrix=t,i=(new _.THREE.Box3).setFromObject(e)}finally{e.matrix=s}var t=i.min,s=i.max,a=s.x-t.x,r=(s.x+t.x)/2,o=s.y-t.y,n=(s.y+t.y)/2,l=s.z-t.z,h=(s.z+t.z)/2,d=(e,t,s,i,a)=>{e=new _.THREE.CylinderGeometry(.02,.02,e);return t&&e[t](Math.PI/2),e.translate(s,i,a),e},c=d(a,"rotateZ",r,1.01*s.y,1.01*s.z),u=d(a,"rotateZ",r,1.01*s.y,1.01*t.z),p=d(a,"rotateZ",r,1.01*t.y,1.01*s.z),a=d(a,"rotateZ",r,1.01*t.y,1.01*t.z),r=d(o,null,1.01*s.x,n,1.01*s.z),m=d(o,null,1.01*s.x,n,1.01*t.z),f=d(o,null,1.01*t.x,n,1.01*s.z),o=d(o,null,1.01*t.x,n,1.01*t.z),n=d(l,"rotateX",1.01*s.x,1.01*s.y,h),v=d(l,"rotateX",1.01*s.x,1.01*t.y,h),s=d(l,"rotateX",1.01*t.x,1.01*s.y,h),d=d(l,"rotateX",1.01*t.x,1.01*t.y,h),l=_.THREE.BufferGeometryUtils.mergeBufferGeometries([c,u,p,a,r,m,f,o,n,v,s,d],!1),t=new _.THREE.MeshStandardMaterial({color:14540253,transparent:!0,opacity:.6,depthTest:!1,depthWrite:!1}),h=new _.THREE.Mesh(l,t);h._wireline=!0,h.renderOrder=1e4,e.add(h)}removeWireBox(e){[...e.children].forEach(e=>{e._wireline&&(e.geometry.dispose(),e.material.dispose(),e.removeFromParent())})}saveCard(e){if(e.viewId===this.viewId){var e=this.actor.allChildrenMap(),s=new a.H(CardActor),i={},e=s.collectData(e);delete e[0].card.parent;let t=[];(i.cards=e).forEach(e=>{e.card.behaviorModules&&t.push(...e.card.behaviorModules)});e=this.actor.behaviorManager.save(t),e=(i.behaviorModules=e,c.Constants.UserRapier&&(i.useRapier=!0),s.stringify(i)),s=this.actor._name||"card",i={name:s,version:"1",data:JSON.parse(e)},e=document.createElement("a"),i="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(i,null,4));e.setAttribute("href",i),e.setAttribute("download",s+".vrse"),e.click()}}}class MicroverseAppManager extends c.ModelService{init(e){super.init("MicroverseAppManager")}add(e){}set(e,t){}get(e){try{return this.constructor.classFromID(e)}catch(e){}return null}delete(e){}}function arrayDispose(){Array.isArray(this)?this.forEach(e=>e.dispose()):this.dispose()}MicroverseAppManager.register("MicroverseAppManager")},6946:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{AH:()=>PM_Code,IL:()=>BehaviorModelManager,OO:()=>checkModule,Un:()=>CodeLibrary,Xl:()=>AM_Code,ui:()=>BehaviorViewManager});var _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4200),_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(5679),_physics_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(6590),_frame_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(3917);const{ViewService,ModelService,GetPawn,Model,Constants}=_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__;let isProxy=Symbol("isProxy");function newProxy(a,r,e,i){return a[isProxy]?a:new Proxy(a,{get(e,t){var s;return t===isProxy||("_target"===t?a:"_behavior"===t?i:r&&r.hasOwnProperty(t)?(s=Object.getOwnPropertyDescriptor(r,t)?.get)?s.apply(a):r[t]:e[t])},set(e,t,s){var i=r&&r.hasOwnProperty(t)&&Object.getOwnPropertyDescriptor(r,t)?.set;return i?i.apply(a,[s]):e[t]=s,!0}})}const AM_Code=e=>class extends e{init(e){super.init(e),this.scriptListeners=new Map,this.behaviorManager=this.service("BehaviorModelManager"),e.behaviorModules&&e.behaviorModules.forEach(e=>{var t=this.behaviorManager.modules.get(e);if(t){var{actorBehaviors:t,pawnBehaviors:s}=t;if(t)for(var i of t.values())this.behaviorManager.modelUse(this,i);if(s)for(var a of s.values())this.behaviorManager.viewUse(this,a)}else console.error(`unknown module ${e} is specified`)})}destroy(){if(this[isProxy])return this._target.destroy();this._behaviorModules&&this._behaviorModules.forEach(e=>{var t=this.behaviorManager.modules.get(e);if(t){var{actorBehaviors:t,pawnBehaviors:s}=t;if(t)for(var i of t.values())this.behaviorManager.modelUnuse(this,i);if(s)for(var a of s.values())this.behaviorManager.viewUnuse(this,a)}else console.error(`unknown module ${e} is being torn down`)}),super.destroy()}future(e){var t,s;return this[isProxy]?(t=this._behavior.$behaviorName,s=this._behavior.module.externalName,this.futureWithBehavior(e,s,t)):super.future(e)}futureWithBehavior(s,a,r){let o=(e,t)=>super.future(s,e,...t),n=this.behaviorManager,l=this.call;return new Proxy(this,{get(e,t){var s=n.lookup(a,r),s="call"===t?l:s.$behavior[t];let i="call"===t?"call":a+`$${r}.`+t;if("function"==typeof s)return new Proxy(s,{apply(e,t,s){return o(i,s)}});throw Error("Tried to call "+t+"() on future of "+r+" which is not a function")}})}call(e,t,...s){let i;var a=e.split("$"),a=(1<a.length&&(i=a[0],e=a[1]),!i&&this[isProxy]&&(i=this._behavior.module.externalName),this.behaviorManager.lookup(i,e));if(a)return a.invoke(this[isProxy]?this._target:this,t,...s);throw new Error(`behavior named ${e} not found`)}listen(e,t){return this.scriptSubscribe(this.id,e,t)}subscribe(e,t,s){return this.scriptSubscribe(e,t,s)}has(e,t){return this.hasBehavior(e,t)}hasBehavior(e,t){return this.checkBehavior(this,!0,e,t)}checkBehavior(e,t,s,i){let a,r;r=0<s.indexOf("$")?(n=s.split("$"),a=n[0],n[1]):(a=s,null),!a&&e[isProxy]&&(a=e._behavior.module.externalName);let o=e;var n=(o=t?o:o.actor)._behaviorModules,s=o.behaviorManager;return!(!n||!n.includes(a)||!r||!(e=s.lookup(a,r))||i&&!e.$behavior[i])}scriptSubscribe(e,t,s){if("function"==typeof s&&!this[isProxy])return super.subscribe(e,t,s);let i,a;var r=(s="function"==typeof s?s.name:s).indexOf("$"),r=(1<=r&&(a=s.slice(0,r),s=s.slice(r+1)),s.indexOf(".")),r=(1<=r&&(i=s.slice(0,r),s=s.slice(r+1)),this._behavior);!a&&r&&(a=r.module.externalName),!i&&r&&(i=r.$behaviorName);let o;r=e+":"+t+(o=i?""+a+(a?"$":"")+i+(i?".":"")+s:s);this.scriptListeners&&this.scriptListeners.get(r)||(this.scriptListeners&&this.scriptListeners.set(r,o),super.subscribe(e,t,o))}codeAccepted(e){var t=/^class[\s]+([\S]+)/.exec(e.text.trim());if(t){var[s,i]=this._cardData.behaviorModule.split(".");if(t[1]!==i)throw new Error("changing the behavior name not supported");t=this.behaviorManager.moduleDefs.get(s);if(!t)throw new Error("module no longer exists");s={name:t.name,systemModule:t.systemModule,location:t.location,actorBehaviors:new Map([...t.actorBehaviors]),pawnBehaviors:new Map([...t.pawnBehaviors])};if(s.actorBehaviors.get(i)){if(s.actorBehaviors.get(i)===e.text)return;s.actorBehaviors.set(i,e.text)}else if(s.pawnBehaviors.get(i)){if(s.pawnBehaviors.get(i)===e.text)return;s.pawnBehaviors.set(i,e.text)}console.log("codeAccepted"),this.behaviorManager.loadLibraries([s])}else console.log("code does not begin with the keyword class and name")}createCard(e){e.parent&&e.parent[isProxy]&&(e={...e,parent:e.parent._target});e=(this[isProxy]?this._target:this).constructor.load([{card:e}],this.wellKnownModel("ModelRoot"),"1")[0];return this.publish(this.sessionId,"triggerPersist"),e}queryCards(t,s){let e=[...this.service("ActorManager").actors].filter(e=>e[1].isCard).map(e=>e[1]);return t&&(t.moduleName&&t.methodName?e=e.filter(e=>s.call(t.moduleName,t.methodName,e)):t.methodName&&(e=e.filter(e=>s[t.methodName].call(s,e)))),e}},PM_Code=e=>class extends e{constructor(e){super(e),this.scriptListeners=new Map;let i=this.actor.behaviorManager;this.subscribe(e.id,"callSetup","callSetup"),this.subscribe(e.id,"callTeardown","callTeardown"),e._behaviorModules&&e._behaviorModules.forEach(e=>{var t=i.modules.get(e),e=(t||{})["pawnBehaviors"];if(e)for(var s of e.values())s&&s.ensureBehavior(),s.$behavior.setup&&this.future(0).callSetup(t.externalName+"$"+s.$behaviorName)})}actorCall(e,t,...s){var i=this.actor,a=this._behavior.module.externalName;return i.call(a+"$"+e,t,...s)}call(e,t,...s){let i;var a=e.split("$"),a=(1<a.length&&(i=a[0],e=a[1]),!i&&this[isProxy]&&(i=this._behavior.module.externalName),this.actor.behaviorManager.lookup(i,e));if(a)return a.invoke(this[isProxy]?this._target:this,t,...s);throw new Error(`behavior named ${e} not found`)}destroy(){if(this[isProxy])return this._target.destroy();this.actor._behaviorModules&&this.actor._behaviorModules.forEach(e=>{var t=this.actor.behaviorManager.modules.get(e),e=(t||console.error(`unknown module ${e} is specified`),t)["pawnBehaviors"];if(e)for(var s of e.values())s.$behavior.teardown&&this.call(s.module.externalName+"$"+s.$behaviorName,"teardown")}),super.destroy()}callSetup(e){return this.call(e,"setup")}callTeardown(e){return this.call(e,"teardown")}scriptListen(e,t){return this.scriptSubscribe(this.actor.id,e,t)}subscribe(e,t,s){return this.scriptSubscribe(e,t,s)}has(e,t){return this.hasBehavior(e,t)}hasBehavior(e,t){return this.actor.checkBehavior(this,!1,e,t)}scriptSubscribe(e,t,s){if("function"==typeof s&&!this[isProxy])return super.subscribe(e,t,s);let i,a;"string"==typeof t?i=t:(i=t.event,a=t.handling);let r,o;t=(s="function"==typeof s?s.name:s).indexOf("$"),1<=t&&(o=s.slice(0,t),s=s.slice(t+1)),t=s.indexOf("."),1<=t&&(r=s.slice(0,t),s=s.slice(t+1)),t=this._behavior;!o&&t&&(o=t.module.externalName),!r&&t&&(r=t.$behaviorName);let n;n=r?""+o+(o?"$":"")+r+(r?".":"")+s:s;t=e+":"+i+n;if(this.scriptListeners&&this.scriptListeners.get(t)&&this.unsubscribe(e,i,n),this.scriptListeners&&this.scriptListeners.set(t,n),1<=n.indexOf(".")){let t=n.split(".");return super.subscribe(e,i,e=>this.call(t[0],t[1],e))}a?super.subscribe(e,{event:i,handling:a},n):super.subscribe(e,i,n)}update(t,s){super.update(t,s),this.updateRequests&&this.updateRequests.forEach(e=>{this.call(...e,t,s)})}addUpdateRequest(t){this.updateRequests||(this.updateRequests=[]),0<=this.updateRequests.findIndex(e=>e[0]===t[0]&&e[1]===t[1])||this.updateRequests.push(t)}removeUpdateRequest(t){var e;!this.updateRequests||(e=this.updateRequests.findIndex(e=>e[0]===t[0]&&e[1]===t[1]))<0||this.updateRequests.splice(e,1)}};class ScriptingBehavior extends Model{static okayToIgnore(){return["$behavior","$behaviorName"]}init(e){this.systemBehavior=!!e.systemBehavior,this.module=e.module,this.name=e.name,this.type=e.type,this.location=e.location}setCode(string){if(string){let theSame=this.code===string,trimmed=(this.code=string,string.trim()),source;if(0!==trimmed.length){/^class[ \t]/.test(trimmed)&&(source=trimmed);let code=`return (${source}) //# sourceURL=${window.location.origin}/behaviors_evaled/${this.location}/`+this.name,cls;try{const Microverse={..._croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__,..._ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__,..._physics_js__WEBPACK_IMPORTED_MODULE_2__,..._frame_js__WEBPACK_IMPORTED_MODULE_3__,RAPIER:_physics_js__WEBPACK_IMPORTED_MODULE_2__.Physics};cls=new Function("Worldcore","Microverse",code)(Microverse,Microverse)}catch(error){console.log("error occured while compiling:",source,error),eval(source)}"function"!=typeof cls||(this.$behavior=cls.prototype,this.$behaviorName=cls.name,theSame)||this.publish(this.id,"setCode",string)}}else console.log("code is empty for ",this)}ensureBehavior(){var e;return this.$behavior||(e=this.code,this.setCode(e)),this.$behavior}invoke(t,s,...e){this.ensureBehavior();var i=this.$behavior,a=this.$behaviorName;let r;i=newProxy(t,i,this.module,this);try{var o=i[s];if(void 0===o)throw new Error(`a method named ${s} not found in `+(a||this));r="function"==typeof o?o.apply(i,e):o}catch(e){console.error(`an error occured in ${a}.${s}() on`,t,e)}return r}}ScriptingBehavior.register("ScriptingBehavior");class ScriptingModule extends Model{init(e){super.init(e),this.name=e.name,this.systemModule=e.systemModule,this.location=e.location}}ScriptingModule.register("ScriptingModule");class BehaviorModelManager extends ModelService{init(e){super.init(e||"BehaviorModelManager"),this.cleanUp(),this.subscribe(this.id,"loadStart","loadStart"),this.subscribe(this.id,"loadOne","loadOne"),this.subscribe(this.id,"loadDone","loadDone")}cleanUp(){this.moduleDefs=new Map,this.modules=new Map,this.behaviors=new Map,this.modelUses=new Map,this.viewUses=new Map,this.externalNames=new Map,this.loadCache=null}createAvailableName(e,t){var s,i,a=this.moduleDefs.get(e);if(!a)return e;for([s,i]of this.moduleDefs)if(i.location===t&&i.name===e)return s;if(a.location===t)return e;var a=/([^0-9]+)([0-9]*)/.exec(e),r=a[1];let o=a[2];for(o=0===o.length?0:parseInt(o,10);;){var n=r+ ++o;if(!this.moduleDefs.get(n))return n}}lookup(e,t){if(!e)return null;e=this.modules.get(e);if(!e)return null;let s=e.actorBehaviors.get(t);return(s=s||e.pawnBehaviors.get(t))?(s.ensureBehavior(),s):null}hasBehavior(e,t){return!!e&&!(!(e=this.modules.get(e))||t&&!e.actorBehaviors.get(t)&&!e.pawnBehaviors.get(t))}loadStart(e){this.key=e,this.loadCache=[]}loadOne(e){this.key&&e.key===this.key&&this.loadCache.push(e.buf)}loadDone(e){this.key&&this.key===e&&(e=this.loadCache,this.loadCache=[],this.key=null,this.loadAll(e))}loadAll(s){if(s){var e=s.reduce((e,t)=>e+t.length,0),i=new Uint8Array(e);let t=0;for(let e=0;e<s.length;e++)i.set(s[e],t),t+=s[e].length;e=new TextDecoder("utf-8").decode(i),e=JSON.parse(e);this.loadLibraries(e),this.publish(this.sessionId,"triggerPersist")}else console.log("inconsistent message")}loadLibraries(e){let d=[],c=new Map,o;Constants.UserBehaviorDirectory&&(o=Constants.UserBehaviorDirectory.slice("behaviors/".length));let u,t=(Constants.SystemBehaviorDirectory&&(u=Constants.SystemBehaviorDirectory.slice("behaviors/".length)),e.forEach(n=>{let{action:e,name:t,systemModule:l,location:h}=n;if(h&&!h.startsWith("(detached)")){var s=h.lastIndexOf("/"),s=h.slice(0,s);if(o&&!s.startsWith(o)&&!s.startsWith(u))return}s=t;if(!e||"add"===e){var i={...n};delete i.action,Array.isArray(i.actorBehaviors)&&(i.actorBehaviors=new Map(i.actorBehaviors)),Array.isArray(i.pawnBehaviors)&&(i.pawnBehaviors=new Map(i.pawnBehaviors)),t=this.createAvailableName(s,h),c.set(s,t),this.externalNames.set(h+"$"+n.name,t),this.moduleDefs.set(t,i);let r={actorBehaviors:new Map,pawnBehaviors:new Map},o=this.modules.get(t);(o=o||ScriptingModule.create({name:i.name,systemModule:i.systemModule,location:h})).externalName=t,["actorBehaviors","pawnBehaviors"].forEach(s=>{var i,a;if(n[s])for([i,a]of n[s]){var e=this.externalNames.get(h+"$"+n.name);let t=this.lookup(e,i);if(t)t.code!==a&&(t.setCode(a),d.push(t));else{let e=h;h.startsWith("(detached):")&&(e=h.slice("(detached):".length)),(t=ScriptingBehavior.create({systemBehavior:l,module:o,name:i,location:e,type:s.slice(0,s.length-1)})).setCode(a),d.push(t)}r[s].set(i,t)}}),o.actorBehaviors=r.actorBehaviors,o.pawnBehaviors=r.pawnBehaviors,this.modules.set(o.externalName,o)}if("remove"===e)for(var[a,r]of this.modules)r.location===h&&(this.externalNameMap.delete(h),this.modules.delete(a),this.moduleDefs.delete(a))}),[]);return d.forEach(s=>{if(s.$behavior.setup)if("actorBehavior"===s.type){var e=this.modelUses.get(s);let t=this.service("ActorManager");e&&e.forEach(e=>{e=t.get(e);e&&s.future(0).invoke(e,"setup")})}else"pawnBehavior"===s.type&&t.push([s.module.externalName,s.$behaviorName])}),this.publish(this.id,"callViewSetupAll",t),c}save(t){let e=[...this.moduleDefs].filter(([,e])=>!e.systemModule);return t&&(e=(e=e.filter(([e])=>t.includes(e))).map(([e,t])=>{t={...t};function randomString(){return Math.floor(Math.random()*36**10).toString(36)}return t.location&&(t.location=`(detached):${randomString()}/`+randomString()),[e,t]})),new Map([...e])}modelUse(e,t){var s=e.id;let i=this.modelUses.get(t);i||(i=[],this.modelUses.set(t,i)),i.indexOf(s)<0&&(i.push(s),t.ensureBehavior(),t.$behavior.setup)&&t.future(0).invoke(e[isProxy]?e._target:e,"setup")}modelUnuse(e,t){var s=e.id,i=this.modelUses.get(t);!i||(s=i.indexOf(s))<0||(i.splice(s,1),t.$behavior&&t.$behavior.teardown&&t.future(0).invoke(e[isProxy]?e._target:e,"teardown"))}viewUse(e,t){var s=e.id;let i=this.viewUses.get(t);i||(i=[],this.viewUses.set(t,i)),i.indexOf(s)<0&&i.push(s),t.ensureBehavior(),t.$behavior.setup&&e.say("callSetup",t.module.externalName+"$"+t.$behaviorName)}viewUnuse(e,t){var s=e.id,i=this.viewUses.get(t);!i||(s=i.indexOf(s))<0||(i.splice(s,1),t.$behavior&&t.$behavior.teardown&&e.say("callTeardown",t.module.externalName+"$"+t.$behaviorName))}}BehaviorModelManager.register("BehaviorModelManager");class BehaviorViewManager extends ViewService{constructor(e){super(e||"BehaviorViewManager"),this.url=null,this.socket=null,this.status=!1,this.model=this.wellKnownModel("BehaviorModelManager"),this.subscribe(this.model.id,"callViewSetupAll","callViewSetupAll")}isConnected(){return this.socket&&this.socket.readyState===WebSocket.OPEN&&!0===this.status}destroy(){this.callback&&this.callback(!1),this.setURL(null),super.destroy()}setURL(e,t){if(this.callback=t,this.socket)try{this.socket.onmessage=null,this.socket.close()}finally{this.socket=null}e&&(this.url=e,this.socket=new WebSocket(e),this.socket.onmessage=e=>this.load(e.data),this.socket.onopen=e=>{console.log("connected"),this.status=!0,this.callback&&this.callback(!0)},this.socket.onclose=e=>{console.log("disconnected"),this.socket.onmessage=null,this.socket=null,this.status=!1,this.callback&&this.callback(!1)})}callViewSetupAll(e){e.forEach(e=>{let t=this.model.lookup(...e);e=this.model.viewUses.get(t);e&&e.forEach(e=>{e=GetPawn(e);e&&t.invoke(e,"setup")})})}load(e){let i;try{i=JSON.parse(e)}catch(e){return void console.error(e)}if(i&&Array.isArray(i)){let t=new Map,v=[],s=[],g=[],y=(window._allResolvers||(window._allResolvers=new Map),Date.now()+"_"+Math.random().toString()),r=new Map;window._allResolvers.set(y,r),i.forEach(a=>{if("add"===a.action){t.set(a.name,a.systemModule);let i=Math.random().toString();var e=new Promise((e,t)=>{r.set(i,e);var e=document.createElement("script"),s=(g.push(e),e.type="module",URL.createObjectURL(new Blob([a.content],{type:"application/javascript"})));e.innerHTML=`
import * as data from "${s}";
let map = window._allResolvers.get("${y}");
if (map) {map.get("${i}")({data, key: ${y}, name: "${a.name}"});}
`,document.body.appendChild(e),v.push(s)}).catch(e=>(console.log(e),null));s.push(e)}}),Promise.all(s).then(async t=>{if(v.forEach(e=>URL.revokeObjectURL(e)),g.forEach(e=>e.remove()),0!==(t=t.filter(e=>e)).length){var e=[...window._allResolvers.keys()],s=e.indexOf(y);if(window._allResolvers.delete(y),s===e.length-1){let i=new CodeLibrary;t.forEach(e=>{var t=e.name.lastIndexOf("."),t=e.name.slice(0,t),s=e.name.startsWith("croquet");if(!e||checkModule(e.data))throw new Error("a behavior file does not export an array of modules");i.add(e.data.default,t,s)});var a,r,o=[],n=Math.random();for([a,r]of i.modules){var{actorBehaviors:l,pawnBehaviors:h,name:d,location:c,systemModule:u}=r;o.push({name:d,systemModule:u,location:c,actorBehaviors:[...l],pawnBehaviors:[...h]})}var s=JSON.stringify(o),p=(new TextEncoder).encode(s);let e=0;this.publish(this.model.id,"loadStart",n);for(var m=8e4<p.length;e<p.length;){var f=p.slice(e,e+2880);this.publish(this.model.id,"loadOne",{key:n,buf:f}),e+=2880,m&&await new Promise(e=>{setTimeout(e,5)})}this.publish(this.model.id,"loadDone",n)}}})}else console.log("not an array")}}class CodeLibrary{constructor(){this.modules=new Map,this.functions=new Map,this.classes=new Map}add(e,r,o){e.modules&&e.modules.forEach(e=>{var{name:e,actorBehaviors:t,pawnBehaviors:s}=e;let i=new Map,a=new Map;t&&t.forEach(e=>{i.set(e.name,e.toString())}),s&&s.forEach(e=>{a.set(e.name,e.toString())});t=r+"$"+e,s=this.modules.get(t);s&&console.log(`a module ${e} is defined in ${r} and `+s.location),this.modules.set(t,{name:e,location:r,actorBehaviors:i,pawnBehaviors:a,systemModule:o})}),e.functions&&e.functions.forEach(e=>{var t=e.name,e=`return ${e.toString()};`;this.functions.set(t,e)}),e.classes&&e.classes.forEach(e=>{var t=e.name;this.classes.set(t,e)})}addModules(e){if(e)for(var[t,s]of e)this.modules.set(t,s)}get(e){return this.modules.get(e)}delete(e){this.modules.delete(e)}}function checkModule(e){if(!e||!e.default||!e.default.modules)throw new Error("a behavior file does not export an array of modules");e=e.default.modules;if(!Array.isArray(e))throw new Error("a behavior file does not export an array of modules");e.forEach(e=>{let t=!0;e.name||(t=!1),e.actorBehaviors&&!Array.isArray(e.actorBehaviors)&&(t=!1),e.pawnBehaviors&&!Array.isArray(e.pawnBehaviors)&&(t=!1);e={...e};if(delete e.name,delete e.actorBehaviors,delete e.pawnBehaviors,!(t=0<Object.keys(e).length?!1:t))throw new Error("a behavior file exports a malformed behavior module")})}},5758:(e,t,s)=>{"use strict";s.d(t,{h:()=>DolbyChatManager});var r=s(4200);let o=!1,n=null,i=null;async function getAccessToken(){var e=await fetch("https://us-central1-dolby-croquet.cloudfunctions.net/generateToken"),e=(console.log("Dolby token generated"),await e.json());return e.token}class DolbyChatManager extends r.ViewService{constructor(e){super(e||"DolbyChatManager"),i=this,window.dolbyPromise||(window.dolbyPromise=new Promise(t=>{var e=document.createElement("script");e.setAttribute("src","https://unpkg.com/@voxeet/voxeet-web-sdk"),e.onload=async()=>{console.log("initialize Dolby SDK");var e=await getAccessToken();VoxeetSDK.initializeToken(e,getAccessToken),this.addConferenceEventHandlers(),t()},document.body.appendChild(e)})),this.subscribe("playerManager","enter","playerEnter"),this.subscribe("playerManager","leave","playerLeave"),this.sessionP=null,this.joinState="left",this.initChatUI(),this.initAudio();e=this.localPlayer,e=e&&e.inWorld;e&&this.prepareSession(),console.log(`DolbyChatManager (local actor ${e?"already":"not yet"} here)`,this)}get localPlayer(){return this.model.service("PlayerManager").players.get(this.viewId)}initChatUI(){let e=document.getElementById("chatHolder");var t;e||((t=document.createElement("div")).innerHTML=`<div id='chatHolder' class='hidden hide-settings unconnected'>
    <div id='chatUI'>
        <div id='chatState' class='noselect'>
            <!-- <div id='worldName'></div> -->
            <div id='chatSymbol'></div>
            <div id='peopleSymbol'></div>
            <div id='chatCount' class='noselect'><span id='chatCountText'>-</span></div>
        </div>
        <div id='chatButtons'>
            <div id='toggleConnection' tabindex='4'>
                <div class='buttonImage joined' title='leave call'></div>
                <div class='buttonImage notJoined' title='join call'></div>
                <div id='connection-tooltip' class='bouncing'>
                    <div id='connection-tooltip-arrow'></div>
                    <div id='connection-tooltip-contents' class='noselect'>join call</div>
                </div>
            </div>
            <div id='toggleAudio' tabindex='1'>
                <div class='buttonImage enabled' title='mute mic'></div>
                <div class='buttonImage disabled' title='unmute mic'></div>
                <div class='buttonImage unavailable' title='mic unavailable'></div>
            </div>
            <div id='toggleSettings' tabindex='4'>
                <div class='buttonImage enabled' title='hide settings'></div>
                <div class='buttonImage disabled' title='show settings'></div>
            </div>
        </div>
    </div>
    <div id='settings'>
        <div id='local'>
            <audio playsinline autoplay></audio>
        </div>
        <div id='loudness'>
            <div class='bar'>
                <div class='max'></div>
                <div class='value'></div>
            </div>
        </div>
        <div id='settingsButtons'>
            <span class='settingsText noselect'>Audio Source</span>
            <select id='audioInputs' title='Select Audio Source'></select>
            <div id='toggleMicrophoneTest'></div>
        </div>
    </div>
</div>
`,e=t.firstChild,document.body.appendChild(e),document.getElementById("toggleConnection").addEventListener("click",()=>this.toggleConnection()),document.getElementById("toggleAudio").addEventListener("click",()=>this.toggleAudio()),document.getElementById("toggleSettings").addEventListener("click",()=>this.toggleSettings()),document.getElementById("toggleMicrophoneTest").addEventListener("click",()=>this.toggleMicrophoneTest()),document.getElementById("audioInputs").addEventListener("input",()=>this.setAudioInput()),navigator.mediaDevices.addEventListener("devicechange",()=>this.updateAudioInputs()),o&&e.classList.add("mute-audio")),this.elements={chatHolder:e,toggleAudio:document.getElementById("toggleAudio"),audioInputs:document.getElementById("audioInputs"),localAudio:document.querySelector("#local > audio"),toggleMicrophoneTest:document.getElementById("toggleMicrophoneTest"),loudness:document.querySelector("#loudness"),loudnessBar:document.querySelector("#loudness .bar"),loudnessMax:document.querySelector("#loudness .max"),loudnessValue:document.querySelector("#loudness .value")},this.uiStyles={preConnect:{width:"216px",height:"50px",transform:"translate(-116px, 0px)"},connected:{width:"216px",height:"50px",transform:"translate(-116px, 0px)"},settings:{width:"216px",height:"188px",transform:"translate(-116px, 0px)"}},this.setUIStyle("preConnect"),e.classList.remove("hidden")}setUIStyle(e){var e=this.uiStyles[e],t=window.innerWidth<600;e.left=t?"60%":"",e.top=t?"60px":"",Object.assign(this.elements.chatHolder.style,e)}toggleConnection(){this.resumeAudioContextIfNeeded();var e=Date.now();e-(this.lastToggle||0)<2e3||"joining"===this.joinState||"leaving"===this.joinState||(this.lastToggle=e,"left"===this.joinState?this.joinConference():this.leaveConference())}toggleAudio(){o?this.unmuteChatAudio():this.muteChatAudio()}toggleSettings(){this.resumeAudioContextIfNeeded(),this.elements.chatHolder.classList.toggle("hide-settings"),this.setUIStyle(this.elements.chatHolder.classList.contains("hide-settings")?"connected":"settings")}toggleMicrophoneTest(){this.elements.chatHolder.classList.contains("testing-microphone")?this.stopTestingMicrophone():this.testMicrophone()}computeSessionHandles(){var e=e=>r.Data.hash(e).slice(0,8),t=this.session.persistentId,s=this.sessionId;return{persistent:e(t),ephemeral:e(s)}}addConferenceEventHandlers(){VoxeetSDK.conference.on("streamAdded",(e,t)=>{console.log("stream added for "+e.info.name),i&&i.updateActiveInChat()}),VoxeetSDK.conference.on("streamUpdated",(e,t)=>{console.log("stream updated for "+e.info.name),i&&i.updateActiveInChat()}),VoxeetSDK.conference.on("streamRemoved",(e,t)=>{console.log("stream removed for "+e.info.name),i&&i.updateActiveInChat()}),VoxeetSDK.conference.on("left",async()=>{console.log("participant has left Dolby conference.")})}prepareSession(){return this.sessionP||(this.sessionP=new Promise(async t=>{console.log("open Dolby session");var e=Date.now();await window.dolbyPromise;const s=Date.now()-e;s<1e3&&await new Promise(e=>setTimeout(e,1e3-s));e=this.localPlayer._name;try{await VoxeetSDK.session.open({name:e}),console.log("Dolby session for participant "+e),t(!0)}catch(e){console.error(e),t(!1)}})),this.sessionP}async createConference(){console.log("create Dolby conference");var{persistent:e,ephemeral:t}=this.computeSessionHandles(),e={alias:e.slice(0,8)+":"+t.slice(0,8),params:{audioOnly:!0,spatialAudioStyle:"shared"}};let s=null;try{s=await VoxeetSDK.conference.create(e)}catch(e){console.error(e)}return s}async joinConference(){this.joinState="joining";var e=await this.prepareSession()&&await this.createConference();if(e){this.elements.chatHolder.classList.add("joining"),console.log("join Dolby conference");try{await VoxeetSDK.conference.join(e,{spatialAudio:!0,constraints:{audio:!0,video:!1}}),await this.setAudioInput(),o&&await VoxeetSDK.conference.mute(VoxeetSDK.session.participant,!0),this.joinState="joined",this.elements.chatHolder.classList.remove("unconnected"),this.startTestingAudioLevel(),this.updateActiveInChat();var t={x:1,y:0,z:0},s={x:0,y:1,z:0},i={x:0,y:0,z:1},a={x:6,y:6,z:6};VoxeetSDK.conference.setSpatialEnvironment(a,i,s,t),this.setMyPosition()}catch(e){console.error(e),this.joinState="left"}this.elements.chatHolder.classList.remove("joining")}else this.joinState="left"}async leaveConference(){console.log("Leave Dolby conference");var e=this.joinState;if(this.joinState="leaving",this.sessionP=null,this.myLastPosition=null,this.elements.chatHolder.classList.add("unconnected"),this.stopTestingMicrophone(),this.stopTestingAudioLevel(),this.elements.chatHolder.classList.contains("hide-settings")||this.toggleSettings(),"joined"===e)try{await VoxeetSDK.conference.leave()}catch(e){console.error(e)}if(VoxeetSDK.session.isOpen())try{await VoxeetSDK.session.close(),console.log("Dolby session closed")}catch(e){console.error(e)}this.joinState="left",this.updateActiveInChat()}setMyPosition(){if("joined"===this.joinState){var t,s,{_translation:i,_rotation:a}=this.localPlayer;let e=!0;this.myLastPosition&&({pos:t,rot:s}=this.myLastPosition,e=!(0,r.v3_equals)(t,i)||!(0,r.q_equals)(s,a)),this.myLastPosition={pos:i,rot:a},e&&([t,s,i]=i,t={x:t,y:s,z:i},s={x:0,y:180*(0,r.q_yaw)(a)/Math.PI,z:0},VoxeetSDK.conference.setSpatialPosition(VoxeetSDK.session.participant,t),VoxeetSDK.conference.setSpatialDirection(VoxeetSDK.session.participant,s)),this.future(500).setMyPosition()}}playerEnter(e){e.playerId!==this.viewId?this.updateActiveInChat():(console.log("our player entered"),this.prepareSession())}playerLeave(e){this.updateActiveInChat(),e.playerId===this.viewId&&(console.log("our player left"),this.leaveConference())}updateActiveInChat(){var e,t=document.getElementById("chatCountText");"joined"===this.joinState?(e=Array.from(VoxeetSDK.conference.participants.values()).filter(e=>e.audioTransmitting).map(e=>e.info.name).sort(),this.lastInChat?.length===e.length&&!e.some((e,t)=>this.lastInChat[t]!==e)||(this.lastInChat=e,t.textContent=String(e.length),t.setAttribute("title",e.join("\n")))):(t.textContent="-",t.setAttribute("title",""))}async initAudio(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=1,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=4096,this.byteTimeDomainData=new Uint8Array(this.analyser.fftSize),this.gainNode.connect(this.analyser),this.testAudioNode=this.audioContext.createMediaStreamDestination(),this.elements.localAudio.srcObject=this.testAudioNode.stream,this.gainNode.connect(this.testAudioNode),this.elements.localAudio.muted=!0,await window.dolbyPromise,await this.updateAudioInputs(),this.resumeAudioContextIfNeeded()}resumeAudioContextIfNeeded(){"running"!==this.audioContext.state&&"closed"!==this.audioContext.state&&(console.log("attempting to resume audioContext"),this.audioContext.resume())}stopStream(e){e&&e.getTracks().forEach(e=>e.stop())}stopAudioStream(){this.measurableAudioStream&&(this.stopStream(this.measurableAudioStream),delete this.measurableAudioStream),this.measurableAudioStreamSource&&(this.measurableAudioStreamSource.disconnect(),delete this.measurableAudioStreamSource)}updateAudioInputs(){if(this._updateAudioInputsPromise)return this._updateAudioInputsPromise;var e=this.elements.audioInputs.selectedOptions[0];const i=e&&e.label||this.chatAudioTrack&&this.chatAudioTrack.label||n;let a=!!i,r;const o=this.elements.audioInputs;o.innerHTML="";e=document.createElement("optgroup"),e.disabled=!0,e.selected=!1,e.label="Select Microphone",o.appendChild(e),e=this._updateAudioInputsPromise=VoxeetSDK.mediaDevice.enumerateAudioInputDevices().then(e=>{e.forEach(e=>{var t,{deviceId:e,label:s}=e;"default"!==e&&"communications"!==e&&((t=a&&i===s)&&(a=!1),s=new Option(s,e,t,t),r=r||s,o.appendChild(s))}),a&&r&&(console.warn(`previous device "${i}" is gone; switching to "${r.label}"`),o.value=r.value,this.mediaStarted)&&this.setAudioInput()}).catch(e=>{console.error("error in updateAudioInputs",e)}).finally(()=>{delete this._updateAudioInputsPromise});return e}setAudioInput(i){if(this._setAudioInputPromise)return this._setAudioInputPromise;var e=this.elements.audioInputs.selectedOptions[0];if(!e)return console.warn("no audio selections available"),Promise.resolve();const a=e.value;var e=e.label,t=this.chatAudioTrack;if(!i&&t&&t.label===e&&"live"===t.readyState)return console.log("audio stream already matches selection"),Promise.resolve();n=e;let s;t=!navigator.userAgent.match(/\biPad\b/)||!this.chatAudioStream,s=t?(console.log(`getUserMedia with device ID "${a}"`),navigator.mediaDevices.getUserMedia({audio:{deviceId:a}})):(console.log("not invoking getUserMedia"),Promise.resolve(this.chatAudioStream)),e=this._setAudioInputPromise=s.then(e=>{var t=e.getAudioTracks()[0],s=this.chatAudioTrack;i||t!==s?(this.chatAudioStream=e,(this.chatAudioTrack=t).onmute=()=>{console.log("audio track muted itself")},t.onunmute=()=>{console.log("audio track unmuted itself")},t.onended=e=>{console.warn("audio track ended"),this.setAudioInput(!0)},s=e.clone(),this.stopAudioStream(),this.measurableAudioStream=s,(t=this.audioContext.createMediaStreamSource(s)).connect(this.gainNode),this.measurableAudioStreamSource=t,s.getAudioTracks()[0].onended=()=>console.log("local subsidiary audio track ended unexpectedly"),VoxeetSDK.mediaDevice.selectAudioInput(a).then(e=>{console.log(e)}),this.elements.toggleAudio.classList.remove("error"),this.mediaStarted=!0):console.warn("same audio track found; no replacement needed")}).catch(e=>{console.warn(`setAudioInput failed for id ${a}: `+e),this.elements.toggleAudio.classList.add("error")}).finally(()=>{delete this._setAudioInputPromise});return e}async muteChatAudio(){console.log("muting local audio"),await this.ensureAudioMuteState(!0)}async unmuteChatAudio(){console.log("unmuting local audio"),this.stopTestingMicrophone(),await this.ensureAudioMuteState(!1)}async ensureAudioMuteState(e){o!==e&&(await VoxeetSDK.conference.mute(VoxeetSDK.session.participant,e),o=e,this.elements.chatHolder.classList.toggle("mute-audio",e))}startTestingAudioLevel(){this._testAudioInterval=100,this._testAudioLevelIntervalId=window.setInterval(this.testAudioLevel.bind(this),this._testAudioInterval)}testAudioLevel(){var e,t=this.getLocalAudioLevel();!this.elements.chatHolder.classList.contains("hide-settings")&&this.measurableAudioStream&&((void 0===this._maxAudioLevelLongTerm||t>this._maxAudioLevelLongTerm)&&(this._maxAudioLevelLongTerm=t,window.clearTimeout(this._maxAudioLevelLongTermTimeoutId),this._maxAudioLevelLongTermTimeoutId=window.setTimeout(()=>{delete this._maxAudioLevelLongTerm,delete this._maxAudioLevelLongTermTimeoutId,this.elements.loudnessMax.style.bottom="",this.elements.loudnessMax.style.left=""},1500),e=getComputedStyle(this.elements.loudnessBar)["flexDirection"],e.includes("row")?(this.elements.loudnessMax.style.left=94*t+"%",this.elements.loudnessMax.style.bottom="-3px"):(this.elements.loudnessMax.style.left="-1px",this.elements.loudnessMax.style.bottom=94*t+"%")),void 0===this._maxAudioLevelShortTerm||t>this._maxAudioLevelShortTerm)&&(this._maxAudioLevelShortTerm=t,window.clearTimeout(this._maxAudioLevelShortTermTimeoutId),this._maxAudioLevelShortTermTimeoutId=window.setTimeout(()=>{delete this._maxAudioLevelShortTerm,delete this._maxAudioLevelShortTermTimeoutId,this.elements.loudnessValue.style.flex=0,this.elements.loudnessValue.style.backgroundColor="green"},100),this.elements.loudnessValue.style.flex=t,this.elements.loudnessValue.style.backgroundColor=`hsl(${120*(1-t**2)}, 100%, 50%)`)}stopTestingAudioLevel(){this._testAudioLevelIntervalId&&(window.clearInterval(this._testAudioLevelIntervalId),delete this._testAudioLevelIntervalId)}getLocalAudioLevel(){var t=this.byteTimeDomainData,s=(this.analyser.getByteTimeDomainData(t),this.analyser.fftSize);let i,a=0;for(let e=0;e<s;e+=19)i=t[e],i=Math.abs(i-128),a=Math.max(a,i);return a/=128}testMicrophone(){this.elements.localAudio.paused&&this.elements.localAudio.play(),o||this.muteChatAudio(),this.elements.localAudio.muted=!1,this.elements.chatHolder.classList.add("testing-microphone")}stopTestingMicrophone(){this.elements.localAudio.muted=!0,this.elements.chatHolder.classList.remove("testing-microphone")}destroy(){console.log("DolbyChatMgr: destroy"),this.stopTestingAudioLevel();try{this.leaveConference().then(()=>this.elements.chatHolder.remove())}catch(e){}i=null,super.destroy()}}},3917:(e,t,s)=>{"use strict";s.r(t),s.d(t,{addShellListener:()=>addShellListener,frameId:()=>a,frameName:()=>function frameName(){return`frame["${r}",${a}${i?",primary":""}]`},isPrimaryFrame:()=>i,removeShellListener:()=>function removeShellListener(e){n.delete(e)},sendToShell:()=>sendToShell,worldName:()=>r});let i;const a=new URL(window.location.href).searchParams.get("portal"),r=new URL(window.location.href).searchParams.get("world")||"default";const o="croquet:microverse:";function sendToShell(e,t){window.parent.postMessage({message:o+e,...t},"*")}const n=new Set;function addShellListener(e){n.add(e)}window.addEventListener("message",t=>{if(t.source===window.parent){var e=t.data["message"];if("string"==typeof e&&e.startsWith(o)){const s=e.slice(o.length);n.forEach(e=>e(s,t.data))}}});n.add((e,t)=>{"frame-type"===e&&(e=t["frameType"],t="primary"===e,i!==t)&&(i=t,document.body.style.background="transparent",document.getElementById("hud").classList.toggle("primary-frame",i),i&&window.focus(),sendToShell("frame-ready",{frameType:e}))})},7112:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{startMicroverse:()=>startMicroverse});var _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4200),_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(5679),_physics_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(6590),_dolbyChat_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(5758),_text_text_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(4355),_card_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(3654),_avatar_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(8858),_walkManager_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(8335),_frame_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(3917),_code_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(6946),_portal_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(1246),_worldSaver_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(4072),_settingsMenu_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(5072),_apps_multiblaster_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(3128),jszip__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(5733),jszip__WEBPACK_IMPORTED_MODULE_14___default=__webpack_require__.n(jszip__WEBPACK_IMPORTED_MODULE_14__),fflate__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__(3778),_wcAssetManager_js__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__(9087);const defaultAvatarNames=["newwhite","madhatter","marchhare","queenofhearts","cheshirecat","alice"],defaultSystemBehaviorDirectory="behaviors/croquet",defaultSystemBehaviorModules=["avatarEvents.js","billboard.js","elected.js","menu.js","pdfview.js","physics.js","rapier.js","scrollableArea.js","singleUser.js","stickyNote.js","halfBodyAvatar.js","propertySheet.js","dragAndDrop.js","gizmo.js"];let AA=!0;async function getAntialias(){var e=new URL(window.location).searchParams.get("AA");if(e)return"true"===e?(console.log("antialias is true, urlOption AA is set"),!0):(console.log("antialias is false, urlOption AA is unset"),!1);let t=!0;var e=navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome"),s=(e&&(t=!1),navigator.userAgent.includes("Firefox")),i=(s&&(t=!1),!!("ontouchstart"in window));i&&(t=!1);try{var a=await navigator.xr.isSessionSupported("immersive-vr");a&&(t=a)}catch(e){}return console.log(`antialias is ${t}, mobile: ${i}, browser: `+(s?"Firefox":e?"Safari":"Other Browser")),t}function loadLoaders(){return window.JSZip=jszip__WEBPACK_IMPORTED_MODULE_14___default(),window.fflate=fflate__WEBPACK_IMPORTED_MODULE_16__,window.THREE=_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE,Promise.resolve(_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE)}function basenames(){var e=window.location.origin+window.location.pathname,t=/([^/]+)\.html$/.exec(e);let s=new URL(window.location).searchParams.get("world");s=s||(t&&"index"!==t[1]?t[1]:"default");let i;return{baseurl:i=t?e.slice(0,t.index):(t=e.lastIndexOf("/"),e.slice(0,t+1)),basename:s}}function loadInitialBehaviors(paths,directory){let library=_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library||new _code_js__WEBPACK_IMPORTED_MODULE_9__.Un;if(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library=library,paths&&directory){let{baseurl,_pathname}=basenames();if(!directory)throw new Error("directory argument has to be specified. It is a name for a sub directory name under the ./behaviors directory.");let isSystem=directory===_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory,root=window.microverseDir||baseurl,promises=paths.map(path=>{if(isSystem){let modulePath=directory.split("/")[1]+"/"+path,code=`import('${root}behaviors/${modulePath}')`;return eval(code).then(e=>[modulePath,e])}{let code=`import('${root}${directory}/${path}')`;return eval(code).then(e=>{let t=directory.slice("behaviors".length);return[(""===(t="/"===t[0]?t.slice(1):t)?"":t+"/")+path,e]})}});return Promise.all(promises).then(e=>(e.forEach(e=>{var[e,t]=e,s=e.lastIndexOf("."),e=e.slice(0,s);(0,_code_js__WEBPACK_IMPORTED_MODULE_9__.OO)(t),library.add(t.default,e,isSystem)}),!0))}}console.log("%cTHREE.REVISION:","color: #f00",_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE.REVISION);class MyPlayerManager extends _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.PlayerManager{init(e){super.init(e),this.avatarCount=0,this.presentationMode=null,this.followers=new Set,this.subscribe("playerManager","create",this.playerCreated),this.subscribe("playerManager","details",this.playerDetails),this.subscribe("playerManager","destroy",this.playerDestroyed),this.subscribe("playerManager","enter",this.playerEnteredWorld),this.subscribe("playerManager","leave",this.playerLeftWorld)}get presenter(){return this.players.get(this.presentationMode)}createPlayer(e){var t=this.avatarCount%_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.AvatarNames.length,s=(this.avatarCount++,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.AvatarNames[t]);console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"MyPlayerManager",this.avatarCount);let i={...e,noSave:!0,type:"3d",singleSided:!0};return i="string"==typeof s?{...i,name:s,dataScale:[.3,.3,.3],dataRotation:(0,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.q_euler)(0,Math.PI,0),dataTranslation:[0,-.4,0],dataLocation:`./assets/avatars/${s}.zip`,avatarType:"wonderland",type:"initial"}:{...i,avatarType:"custom",avatarIndex:t,...s},_avatar_js__WEBPACK_IMPORTED_MODULE_6__.b.create(i)}playerDetails({playerId:e,details:t}){e=this.players.get(e);e&&e.setAndPublish(t)}destroyPlayer(e){e.inWorld&&e.setAndPublish({inWorld:!1}),super.destroyPlayer(e)}playerInWorldChanged(e){e.inWorld?this.publish("playerManager","enter",e):this.publish("playerManager","leave",e)}playersInWorld(){return[...this.players.values()].filter(e=>e.inWorld)}startPresentation(e,t=null){if(!this.presentationMode||this.presentationMode===e){this.presentationMode=e;for(const s of this.playersInWorld())t&&s.presenterToken!==t||(t&&s.playerId===e||delete s.presenterToken,this.followers.add(s.playerId));this.publish("playerManager","presentationStarted"),this.publish("playerManager","playerCountChanged")}}addFollower(e){this.followers.add(e)}stopPresentation(){this.presentationMode=null,this.publish("playerManager","presentationStopped"),this.publish("playerManager","playerCountChanged"),this.followers.clear()}leavePresentation(e){this.presentationMode!==e&&(this.followers.delete(e),this.publish("playerManager","playerCountChanged"))}continuePresenting(e,t){this.presentationMode?console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"continuePresenting rejected due to presentation in progress"):(console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"continuePresenting",e.id,t),e.presenterToken=t,this.startPresentation(e.playerId,t))}continueFollowing(e,t){this.presentationMode&&this.presenter.presenterToken===t?(console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"continueFollowing",this.presenter.id,t),this.followers.add(e.playerId),e.presentationStarted(),this.publish("playerManager","playerCountChanged")):(e.presenterToken=t,console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"continueFollowing: expected presenter not presenting",t))}playerEnteredWorld(e){console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"playerEnteredWorld",e),this.publish("playerManager","playerCountChanged")}playerLeftWorld(e){console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.frameName)(),"playerLeftWorld",e),e.playerId===this.presentationMode&&this.stopPresentation(),delete e.presenterToken,this.followers.delete(e.playerId),e._inChat&&e.setAndPublish({inChat:!1}),this.publish("playerManager","playerCountChanged")}playerCreated(e){this.publish("playerManager","playerCountChanged")}playerDestroyed(e){this.publish("playerManager","playerCountChanged")}}MyPlayerManager.register("MyPlayerManager");class MyModelRoot extends _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.ModelRoot{static modelServices(){return[MyPlayerManager,_card_js__WEBPACK_IMPORTED_MODULE_5__.q7,_code_js__WEBPACK_IMPORTED_MODULE_9__.IL,_text_text_js__WEBPACK_IMPORTED_MODULE_4__.NC,_physics_js__WEBPACK_IMPORTED_MODULE_2__.PhysicsManager]}init(e,t){super.init(e);e=this.service("MicroverseAppManager");e.add(_apps_multiblaster_js__WEBPACK_IMPORTED_MODULE_13__.q),e.add(_text_text_js__WEBPACK_IMPORTED_MODULE_4__.T0),e.add(_portal_js__WEBPACK_IMPORTED_MODULE_10__.Q),this.ensurePersistenceProps(),this.subscribe(this.sessionId,"triggerPersist","triggerPersist"),this.subscribe(this.sessionId,"setPersistentDataFlag","setPersistentDataFlag"),this.subscribe(this.sessionId,"addBroadcaster","addBroadcaster"),this.subscribe(this.id,"loadStart","loadStart"),this.subscribe(this.id,"loadOne","loadOne"),this.subscribe(this.id,"loadDone","loadDone"),this.subscribe(this.id,"removeAll","removeAll"),t?(console.log("loading persistent data"),this.loadPersistentData(t)):(this.loadBehaviorModules(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library.modules,"1"),this.load(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.DefaultCards,"1"))}ensurePersistenceProps(){this.persistPeriod||(this.persistPeriod=6e4),void 0===this.lastPersistTime&&(this.lastPersistTime=0),void 0===this.persistRequested&&(this.persistRequested=!1)}loadPersistentData({version:e,data:t}){try{delete this.loadingPersistentDataErrored,this.loadingPersistentData=!0;var s,i,a=new _worldSaver_js__WEBPACK_IMPORTED_MODULE_11__.H(_card_js__WEBPACK_IMPORTED_MODULE_5__.Z4).parse(JSON.stringify(t)),r=_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library,o=new Map;for([s,i]of r.modules)i.systemModule&&o.set(s,i);this.loadBehaviorModules(o,e),this.loadBehaviorModules(a.behaviorModules,e),a.cards&&this.load(a.cards,e)}catch(e){console.error("error in loading persistent data",e),this.loadingPersistentDataErrored=!0}finally{delete this.loadingPersistentData}}savePersistentData(){this.loadingPersistentData||this.loadingPersistentDataErrored||(this.lastPersistTime=this.now(),this.persistSession(()=>this.saveData()))}saveData(){var e=this.sessionName||"Unknown",t=new _worldSaver_js__WEBPACK_IMPORTED_MODULE_11__.H(_card_js__WEBPACK_IMPORTED_MODULE_5__.Z4),s=t.save(this),t=t.stringify(s);return{name:e,version:"1",data:JSON.parse(t)}}loadBehaviorModules(e,t){return"1"===t?this.service("BehaviorModelManager").loadLibraries([...e.values()]):null}load(e,t){if("1"===t)return _card_js__WEBPACK_IMPORTED_MODULE_5__.Z4.load(e,this,t)}setPersistentDataFlag(e){this.persistentDataDisabled=!e,console.log("persistentData: "+(this.persistentDataDisabled?"disabled":"enabled"))}triggerPersist(){var e=this.now(),t=e-this.lastPersistTime,s=this.persistPeriod;t<s?this.persistRequested||(this.persistRequested=!0,this.future(s-t).triggerPersist()):(this.lastPersistTime=e,this.persistRequested=!1,this.persistentDataDisabled||this.savePersistentData())}addBroadcaster(e){e=this.service("PlayerManager").player(e);e&&(e.broadcaster=!0),this.broadcastMode||(this.broadcastMode=!0,this.publish(this.sessionId,"broadcastModeEnabled"))}loadStart(e){this.loadKey=e,this.loadBuffer=[]}loadOne(e){var{key:e,buf:t}=e;e===this.loadKey&&this.loadBuffer.push(t)}loadDone(e){var{key:e,asScene:s,pose:i}=e;if(e===this.loadKey){var a=this.loadBuffer;if(this.loadBuffer=[],this.loadKey=null,a){var e=a.reduce((e,t)=>e+t.length,0),r=new Uint8Array(e);let t=0;for(let e=0;e<a.length;e++)r.set(a[e],t),t+=a[e].length;var o,e=new TextDecoder("utf-8").decode(r),e=JSON.parse(e);"1"===e.version&&(o=JSON.stringify(e.data),e.data=o,this.loadFromFile(e,s,i))}else console.log("inconsistent message")}}removeAll(){}loadFromFile({version:e,data:t},s,i){try{var a,r=new _worldSaver_js__WEBPACK_IMPORTED_MODULE_11__.H(_card_js__WEBPACK_IMPORTED_MODULE_5__.Z4).parse(t),o=this.loadBehaviorModules(r.behaviorModules,e);r.cards&&(a=this.load({array:r.cards,nameMap:s?null:o},e),i)&&a.forEach(e=>{e.parent||(e._translation=i.translation,e._rotation=i.rotation)})}catch(e){console.error("error in loading persistent data",e)}}}function setupBroadcastMode(e){var t="true"===new URLSearchParams(window.location.search).get("broadcastMode");return e.broadcastMode&&!t&&(e.__realm.vm.controller.sessionSpec.viewOnly=!0),t}MyModelRoot.register("MyModelRoot");class MyViewRoot extends _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.ViewRoot{static viewServices(){var e=[_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.InputManager,{service:_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.ThreeRenderManager,options:{useBVH:!0,antialias:AA}},_wcAssetManager_js__WEBPACK_IMPORTED_MODULE_15__.m,_text_text_js__WEBPACK_IMPORTED_MODULE_4__.WK,_text_text_js__WEBPACK_IMPORTED_MODULE_4__.Ax,_text_text_js__WEBPACK_IMPORTED_MODULE_4__.N2,_code_js__WEBPACK_IMPORTED_MODULE_9__.ui,_walkManager_js__WEBPACK_IMPORTED_MODULE_7__.R];return window.settingsMenuConfiguration?.voice&&e.push(_dolbyChat_js__WEBPACK_IMPORTED_MODULE_3__.h),e}constructor(e){var t=setupBroadcastMode(e),s=(super(e),this.service("ThreeRenderManager")),i=s.renderer;window.scene=s.scene,this.service("FontViewManager").setModel(e.service("FontModelManager")),i.toneMapping=_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE.ReinhardToneMapping,i.toneMappingExposure=2.5,i.shadowMap.enabled=!0,i.localClippingEnabled=!0,this.setAnimationLoop(this.session),t&&this.publish(this.sessionId,"addBroadcaster",this.viewId),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ShowCaseSpec&&!e.persistentDataDisabled&&this.publish(this.sessionId,"setPersistentDataFlag",!1)}detach(){console.log("ViewRoot detached"),super.detach()}setAnimationLoop(s){this.service("ThreeRenderManager").renderer.setAnimationLoop((e,t)=>{t&&s.step(e)})}}function deleteParameter(e,t){e=new URL(e,location.href);return e.searchParams.delete(t),e.toString()}let resolveConfiguration=null;function startWorld(e,t){let s={name:e.name||_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.autoSession(),password:e.password||_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.autoPassword(),model:MyModelRoot,view:MyViewRoot,tps:30,eventRateLimit:60,options:{world:t},...e,flags:["microverse"]};return _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.sessionURL=deleteParameter(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.sessionURL,"portal"),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.sessionURL=deleteParameter(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.sessionURL,"broadcastMode"),loadLoaders().then(()=>loadInitialBehaviors(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory)).then(()=>loadInitialBehaviors(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.UserBehaviorModules,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.UserBehaviorDirectory)).then(()=>(0,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.StartWorldcore)(s)).then(e=>{e.view.setAnimationLoop(e);e=basenames().baseurl,e=window.microverseDir||e;return fetch(e+"meta/version.txt")}).then(e=>(""+e.status).startsWith("2")?e.text():"(version not found)").then(e=>{console.log(`
Croquet Microverse
${e}
https://croquet.io`.trim())})}function isRunningLocalNetwork(){let t=window.location.hostname;/^\[.*\]$/.test(t)&&(t=t.slice(1,t.length-1));var s=[/^localhost$/,/^.*\.local$/,/^.*\.ngrok.io$/,/^(::ffff:)?10(?:\.\d{1,3}){3}$/,/^(::ffff:)?127(?:\.\d{1,3}){3}$/,/^(::f{4}:)?169\.254\.([1-9]|1?\d\d|2[0-4]\d|25[0-4])\.\d{1,3}$/,/^(::ffff:)?(172\.1[6-9]|172\.2\d|172\.3[01])(?:\.\d{1,3}){2}$/,/^(::ffff:)?192\.168(?:\.\d{1,3}){2}$/,/^f[cd][\da-f]{2}(::1$|:[\da-f]{1,4}){1,7}$/,/^fe[89ab][\da-f](::1$|:[\da-f]{1,4}){1,7}$/,/^::1$/];for(let e=0;e<s.length;e++)if(s[e].test(t))return!0;return!1}function startMicroverse(){let t=t=>{["usersComeHereBtn","homeBtn","worldMenuBtn"].forEach(e=>{e=document.querySelector("#"+e);e&&(e.style.display=t)})};(0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.sendToShell)("hud",{joystick:!1,fullscreen:!1}),t("none");var e=new Promise(e=>resolveConfiguration=e).then(e=>{window.settingsMenuConfiguration={...e};let t=window.showcase;return!(!e.showSettings||e.userHasSet)&&new Promise(e=>(0,_settingsMenu_js__WEBPACK_IMPORTED_MODULE_12__.$)(!0,t&&!t.useAvatar,e))});return(0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.sendToShell)("send-configuration"),e.then(e=>(e&&(0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.sendToShell)("update-configuration",{localConfig:window.settingsMenuConfiguration}),(0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.sendToShell)("hud",{joystick:!0,fullscreen:!0}),t("flex"),getAntialias())).then(e=>{AA=e,launchMicroverse()})}async function launchMicroverse(){if(window.microverseInitFunction)return window.microverseInitFunction(startWorld,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants);let{baseurl,basename}=basenames();if(basename.endsWith(".vrse")){const response=await fetch(basename);if(!response.ok)throw Error("world not found: "+basename);const text=await response.text(),json=(new _worldSaver_js__WEBPACK_IMPORTED_MODULE_11__.H).parse(text);_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.AvatarNames=defaultAvatarNames,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory=defaultSystemBehaviorDirectory,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules=defaultSystemBehaviorModules,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.DefaultCards=json.data.cards,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library=new _code_js__WEBPACK_IMPORTED_MODULE_9__.Un,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library.addModules(json.data.behaviorModules)}else{const worldModule=await eval(`import("${baseurl}worlds/${basename}.js")`);if(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.ModelRoot.evaluate(()=>worldModule.init(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants)),!_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules)if(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory=defaultSystemBehaviorDirectory,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ExcludedSystemBehaviorModules||_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.IncludedSystemBehaviorModules){let systemBehaviorModules=[...defaultSystemBehaviorModules];_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ExcludedSystemBehaviorModules&&(systemBehaviorModules=systemBehaviorModules.filter(e=>!_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.ExcludedSystemBehaviorModules.includes(e))),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.IncludedSystemBehaviorModules&&systemBehaviorModules.push(..._croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.IncludedSystemBehaviorModules),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules=systemBehaviorModules}else _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules=defaultSystemBehaviorModules}let apiKeysModule,local=isRunningLocalNetwork(),apiKeysFile=local?"apiKey-dev.js":"apiKey.js";try{apiKeysModule=await eval(`import('${baseurl}${apiKeysFile}')`);const{apiKey,appId}=apiKeysModule.default;if("string"!=typeof apiKey)throw Error(apiKeysFile+": apiKey must be a string");if("string"!=typeof appId)throw Error(apiKeysFile+": appId must be a string");if(!apiKey.match(/^[_a-z0-9]+$/i))throw Error(`${apiKeysFile}: invalid apiKey: "${apiKey}"`);if(!appId.match(/^[-_.a-z0-9]+$/i))throw Error(`${apiKeysFile}: invalid appId: "${appId}"`)}catch(error){if("TypeError"!==error.name||!local)throw console.error(error),Error("Please make sure that you have created a valid apiKey-dev.js for local development, and apiKey.js for deployment (see croquet.io/keys)");console.warn(apiKeysFile+" not found, using default key for local development. Please create a valid apiKey-dev.js for local development, and apiKey.js for deployment (see croquet.io/keys)"),apiKeysModule={default:{apiKey:"1kBmNnh69v93i5tOpj7bqqaJxjD3HJEucxd7egi7H",appId:"io.croquet.microverse.localdevdefault"}}}startWorld(apiKeysModule.default,basename)}const shellListener=(e,t)=>{"local-configuration"===e&&(e=t["localConfig"],console.log("microverse received local-configuration",e),resolveConfiguration)&&(resolveConfiguration(e),resolveConfiguration=null)};(0,_frame_js__WEBPACK_IMPORTED_MODULE_8__.addShellListener)(shellListener)},6590:(e,t,s)=>{"use strict";s.r(t),s.d(t,{Physics:()=>i,PhysicsManager:()=>PhysicsManager,PhysicsVersion:()=>PhysicsVersion});t=s(4200);let i;function PhysicsVersion(){return"Rapier: "+i.version()}class PhysicsWorld extends t.Model{init(e){e.useCollisionEventQueue&&(this.queue=new i.EventQueue(!0));var t=e.gravity||[0,-9.8,0],s=e.timeStep||5,t=new i.Vector3(...t);this.world=new i.World(t),this.timeStep=s,this.world.timestep=this.timeStep/1e3,this.rigidBodies=new Map,e.startPaused||this.future(0).tick()}pause(){this.isPaused=!0}resume(){this.isPaused=!1}tick(){this.isPaused||(this.world.step(this.queue),this.world.forEachActiveRigidBody(e=>{var e=e.handle,e=this.rigidBodies.get(e),t=e.rigidBody.translation(),s=e.rigidBody.rotation(),t=[t.x,t.y,t.z],s=[s.x,s.y,s.z,s.w];e.moveTo(t),e.say("translating",t),e.rotateTo(s)}),this.queue&&this.collisionEventHandler&&this.queue.drainCollisionEvents((e,t,s)=>{e=this.rigidBodies.get(e),t=this.rigidBodies.get(t);this.collisionEventHandler.collision(e,t,s)})),this.future(this.timeStep).tick()}registerCollisionEventHandler(e){this.collisionEventHandler=e}destroy(){this.world.free(),this.world=null}}PhysicsWorld.register("PhysicsWorld");class PhysicsManager extends t.ModelService{static async asyncStart(){i=window.RAPIERModule||await s.e(87).then(s.bind(s,5087)),console.log("Starting physics "+PhysicsVersion())}static types(){return i?{"Physics.World":{cls:i.World,write:e=>e.takeSnapshot(),read:e=>i.World.restoreSnapshot(e)},"Physics.EventQueue":{cls:i.EventQueue,write:e=>{},read:e=>new i.EventQueue(!0)}}:{}}init(){super.init("PhysicsManager"),this.worlds=new Map}createWorld(e,t){e=PhysicsWorld.create(e);return this.worlds.set(t,e),e}createGlobalWorld(e){if(!this.globalWorld)return this.globalWorld=this.createWorld(e,this.id),this.globalWorld}deleteWorld(e){var t=this.worlds.get(e);t&&(t.destroy(),this.worlds.delete(e))}deleteGlobalWorld(){this.deleteWorld(this.id),delete this.globalWorld}destroy(){for(var[e,t]of this.worlds)t.destroy();delete this.globalWorld,this.worlds=new Map,super.destroy()}}PhysicsManager.register("PhysicsManager")},1246:(e,t,s)=>{"use strict";s.d(t,{Q:()=>PortalActor});var h=s(5679),t=s(3654),i=s(3917);class PortalActor extends t.Z4{init(e){super.init(e),this._isOpen=!0,this.addLayer("portal"),this._portalTime=this.now(),this.listen("isOpenSet",this.setIsOpen)}get isPortal(){return!0}get isOpen(){return this._isOpen}get portalTime(){return this._portalTime}get portalURL(){return this._cardData.portalURL}get sparkle(){return this._cardData.sparkle}get pawn(){return PortalPawn}setIsOpen(){this.isOpen?this.addLayer("portal"):this.removeLayer("portal")}}PortalActor.register("PortalActor");class PortalPawn extends t.Df{constructor(e){super(e),this.createPortalMaterials(),this.portalId=void 0,this.targetMatrix=new h.THREE.Matrix4,this.targetMatrixBefore=new h.THREE.Matrix4,this.actor.isOpen&&this.openPortal(),this.setGhostWorld({v:this.actor._ghostWorld}),this.listen("ghostWorldSet",this.setGhostWorld),this.listen("isOpenSet",this.setIsOpen),this.addEventListener("pointerDown",this.onPointerDown),this.addEventListener("keyDown",e=>{switch(e.key){case" ":this.enterPortal();break;case"G":case"g":this.say("_set",{ghostWorld:null===this.actor._ghostWorld?20:null})}}),this.shellListener=(e,t)=>this.receiveFromShell(e,t),(0,i.addShellListener)(this.shellListener),this.subscribe("avatar",{event:"gatherPortalSpecs",handling:"immediate"},this.updatePortal)}destroy(){this.closePortal(),(0,i.removeShellListener)(this.shellListener),super.destroy()}get globalPlane(){return this._globalPlane||(this._globalPlane=new h.THREE.Plane,this._globalPlane.normal.set(0,0,1),this._globalPlane.applyMatrix4(this.shape.matrixWorld)),this._globalPlane}objectCreated(e,t){super.objectCreated(e,t),this.applyPortalMaterial(e),this.actor.sparkle&&this.addParticles()}createPortalMaterials(){this.portalMaterial=new h.THREE.ShaderMaterial({uniforms:{time:{value:0}},vertexShader:`
                #include <clipping_planes_pars_vertex>
                varying vec3 vUv;
                void main() {
                    #include <begin_vertex>             // transformed = position
                    #include <project_vertex>           // mvPosition and gl_Position
                    #include <clipping_planes_vertex>   // vClipPosition
                    vUv = transformed;
                }
            `,fragmentShader:`
                uniform float time;
                varying vec3 vUv;
                #include <clipping_planes_pars_fragment>
                void main() {
                    #include <clipping_planes_fragment>
                    float r = length(vUv.xy);
                    float angle = atan(vUv.y, vUv.x);
                    float v = sin(time * 30.0 - r * 1.0 + 5.0 * angle) + r - time * 2.0 + 2.0;
                    float alpha = clamp(v, 0.0, 1.0);
                    // gl_FragColor = vec4(0, 0, 0, alpha); // if we only care about alpha
                    gl_FragColor = vec4(alpha*0.3, alpha*0.3, alpha*0.3, alpha); // add some grey
                }
            `,clipping:!0})}applyPortalMaterial(e){var t;(e=(e=e||this.shape).material?e:e.children[0])&&(t=this.actor["isOpen"],Array.isArray(e.material)?(e.material[0]!==this.portalMaterial&&(this.originalMaterial=e.material[0]),e.material[0]=t?this.portalMaterial:this.originalMaterial):(e.material!==this.portalMaterial&&(this.originalMaterial=e.material),e.material=t?this.portalMaterial:this.originalMaterial))}addParticles(){if(!this.particleSystem){var t=.5*this.actor._cardData.width+.002,s=.5*this.actor._cardData.height+.002,e={pointTexture:{value:(new h.THREE.TextureLoader).load("./assets/images/spark.png")}},e=new h.THREE.ShaderMaterial({uniforms:e,vertexShader:`
                attribute float size;
                #include <clipping_planes_pars_vertex>
                void main() {
                    #include <begin_vertex>
                    #include <project_vertex>
                    mvPosition += vec4( 0.0, 0.0, 0.1, 0.0 ); // offset towards camera to avoid z clipping
                    #include <clipping_planes_vertex>
                    gl_PointSize = size * ( 20.0 / -mvPosition.z );
                }
            `,fragmentShader:`
                uniform sampler2D pointTexture;
                #include <clipping_planes_pars_fragment>
                void main() {
                    #include <clipping_planes_fragment>
                    gl_FragColor = texture2D( pointTexture, gl_PointCoord );
                }
            `,clipping:!0,blending:h.THREE.AdditiveBlending,depthWrite:!1,transparent:!0,vertexColors:!0}),i=[],a=[];for(let e=0;e<1e3;e++){var r=2*Math.random()-1,o=Math.random()<.5?1:-1,n=Math.random()<.5;i.push((n?r:o)*t),i.push((n?o:r)*s),i.push(0),a.push(20)}var l=new h.THREE.BufferGeometry;l.setAttribute("position",new h.THREE.Float32BufferAttribute(i,3)),l.setAttribute("size",new h.THREE.Float32BufferAttribute(a,1).setUsage(h.THREE.DynamicDrawUsage)),this.particleSystem=new h.THREE.Points(l,e),this.shape.add(this.particleSystem)}}removeParticles(){this.particleSystem&&(this.shape.remove(this.particleSystem),this.particleSystem=void 0)}get hitNormal(){return[0,0,-1]}update(e){super.update(e),this.updatePortalMaterial(),this.updateParticles()}updatePortal({callback:e,force:t}){this.updatePortalCamera(e,t)}updatePortalCamera(e,t){var s,i,a,r;this.portalId&&({targetMatrix:s,targetMatrixBefore:i,portalId:a}=this,r=this.service("ThreeRenderManager")["camera"],r.updateMatrixWorld(!0),this.renderObject.updateMatrixWorld(!0),s.copy(this.renderObject.matrixWorld),s.invert(),s.multiply(r.matrixWorld),!t&&i.equals(s)||(t=new h.THREE.Frustum,r=(new h.THREE.Matrix4).multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),t.setFromProjectionMatrix(r),e({portalId:a,cameraMatrix:t.intersectsObject(this.renderObject.children[0])?s.elements:null}),i.copy(s)))}updatePortalMaterial(){var e=this.actor["portalTime"],e=(this.extrapolatedNow()-e)/1e3;this.portalMaterial.uniforms.time.value=e}updateParticles(){if(this.actor.sparkle&&!this.particleSystem?this.addParticles():!this.actor.sparkle&&this.particleSystem&&this.removeParticles(),this.particleSystem){var e=this.particleSystem["geometry"],t=e.attributes.size.array,s=Date.now()/100;for(let e=0;e<t.length;e++)t[e]=10*(1+Math.sin(.1*e+s));e.attributes.size.needsUpdate=!0}}updateShape(e){this.removeParticles(),super.updateShape(e),this.updateParticles()}cardDataUpdated(e){super.cardDataUpdated(e),this.didPropertyChange(e,"sparkle")&&this.updateParticles()}refreshDrawTransform(){super.refreshDrawTransform(),this._globalPlane=null}onPointerDown(){this.say("_set",{isOpen:!this.actor.isOpen,portalTime:this.now()})}openPortal(){var e=this.resolvePortalURL();(0,i.sendToShell)("portal-open",{portalURL:e,portalId:this.portalId})}closePortal(){(0,i.sendToShell)("portal-close",{portalId:this.portalId}),this.portalId=null,this.targetMatrixBefore.identity()}resolvePortalURL(){let e=this.actor.portalURL;var t=new URL(e,location.href);const s=t.searchParams;var i=new URLSearchParams(t.hash.slice(1)),a=s.get("q");let r=i.get("pw");const o=new URL(location.href);return a&&r||(a||(a=o.searchParams.get("q"),r="",s.set("q",a)),r)||(a=new URLSearchParams(o.hash.slice(1)),r=a.get("pw"),i.set("pw",r),t.hash=i.toString()),["showSettings","voiceChat"].forEach(e=>{o.searchParams.has(e)&&s.set(e,"true")}),e=t.toString(),t.origin===location.origin&&(e=e.slice(location.origin.length),t.pathname===location.pathname)&&(e=e.slice(location.pathname.length)),this.actor.portalURL!==e&&this.say("setCardData",{portalURL:e}),t.toString()}setIsOpen({v:e}){this.applyPortalMaterial(),e?this.openPortal():this.closePortal()}setGhostWorld({v:e}){var t=document.getElementById("ThreeCanvas");let s=document.getElementById("ghostSlider");"number"==typeof e&&i.isPrimaryFrame?(s.style.display="block",s.oninput=()=>this.say("_set",{ghostWorld:+s.value}),t.style.filter=`opacity(${100-e}%) saturate(${100-e}%) contrast(${80+.2*e}%) blur(4px)`,s.value=e):(s.style.display="none",t.style.filter="")}receiveFromShell(e,{portalId:t}){switch(e){case"portal-opened":this.portalId=t;break;case"frame-type":this.setGhostWorld({v:this.actor._ghostWorld})}}}},5072:(e,t,s)=>{"use strict";s.d(t,{$:()=>function startSettingsMenu(e,t,s){a=s,i=!1,r=!1,w=t,(0,g.ts)(),function createSettingsMenu(e){var t=`
<div id="joinDialog" class="dialogPanel no-select">
    <button id="close-button" type="button" class="btn btn-danger btn-x topright">x</button>
    <div id="join-container" class="content-container">
        <!--
        <div id="dialogTitle">
            <div id="titleHolder">
                <img id="titleLogo" src="assets/images/microverse-logo.png" />
            </div>
        </div>
        -->
        <div id="joinPrompt">
            <div id="joinPromptTitle">Settings</div>
            <div id="joinPromptBlurb" class="promptBlurb">Specify a nickname, and choose an avatar either
                by selecting from those on display or pasting a valid Ready Player Me URL.
            </div>
        </div>
        <div id="settings-title" class="panel-title">Settings</div>
        <div class="settings-container">
            <div id="nameInput" class="stringInputHolder">
                <div id="namePrompt" class="namePrompt">Nickname<span>*</span></div>
                <div id="nameField" class="nameField allow-select" contenteditable="true"></div>
                <div id="nameExplanation">Enter 1-12 characters (ASCII only).</div>
                <div id="nameFilterWarning"><br /></div>
            </div>
            <div id="selectAvatar" class="namePrompt">Select Avatar</div>
            <div id="dialogAvatarSelections">
                <div id="avatarList"></div>
            </div>
            <div id="avatarURL" class="stringInputHolder">
                <div id="avatarURLPrompt" class="namePrompt">Or, Enter an Avatar URL</div>
                <div id="avatarURLField" class="nameField avatarNameField allow-select" contenteditable="true"></div>
            </div>
            <div id="handednessRow">
                <div id="handednessLabel">Hand:</div>
                <div class="btn-group" id="handedness">
                    <label class="btn btn-radio-button">
                         <input type="radio" name="options" id="left"><span class="handedness-label">Left</span>
                    </label>
                    <label class="btn btn-radio-button">
                        <input type="radio" name="options" id="right" checked><span class="handedness-label">Right</span>
                    </label>
                </div>
            </div>
            <div id="dialogEnterButton" class="dialogButtonsHolder disabled">
                <div id="enterButton">Enter</div>
            </div>
            <div id="dialogAcceptCancelButtons" class="dialogButtonsHolder twoItems">
                <button id="cancel-button" type="button" class="btn btn-danger cancel-button">Cancel</button>
                <button type="button" id="acceptButton" class="btn btn-success">Apply</button>
            </div>
        </div>
    </div>
</div>
`.trim(),s=document.createElement("div"),t=(s.innerHTML=t,(y=s.querySelector("#joinDialog")).querySelector("#close-button")),s=y.querySelector("#enterButton"),i=y.querySelector("#acceptButton"),a=y.querySelector("#cancel-button"),r=y.querySelector("#handednessRow"),o=y.querySelector("#handedness"),n=y.querySelector("#dialogTitle"),l=y.querySelector("#joinPrompt"),h=y.querySelector("#joinPromptBlurb"),d=y.querySelector("#settings-title"),c=y.querySelector("#dialogEnterButton"),u=y.querySelector("#dialogAcceptCancelButtons"),p=y.querySelector("#selectAvatar"),m=y.querySelector("#dialogAvatarSelections"),f=y.querySelector("#avatarURL"),v=y.querySelector("#nameField"),v=(v.addEventListener("keydown",e=>function nameFieldKeydown(e){e.stopPropagation(),13!==e.keyCode&&9!==e.keyCode||e.preventDefault()}(e)),v.addEventListener("input",e=>nameFieldChanged(e)),v.addEventListener("paste",e=>e.stopPropagation()),y.querySelector("#avatarURLField"));v.addEventListener("input",e=>avatarURLFieldChanged(e)),v.addEventListener("paste",e=>e.stopPropagation()),v.addEventListener("keydown",e=>e.stopPropagation()),s.onclick=()=>function dialogCloseEnter(){console.log("enter",_),updateLocalConfig(),closeDialog(!0)}(),i.onclick=()=>function accept(){console.log("accept",_),updateLocalConfig(),closeDialog(!0),(0,g.ts)()}(),t.onclick=()=>(0,g.ts)(),a.onclick=()=>(0,g.ts)(),o.addEventListener("input",()=>function handednessChanged(){var e=y.querySelector("#left");_.handedness=e.checked?"Left":"Right"}()),n&&n.classList.toggle("hidden",!e);l&&l.classList.toggle("notUseEnter",!e);d&&d.classList.toggle("hidden",e);t&&t.classList.toggle("hidden",e);c&&c.classList.toggle("notUseEnter",!e);u&&u.classList.toggle("notUseEnter",!e);p&&p.classList.toggle("hidden",!!w);m&&m.classList.toggle("hidden",!!w);f&&(f.style.display=w?"none":"flex");r&&(r.style.display=w?"none":"flex");h&&w&&(h.textContent="Specify a nickname and press Enter.");return function populateAvatarSelection(){if(y){let s=y.querySelector("#avatarList");x.forEach(e=>{var t=document.createElement("div");t.classList.add("avatarThumb"),t.onclick=()=>avatarSelected(e),0<=e.png.indexOf("/")?t.style.backgroundImage=`url(${e.png})`:t.style.backgroundImage=`url(./assets/avatar-images/${e.png}.png)`,t.setAttribute("avatarURL",e.url),s.appendChild(t)})}}(),document.body.appendChild(y),(0,g.gA)(y),Promise.resolve(y)}(e).then(fillFromPrevious),(0,g.aP)()},Y:()=>function startShareMenu(e){(0,g.ts)(),function createShareMenu(t){let e=`
    <div id="shareDialog" class="dialogPanel no-select">
        <button id="close-button" type="button" class="btn btn-danger btn-x topright">x</button>
        <div id="share-container" class="content-container">
            <div id="share-title" class="panel-title">Share Session<br></div>
            <div class="promptBlurb">Scan QR code or click to open a new browser tab<br> in the same session.</div>
            <div id="share-qr"></div>

            <div class="share-settings-label">Copy Share Link</div>
            <div class="share-menu-row">
                <div id="copy-link" class="copy-link allow-select">generated link</div>
                <button id="copy-button" type="button" class="btn btn-outline-success">Copy</button>
            </div>
            <div class="share-menu-row">
                <div class="share-settings-label">Save world as VRSE file</div>
                <button id="save-button" type="button" class="btn btn-outline-success">Download</button>
            </div>
        </div>
    </div>`.trim(),s=document.createElement("div"),i=(s.innerHTML=e,s.querySelector("#shareDialog")),a=s.querySelector("#share-qr"),r=i.querySelector("#close-button"),o=document.createElement("div"),n=s.querySelector("#copy-link"),l=s.querySelector("#copy-button"),h=s.querySelector("#save-button"),d=((0,g.gA)(i),u.App.makeQRCanvas()),c=u.App.sessionURL;a.appendChild(o),o.appendChild(d),o.classList.add("menu-qr"),d.classList.add("share-qr-canvas"),d.onclick=()=>{var e=document.createElement("div");e.innerHTML=`<a id="link" target="_blank" rel="noopener noreferrer" href="${c}"></a>`,document.getElementById("hud").appendChild(e),e.querySelector("#link").click(),e.remove()},r.onclick=()=>(0,g.ts)(),n.textContent=c,h.onclick=e=>function savePressed(e){var e=e.actor.wellKnownModel("ModelRoot"),t=document.createElement("a"),e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e.saveData(),null,4));t.setAttribute("href",e),t.setAttribute("download","scene.vrse"),t.click()}(t),l.onclick=e=>function copyPressed(e){let s=navigator.userAgent.match(/ipad|iphone/i),i=u.App.sessionURL;(navigator.clipboard?navigator.clipboard.writeText(i).then(()=>!0,()=>!1):Promise.resolve(!1)).then(e=>{var t;e||(s?((e=document.createRange()).selectNodeContents(this.copy),this.copy.textContent=i,(t=window.getSelection()).removeAllRanges(),t.addRange(e),this.copy.setSelectionRange(0,1e5)):(this.copy.value=i,this.copy.select(),this.copy.setSelectionRange(0,99999)),document.execCommand("copy"))})}(),document.body.appendChild(i)}(e),(0,g.aP)()}});var g=s(188),u=s(4200);let y=null,i,r,w,_={},a;function fillFromPrevious(){var e=window.settingsMenuConfiguration||{},t=e.nickname,s=w?null:e.avatarURL,e=e.handedness;t&&(y.querySelector("#nameField").textContent=t,nameFieldChanged()),s&&((t=function findPredefined(t){return x.find(e=>e.url===t)}(s))?avatarSelected(t):(y.querySelector("#avatarURLField").textContent=s,avatarURLFieldChanged())),e&&"Left"===e&&(y.querySelector("#handedness").querySelector("#left").checked=!0),updateButtonState()}function nameFieldChanged(e){e&&(e.stopPropagation(),e.preventDefault());let t=document.getElementById("nameField").textContent.trim().replace(/\r?\n|\r/g,"");e=t.length;t=t.replace(/[^\x20-\x7F]/g,"").trim().slice(0,12).trim(),document.getElementById("nameFilterWarning").innerHTML=t.length===e?"<br/>":`Nickname filtered to "${t}"`,i=1<=t.length&&t.length<=12&&(_.nickname=t,!0),updateButtonState()}function avatarURLFieldChanged(e){e&&(e.preventDefault(),e.stopPropagation()),avatarSelected({url:y.querySelector("#avatarURLField").textContent.trim(),type:"ReadyPlayerMe"})}function updateButtonState(){var e=i&&(w||r);y.querySelector("#dialogEnterButton").classList.toggle("disabled",!e),y.querySelector("#dialogAcceptCancelButtons").classList.toggle("disabled",!e)}function closeDialog(e){y.remove(),y=null,a&&(a(e),a=null)}function updateLocalConfig(){var e=window.settingsMenuConfiguration||{};window.settingsMenuConfiguration={...e,..._},w&&(window.settingsMenuConfiguration.avatarURL=null,window.settingsMenuConfiguration.type="wonderland")}let x=[{png:"https://croquet.io/microverse/assets/avatar-images/f1.png",url:"https://d1a370nemizbjq.cloudfront.net/0725566e-bdc0-40fd-a22f-cc4c333bcb90.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/f2.png",url:"https://d1a370nemizbjq.cloudfront.net/50ef7f5f-b401-4b47-a8dc-1c4eda1ba8d2.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/f3.png",url:"https://d1a370nemizbjq.cloudfront.net/b5c04bb2-a1df-4ca4-be2e-fb54799e9030.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/f4.png",url:"https://d1a370nemizbjq.cloudfront.net/b480f1d0-3a0f-4766-9860-c213e6c50f3d.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/m1.png",url:"https://d1a370nemizbjq.cloudfront.net/05d16812-01de-48cc-8e06-c6514ba14a77.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/m2.png",url:"https://d1a370nemizbjq.cloudfront.net/2955d824-31a4-47e1-ba58-6c387c63b660.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/m3.png",url:"https://d1a370nemizbjq.cloudfront.net/579d4ec8-ade3-49ea-8b52-2ea5fe097f7d.glb",type:"ReadyPlayerMe"},{png:"https://croquet.io/microverse/assets/avatar-images/m4.png",url:"https://d1a370nemizbjq.cloudfront.net/535100f3-c58c-4fd8-9fb9-4ee090e844bf.glb",type:"ReadyPlayerMe"}];function avatarSelected(t){var e=t.url,s=/https?:[a-zA-Z0-9/.-]+\.glb/.test(e);if(s&&!w&&(_.avatarURL=t.url,_.type=t.type),y){r=!1;var i=y.querySelector("#avatarList");for(let e=0;e<i.childNodes.length;e++){var a=i.childNodes[e];a.getAttribute("avatarURL")===t.url?(a.setAttribute("selected",!0),r=!0):a.removeAttribute("selected")}e&&e===t.url?r=s:avatarURLField.textContent="",updateButtonState()}}},4355:(u,e,t)=>{"use strict";t.d(e,{NC:()=>FontModelManager,Ax:()=>FontViewManager,WK:()=>KeyFocusManager,N2:()=>SyncedStateManager,T0:()=>TextFieldActor});var o=t(4200),b=t(5679),d=t(7194),e=t(3654),s=t(9902),a=t.n(s),s=JSON.parse('{"pages":["Roboto-msdf.png"],"chars":[{"id":41,"width":22,"height":53,"xoffset":0,"yoffset":-33.6943359375,"xadvance":14.6015625,"chnl":15,"x":0,"y":0,"page":0},{"id":40,"width":24,"height":53,"xoffset":0,"yoffset":-33.6943359375,"xadvance":14.35546875,"chnl":15,"x":0,"y":55,"page":0},{"id":93,"width":18,"height":51,"xoffset":0,"yoffset":-34.125,"xadvance":11.1357421875,"chnl":15,"x":0,"y":110,"page":0},{"id":91,"width":21,"height":51,"xoffset":0,"yoffset":-34.125,"xadvance":11.1357421875,"chnl":15,"x":0,"y":163,"page":0},{"id":125,"width":23,"height":50,"xoffset":0,"yoffset":-32.7509765625,"xadvance":14.2119140625,"chnl":15,"x":0,"y":216,"page":0},{"id":123,"width":24,"height":50,"xoffset":0,"yoffset":-32.7509765625,"xadvance":14.2119140625,"chnl":15,"x":0,"y":268,"page":0},{"id":106,"width":18,"height":49,"xoffset":0,"yoffset":-30.26953125,"xadvance":10.0283203125,"chnl":15,"x":0,"y":320,"page":0},{"id":36,"width":31,"height":49,"xoffset":0,"yoffset":-34.69921875,"xadvance":23.583984375,"chnl":15,"x":0,"y":371,"page":0},{"id":64,"width":46,"height":49,"xoffset":0,"yoffset":-29.3466796875,"xadvance":37.7138671875,"chnl":15,"x":0,"y":422,"page":0},{"id":87,"width":46,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":37.2626953125,"chnl":15,"x":48,"y":422,"page":0},{"id":124,"width":17,"height":45,"xoffset":0,"yoffset":-29.859375,"xadvance":10.2333984375,"chnl":15,"x":33,"y":371,"page":0},{"id":81,"width":36,"height":45,"xoffset":0,"yoffset":-30.26953125,"xadvance":28.875,"chnl":15,"x":52,"y":371,"page":0},{"id":109,"width":44,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":36.8115234375,"chnl":15,"x":0,"y":473,"page":0},{"id":77,"width":43,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":36.66796875,"chnl":15,"x":96,"y":422,"page":0},{"id":39,"width":15,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":7.3212890625,"chnl":15,"x":90,"y":371,"page":0},{"id":34,"width":21,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":13.4326171875,"chnl":15,"x":107,"y":371,"page":0},{"id":92,"width":27,"height":42,"xoffset":0,"yoffset":-29.859375,"xadvance":17.2265625,"chnl":15,"x":130,"y":371,"page":0},{"id":104,"width":30,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":23.1328125,"chnl":15,"x":159,"y":371,"page":0},{"id":47,"width":26,"height":42,"xoffset":0,"yoffset":-29.859375,"xadvance":17.30859375,"chnl":15,"x":191,"y":371,"page":0},{"id":108,"width":17,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":10.1923828125,"chnl":15,"x":219,"y":371,"page":0},{"id":98,"width":32,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":23.5634765625,"chnl":15,"x":238,"y":371,"page":0},{"id":107,"width":31,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":21.287109375,"chnl":15,"x":272,"y":371,"page":0},{"id":100,"width":31,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":23.6865234375,"chnl":15,"x":305,"y":371,"page":0},{"id":102,"width":25,"height":42,"xoffset":0,"yoffset":-31.9306640625,"xadvance":14.5810546875,"chnl":15,"x":338,"y":371,"page":0},{"id":48,"width":31,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":365,"y":371,"page":0},{"id":51,"width":31,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":398,"y":371,"page":0},{"id":83,"width":33,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":24.9169921875,"chnl":15,"x":431,"y":371,"page":0},{"id":56,"width":31,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":466,"y":371,"page":0},{"id":119,"width":41,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":31.5615234375,"chnl":15,"x":46,"y":473,"page":0},{"id":37,"width":39,"height":41,"xoffset":0,"yoffset":-30.2900390625,"xadvance":30.76171875,"chnl":15,"x":20,"y":320,"page":0},{"id":103,"width":31,"height":41,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.5634765625,"chnl":15,"x":61,"y":320,"page":0},{"id":113,"width":31,"height":41,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.87109375,"chnl":15,"x":94,"y":320,"page":0},{"id":96,"width":20,"height":41,"xoffset":0,"yoffset":-31.458984375,"xadvance":12.9814453125,"chnl":15,"x":127,"y":320,"page":0},{"id":38,"width":36,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":26.1064453125,"chnl":15,"x":149,"y":320,"page":0},{"id":121,"width":29,"height":41,"xoffset":0,"yoffset":-22.189453125,"xadvance":19.8720703125,"chnl":15,"x":187,"y":320,"page":0},{"id":67,"width":35,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":27.3369140625,"chnl":15,"x":218,"y":320,"page":0},{"id":79,"width":36,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":28.875,"chnl":15,"x":255,"y":320,"page":0},{"id":71,"width":36,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":28.6083984375,"chnl":15,"x":293,"y":320,"page":0},{"id":112,"width":32,"height":41,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.5634765625,"chnl":15,"x":331,"y":320,"page":0},{"id":72,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":29.94140625,"chnl":15,"x":141,"y":422,"page":0},{"id":73,"width":18,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":11.4228515625,"chnl":15,"x":179,"y":422,"page":0},{"id":74,"width":30,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.173828125,"chnl":15,"x":199,"y":422,"page":0},{"id":75,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.33203125,"chnl":15,"x":231,"y":422,"page":0},{"id":76,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":22.599609375,"chnl":15,"x":269,"y":422,"page":0},{"id":57,"width":31,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":303,"y":422,"page":0},{"id":78,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":29.94140625,"chnl":15,"x":336,"y":422,"page":0},{"id":33,"width":18,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":10.8076171875,"chnl":15,"x":374,"y":422,"page":0},{"id":80,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.49609375,"chnl":15,"x":394,"y":422,"page":0},{"id":42,"width":27,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":18.087890625,"chnl":15,"x":431,"y":422,"page":0},{"id":82,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.8603515625,"chnl":15,"x":460,"y":422,"page":0},{"id":49,"width":25,"height":40,"xoffset":0,"yoffset":-30.0029296875,"xadvance":23.583984375,"chnl":15,"x":365,"y":320,"page":0},{"id":84,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.060546875,"chnl":15,"x":392,"y":320,"page":0},{"id":85,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":27.234375,"chnl":15,"x":428,"y":320,"page":0},{"id":86,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.7216796875,"chnl":15,"x":464,"y":320,"page":0},{"id":50,"width":32,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":26,"y":268,"page":0},{"id":88,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.33203125,"chnl":15,"x":60,"y":268,"page":0},{"id":89,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.224609375,"chnl":15,"x":97,"y":268,"page":0},{"id":90,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.142578125,"chnl":15,"x":134,"y":268,"page":0},{"id":105,"width":17,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":10.1923828125,"chnl":15,"x":170,"y":268,"page":0},{"id":52,"width":33,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.583984375,"chnl":15,"x":189,"y":268,"page":0},{"id":63,"width":28,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":19.8310546875,"chnl":15,"x":224,"y":268,"page":0},{"id":94,"width":26,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":17.5546875,"chnl":15,"x":254,"y":268,"page":0},{"id":53,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.583984375,"chnl":15,"x":282,"y":268,"page":0},{"id":65,"width":37,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":27.3984375,"chnl":15,"x":316,"y":268,"page":0},{"id":66,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.1474609375,"chnl":15,"x":355,"y":268,"page":0},{"id":54,"width":32,"height":40,"xoffset":0,"yoffset":-29.8798828125,"xadvance":23.583984375,"chnl":15,"x":391,"y":268,"page":0},{"id":68,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":27.5419921875,"chnl":15,"x":425,"y":268,"page":0},{"id":55,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.583984375,"chnl":15,"x":462,"y":268,"page":0},{"id":70,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.21484375,"chnl":15,"x":25,"y":216,"page":0},{"id":35,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.8603515625,"chnl":15,"x":59,"y":216,"page":0},{"id":69,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.87109375,"chnl":15,"x":96,"y":216,"page":0},{"id":116,"width":22,"height":38,"xoffset":0,"yoffset":-27.5625,"xadvance":13.7197265625,"chnl":15,"x":130,"y":216,"page":0},{"id":59,"width":17,"height":38,"xoffset":0,"yoffset":-22.39453125,"xadvance":8.8798828125,"chnl":15,"x":154,"y":216,"page":0},{"id":126,"width":36,"height":26,"xoffset":0,"yoffset":-16.447265625,"xadvance":28.5673828125,"chnl":15,"x":89,"y":473,"page":0},{"id":43,"width":32,"height":35,"xoffset":0,"yoffset":-24.732421875,"xadvance":23.8095703125,"chnl":15,"x":173,"y":216,"page":0},{"id":60,"width":28,"height":33,"xoffset":0,"yoffset":-22.517578125,"xadvance":21.3486328125,"chnl":15,"x":207,"y":216,"page":0},{"id":97,"width":31,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":22.845703125,"chnl":15,"x":237,"y":216,"page":0},{"id":101,"width":31,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":22.2509765625,"chnl":15,"x":270,"y":216,"page":0},{"id":110,"width":30,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.173828125,"chnl":15,"x":303,"y":216,"page":0},{"id":111,"width":32,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.953125,"chnl":15,"x":335,"y":216,"page":0},{"id":62,"width":30,"height":33,"xoffset":0,"yoffset":-22.5380859375,"xadvance":21.943359375,"chnl":15,"x":369,"y":216,"page":0},{"id":58,"width":17,"height":33,"xoffset":0,"yoffset":-22.39453125,"xadvance":10.171875,"chnl":15,"x":401,"y":216,"page":0},{"id":114,"width":24,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":14.2119140625,"chnl":15,"x":420,"y":216,"page":0},{"id":115,"width":30,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":21.65625,"chnl":15,"x":446,"y":216,"page":0},{"id":99,"width":31,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":21.984375,"chnl":15,"x":478,"y":216,"page":0},{"id":117,"width":30,"height":33,"xoffset":0,"yoffset":-22.189453125,"xadvance":23.1533203125,"chnl":15,"x":23,"y":163,"page":0},{"id":118,"width":30,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":20.34375,"chnl":15,"x":55,"y":163,"page":0},{"id":120,"width":30,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":20.8154296875,"chnl":15,"x":87,"y":163,"page":0},{"id":122,"width":29,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":20.8154296875,"chnl":15,"x":119,"y":163,"page":0},{"id":61,"width":30,"height":30,"xoffset":0,"yoffset":-19.9951171875,"xadvance":23.05078125,"chnl":15,"x":150,"y":163,"page":0},{"id":95,"width":29,"height":13,"xoffset":0,"yoffset":0,"xadvance":18.94921875,"chnl":15,"x":127,"y":473,"page":0},{"id":45,"width":21,"height":24,"xoffset":0,"yoffset":-14.232421875,"xadvance":11.5869140625,"chnl":15,"x":182,"y":163,"page":0},{"id":44,"width":16,"height":20,"xoffset":0,"yoffset":-4.4912109375,"xadvance":8.244140625,"chnl":15,"x":496,"y":268,"page":0},{"id":46,"width":18,"height":15,"xoffset":0,"yoffset":-4.2861328125,"xadvance":11.0537109375,"chnl":15,"x":23,"y":198,"page":0},{"id":32,"width":0,"height":0,"xoffset":0,"yoffset":0,"xadvance":10.3974609375,"chnl":15,"x":0,"y":508,"page":0}],"info":{"face":"Roboto","size":42,"bold":0,"italic":0,"charset":[" ","!","\\"","#","$","%","&","\'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~"],"unicode":1,"stretchH":100,"smooth":1,"aa":1,"padding":[0,0,0,0],"spacing":[2,2]},"common":{"lineHeight":44.091796875,"base":38.96484375,"scaleW":512,"scaleH":512,"pages":1,"packed":0,"alphaChnl":0,"redChnl":0,"greenChnl":0,"blueChnl":0},"kernings":[{"first":32,"second":84,"amount":-0.8203125},{"first":34,"second":34,"amount":-2.1943359375},{"first":34,"second":39,"amount":-2.1943359375},{"first":34,"second":65,"amount":-2.4609375},{"first":34,"second":97,"amount":-1.025390625},{"first":34,"second":99,"amount":-1.2099609375},{"first":34,"second":100,"amount":-1.2099609375},{"first":34,"second":101,"amount":-1.2099609375},{"first":34,"second":103,"amount":-1.2099609375},{"first":34,"second":109,"amount":-0.41015625},{"first":34,"second":110,"amount":-0.41015625},{"first":34,"second":111,"amount":-1.2509765625},{"first":34,"second":112,"amount":-0.41015625},{"first":34,"second":113,"amount":-1.2099609375},{"first":34,"second":115,"amount":-1.640625},{"first":39,"second":34,"amount":-2.1943359375},{"first":39,"second":39,"amount":-2.1943359375},{"first":39,"second":65,"amount":-2.4609375},{"first":39,"second":97,"amount":-1.025390625},{"first":39,"second":99,"amount":-1.2099609375},{"first":39,"second":100,"amount":-1.2099609375},{"first":39,"second":101,"amount":-1.2099609375},{"first":39,"second":103,"amount":-1.2099609375},{"first":39,"second":109,"amount":-0.41015625},{"first":39,"second":110,"amount":-0.41015625},{"first":39,"second":111,"amount":-1.2509765625},{"first":39,"second":112,"amount":-0.41015625},{"first":39,"second":113,"amount":-1.2099609375},{"first":39,"second":115,"amount":-1.640625},{"first":40,"second":86,"amount":0.41015625},{"first":40,"second":87,"amount":0.369140625},{"first":40,"second":89,"amount":0.451171875},{"first":44,"second":34,"amount":-3.486328125},{"first":44,"second":39,"amount":-3.486328125},{"first":46,"second":34,"amount":-3.486328125},{"first":46,"second":39,"amount":-3.486328125},{"first":47,"second":47,"amount":-4.59375},{"first":65,"second":34,"amount":-2.4609375},{"first":65,"second":39,"amount":-2.4609375},{"first":65,"second":67,"amount":-0.2255859375},{"first":65,"second":71,"amount":-0.2255859375},{"first":65,"second":79,"amount":-0.2255859375},{"first":65,"second":81,"amount":-0.2255859375},{"first":65,"second":84,"amount":-2.6455078125},{"first":65,"second":85,"amount":-0.3486328125},{"first":65,"second":86,"amount":-1.7841796875},{"first":65,"second":87,"amount":-1.4150390625},{"first":65,"second":89,"amount":-1.927734375},{"first":65,"second":111,"amount":-0.24609375},{"first":65,"second":117,"amount":-0.2255859375},{"first":65,"second":118,"amount":-1.025390625},{"first":65,"second":121,"amount":-1.025390625},{"first":65,"second":122,"amount":0.24609375},{"first":66,"second":84,"amount":-0.5537109375},{"first":66,"second":86,"amount":-0.4921875},{"first":66,"second":89,"amount":-1.1279296875},{"first":67,"second":84,"amount":-0.5947265625},{"first":68,"second":44,"amount":-2.091796875},{"first":68,"second":46,"amount":-2.091796875},{"first":68,"second":65,"amount":-0.4306640625},{"first":68,"second":84,"amount":-0.5537109375},{"first":68,"second":86,"amount":-0.451171875},{"first":68,"second":88,"amount":-0.451171875},{"first":68,"second":89,"amount":-0.8818359375},{"first":68,"second":90,"amount":-0.4716796875},{"first":69,"second":84,"amount":0.41015625},{"first":69,"second":99,"amount":-0.3896484375},{"first":69,"second":100,"amount":-0.3896484375},{"first":69,"second":101,"amount":-0.3896484375},{"first":69,"second":103,"amount":-0.3896484375},{"first":69,"second":111,"amount":-0.3896484375},{"first":69,"second":113,"amount":-0.3896484375},{"first":69,"second":117,"amount":-0.3486328125},{"first":69,"second":118,"amount":-0.533203125},{"first":69,"second":121,"amount":-0.533203125},{"first":70,"second":44,"amount":-4.798828125},{"first":70,"second":46,"amount":-4.798828125},{"first":70,"second":65,"amount":-3.486328125},{"first":70,"second":74,"amount":-5.4140625},{"first":70,"second":84,"amount":0.41015625},{"first":70,"second":97,"amount":-0.697265625},{"first":70,"second":99,"amount":-0.4306640625},{"first":70,"second":100,"amount":-0.4306640625},{"first":70,"second":101,"amount":-0.4306640625},{"first":70,"second":103,"amount":-0.4306640625},{"first":70,"second":111,"amount":-0.4306640625},{"first":70,"second":113,"amount":-0.4306640625},{"first":70,"second":114,"amount":-0.533203125},{"first":70,"second":117,"amount":-0.451171875},{"first":70,"second":118,"amount":-0.4921875},{"first":70,"second":121,"amount":-0.4921875},{"first":72,"second":65,"amount":0.369140625},{"first":72,"second":84,"amount":-0.5947265625},{"first":72,"second":88,"amount":0.3486328125},{"first":72,"second":89,"amount":-0.57421875},{"first":73,"second":65,"amount":0.369140625},{"first":73,"second":84,"amount":-0.5947265625},{"first":73,"second":88,"amount":0.3486328125},{"first":73,"second":89,"amount":-0.57421875},{"first":74,"second":65,"amount":-0.451171875},{"first":75,"second":45,"amount":-1.3125},{"first":75,"second":67,"amount":-0.6357421875},{"first":75,"second":71,"amount":-0.6357421875},{"first":75,"second":79,"amount":-0.6357421875},{"first":75,"second":81,"amount":-0.6357421875},{"first":75,"second":99,"amount":-0.533203125},{"first":75,"second":100,"amount":-0.533203125},{"first":75,"second":101,"amount":-0.533203125},{"first":75,"second":103,"amount":-0.533203125},{"first":75,"second":109,"amount":-0.4716796875},{"first":75,"second":110,"amount":-0.4716796875},{"first":75,"second":111,"amount":-0.5537109375},{"first":75,"second":112,"amount":-0.4716796875},{"first":75,"second":113,"amount":-0.533203125},{"first":75,"second":117,"amount":-0.4716796875},{"first":75,"second":118,"amount":-0.8203125},{"first":75,"second":121,"amount":-0.8203125},{"first":76,"second":34,"amount":-6.890625},{"first":76,"second":39,"amount":-6.890625},{"first":76,"second":65,"amount":0.3896484375},{"first":76,"second":67,"amount":-1.3330078125},{"first":76,"second":71,"amount":-1.3330078125},{"first":76,"second":79,"amount":-1.3330078125},{"first":76,"second":81,"amount":-1.3330078125},{"first":76,"second":84,"amount":-5.6396484375},{"first":76,"second":85,"amount":-1.107421875},{"first":76,"second":86,"amount":-3.5888671875},{"first":76,"second":87,"amount":-2.9326171875},{"first":76,"second":89,"amount":-4.9013671875},{"first":76,"second":117,"amount":-0.90234375},{"first":76,"second":118,"amount":-2.7275390625},{"first":76,"second":121,"amount":-2.7275390625},{"first":77,"second":65,"amount":0.369140625},{"first":77,"second":84,"amount":-0.5947265625},{"first":77,"second":88,"amount":0.3486328125},{"first":77,"second":89,"amount":-0.57421875},{"first":78,"second":65,"amount":0.369140625},{"first":78,"second":84,"amount":-0.5947265625},{"first":78,"second":88,"amount":0.3486328125},{"first":78,"second":89,"amount":-0.57421875},{"first":79,"second":44,"amount":-2.091796875},{"first":79,"second":46,"amount":-2.091796875},{"first":79,"second":65,"amount":-0.4306640625},{"first":79,"second":84,"amount":-0.5537109375},{"first":79,"second":86,"amount":-0.451171875},{"first":79,"second":88,"amount":-0.451171875},{"first":79,"second":89,"amount":-0.8818359375},{"first":79,"second":90,"amount":-0.4716796875},{"first":80,"second":44,"amount":-6.64453125},{"first":80,"second":46,"amount":-6.64453125},{"first":80,"second":65,"amount":-2.830078125},{"first":80,"second":74,"amount":-4.1015625},{"first":80,"second":88,"amount":-0.6357421875},{"first":80,"second":90,"amount":-0.533203125},{"first":80,"second":97,"amount":-0.2255859375},{"first":80,"second":99,"amount":-0.2666015625},{"first":80,"second":100,"amount":-0.2666015625},{"first":80,"second":101,"amount":-0.2666015625},{"first":80,"second":103,"amount":-0.2666015625},{"first":80,"second":111,"amount":-0.2666015625},{"first":80,"second":113,"amount":-0.2666015625},{"first":80,"second":118,"amount":0.3076171875},{"first":80,"second":121,"amount":0.3076171875},{"first":81,"second":84,"amount":-0.8818359375},{"first":81,"second":86,"amount":-0.57421875},{"first":81,"second":87,"amount":-0.41015625},{"first":81,"second":89,"amount":-0.7177734375},{"first":82,"second":84,"amount":-1.640625},{"first":82,"second":86,"amount":-0.3896484375},{"first":82,"second":89,"amount":-0.984375},{"first":84,"second":44,"amount":-4.470703125},{"first":84,"second":45,"amount":-4.7578125},{"first":84,"second":46,"amount":-4.470703125},{"first":84,"second":65,"amount":-1.6201171875},{"first":84,"second":67,"amount":-0.57421875},{"first":84,"second":71,"amount":-0.57421875},{"first":84,"second":74,"amount":-4.921875},{"first":84,"second":79,"amount":-0.57421875},{"first":84,"second":81,"amount":-0.57421875},{"first":84,"second":83,"amount":-0.328125},{"first":84,"second":84,"amount":0.328125},{"first":84,"second":86,"amount":0.328125},{"first":84,"second":87,"amount":0.3076171875},{"first":84,"second":89,"amount":0.328125},{"first":84,"second":97,"amount":-2.3173828125},{"first":84,"second":99,"amount":-2.0302734375},{"first":84,"second":100,"amount":-2.0302734375},{"first":84,"second":101,"amount":-2.0302734375},{"first":84,"second":103,"amount":-2.0302734375},{"first":84,"second":109,"amount":-2.2353515625},{"first":84,"second":110,"amount":-2.2353515625},{"first":84,"second":111,"amount":-2.0302734375},{"first":84,"second":112,"amount":-2.2353515625},{"first":84,"second":113,"amount":-2.0302734375},{"first":84,"second":115,"amount":-2.37890625},{"first":84,"second":117,"amount":-1.9482421875},{"first":84,"second":118,"amount":-1.4765625},{"first":84,"second":120,"amount":-1.5791015625},{"first":84,"second":121,"amount":-1.4765625},{"first":84,"second":122,"amount":-1.23046875},{"first":85,"second":65,"amount":-0.451171875},{"first":86,"second":44,"amount":-4.6142578125},{"first":86,"second":45,"amount":-0.7587890625},{"first":86,"second":46,"amount":-4.6142578125},{"first":86,"second":65,"amount":-1.5380859375},{"first":86,"second":67,"amount":-0.2666015625},{"first":86,"second":71,"amount":-0.2666015625},{"first":86,"second":79,"amount":-0.2666015625},{"first":86,"second":81,"amount":-0.2666015625},{"first":86,"second":97,"amount":-0.943359375},{"first":86,"second":99,"amount":-0.90234375},{"first":86,"second":100,"amount":-0.90234375},{"first":86,"second":101,"amount":-0.90234375},{"first":86,"second":103,"amount":-0.90234375},{"first":86,"second":111,"amount":-0.943359375},{"first":86,"second":113,"amount":-0.90234375},{"first":86,"second":117,"amount":-0.57421875},{"first":86,"second":118,"amount":-0.2255859375},{"first":86,"second":121,"amount":-0.2255859375},{"first":87,"second":44,"amount":-2.5224609375},{"first":87,"second":45,"amount":-1.23046875},{"first":87,"second":46,"amount":-2.5224609375},{"first":87,"second":65,"amount":-0.8818359375},{"first":87,"second":84,"amount":0.287109375},{"first":87,"second":97,"amount":-0.6767578125},{"first":87,"second":99,"amount":-0.6357421875},{"first":87,"second":100,"amount":-0.6357421875},{"first":87,"second":101,"amount":-0.6357421875},{"first":87,"second":103,"amount":-0.6357421875},{"first":87,"second":111,"amount":-0.6357421875},{"first":87,"second":113,"amount":-0.6357421875},{"first":87,"second":117,"amount":-0.3896484375},{"first":88,"second":45,"amount":-0.943359375},{"first":88,"second":67,"amount":-0.5126953125},{"first":88,"second":71,"amount":-0.5126953125},{"first":88,"second":79,"amount":-0.5126953125},{"first":88,"second":81,"amount":-0.5126953125},{"first":88,"second":86,"amount":0.287109375},{"first":88,"second":99,"amount":-0.533203125},{"first":88,"second":100,"amount":-0.533203125},{"first":88,"second":101,"amount":-0.533203125},{"first":88,"second":103,"amount":-0.533203125},{"first":88,"second":111,"amount":-0.4306640625},{"first":88,"second":113,"amount":-0.533203125},{"first":88,"second":117,"amount":-0.4306640625},{"first":88,"second":118,"amount":-0.6357421875},{"first":88,"second":121,"amount":-0.6357421875},{"first":89,"second":44,"amount":-4.3271484375},{"first":89,"second":45,"amount":-1.06640625},{"first":89,"second":46,"amount":-4.3271484375},{"first":89,"second":65,"amount":-1.927734375},{"first":89,"second":67,"amount":-0.5947265625},{"first":89,"second":71,"amount":-0.5947265625},{"first":89,"second":74,"amount":-1.96875},{"first":89,"second":79,"amount":-0.5947265625},{"first":89,"second":81,"amount":-0.5947265625},{"first":89,"second":83,"amount":-0.328125},{"first":89,"second":84,"amount":0.3486328125},{"first":89,"second":85,"amount":-1.96875},{"first":89,"second":86,"amount":0.369140625},{"first":89,"second":87,"amount":0.3486328125},{"first":89,"second":88,"amount":0.2666015625},{"first":89,"second":89,"amount":0.369140625},{"first":89,"second":97,"amount":-1.4970703125},{"first":89,"second":99,"amount":-1.3330078125},{"first":89,"second":100,"amount":-1.3330078125},{"first":89,"second":101,"amount":-1.3330078125},{"first":89,"second":103,"amount":-1.3330078125},{"first":89,"second":109,"amount":-0.8203125},{"first":89,"second":110,"amount":-0.8203125},{"first":89,"second":111,"amount":-1.3330078125},{"first":89,"second":112,"amount":-0.8203125},{"first":89,"second":113,"amount":-1.3330078125},{"first":89,"second":115,"amount":-1.189453125},{"first":89,"second":117,"amount":-0.7998046875},{"first":89,"second":118,"amount":-0.41015625},{"first":89,"second":120,"amount":-0.4716796875},{"first":89,"second":121,"amount":-0.41015625},{"first":89,"second":122,"amount":-0.615234375},{"first":90,"second":65,"amount":0.2666015625},{"first":90,"second":67,"amount":-0.533203125},{"first":90,"second":71,"amount":-0.533203125},{"first":90,"second":79,"amount":-0.533203125},{"first":90,"second":81,"amount":-0.533203125},{"first":90,"second":99,"amount":-0.4306640625},{"first":90,"second":100,"amount":-0.4306640625},{"first":90,"second":101,"amount":-0.4306640625},{"first":90,"second":103,"amount":-0.4306640625},{"first":90,"second":111,"amount":-0.4306640625},{"first":90,"second":113,"amount":-0.4306640625},{"first":90,"second":117,"amount":-0.3896484375},{"first":90,"second":118,"amount":-0.5537109375},{"first":90,"second":121,"amount":-0.5537109375},{"first":91,"second":74,"amount":-0.369140625},{"first":91,"second":85,"amount":-0.369140625},{"first":97,"second":34,"amount":-1.3740234375},{"first":97,"second":39,"amount":-1.3740234375},{"first":97,"second":118,"amount":-0.3076171875},{"first":97,"second":121,"amount":-0.3076171875},{"first":98,"second":34,"amount":-0.5947265625},{"first":98,"second":39,"amount":-0.5947265625},{"first":98,"second":118,"amount":-0.2255859375},{"first":98,"second":120,"amount":-0.3076171875},{"first":98,"second":121,"amount":-0.2255859375},{"first":98,"second":122,"amount":-0.3076171875},{"first":99,"second":34,"amount":-0.2255859375},{"first":99,"second":39,"amount":-0.2255859375},{"first":101,"second":34,"amount":-0.287109375},{"first":101,"second":39,"amount":-0.287109375},{"first":101,"second":118,"amount":-0.2666015625},{"first":101,"second":121,"amount":-0.2666015625},{"first":102,"second":34,"amount":0.328125},{"first":102,"second":39,"amount":0.328125},{"first":102,"second":41,"amount":0.41015625},{"first":102,"second":93,"amount":0.369140625},{"first":102,"second":99,"amount":-0.4921875},{"first":102,"second":100,"amount":-0.4921875},{"first":102,"second":101,"amount":-0.4921875},{"first":102,"second":103,"amount":-0.4921875},{"first":102,"second":113,"amount":-0.4921875},{"first":102,"second":125,"amount":0.3896484375},{"first":104,"second":34,"amount":-2.1328125},{"first":104,"second":39,"amount":-2.1328125},{"first":107,"second":99,"amount":-0.41015625},{"first":107,"second":100,"amount":-0.41015625},{"first":107,"second":101,"amount":-0.41015625},{"first":107,"second":103,"amount":-0.41015625},{"first":107,"second":113,"amount":-0.41015625},{"first":109,"second":34,"amount":-2.1328125},{"first":109,"second":39,"amount":-2.1328125},{"first":110,"second":34,"amount":-2.1328125},{"first":110,"second":39,"amount":-2.1328125},{"first":111,"second":34,"amount":-2.7890625},{"first":111,"second":39,"amount":-2.7890625},{"first":111,"second":118,"amount":-0.3076171875},{"first":111,"second":120,"amount":-0.4306640625},{"first":111,"second":121,"amount":-0.3076171875},{"first":111,"second":122,"amount":-0.328125},{"first":112,"second":34,"amount":-0.5947265625},{"first":112,"second":39,"amount":-0.5947265625},{"first":112,"second":118,"amount":-0.2255859375},{"first":112,"second":120,"amount":-0.3076171875},{"first":112,"second":121,"amount":-0.2255859375},{"first":112,"second":122,"amount":-0.3076171875},{"first":114,"second":34,"amount":0.328125},{"first":114,"second":39,"amount":0.328125},{"first":114,"second":44,"amount":-2.5224609375},{"first":114,"second":46,"amount":-2.5224609375},{"first":114,"second":97,"amount":-0.8203125},{"first":114,"second":99,"amount":-0.3896484375},{"first":114,"second":100,"amount":-0.3896484375},{"first":114,"second":101,"amount":-0.3896484375},{"first":114,"second":103,"amount":-0.3896484375},{"first":114,"second":111,"amount":-0.41015625},{"first":114,"second":113,"amount":-0.3896484375},{"first":114,"second":118,"amount":0.369140625},{"first":114,"second":121,"amount":0.369140625},{"first":116,"second":111,"amount":-0.41015625},{"first":118,"second":34,"amount":0.3076171875},{"first":118,"second":39,"amount":0.3076171875},{"first":118,"second":44,"amount":-2.1943359375},{"first":118,"second":46,"amount":-2.1943359375},{"first":118,"second":97,"amount":-0.3076171875},{"first":118,"second":99,"amount":-0.2666015625},{"first":118,"second":100,"amount":-0.2666015625},{"first":118,"second":101,"amount":-0.2666015625},{"first":118,"second":103,"amount":-0.2666015625},{"first":118,"second":111,"amount":-0.3076171875},{"first":118,"second":113,"amount":-0.2666015625},{"first":119,"second":44,"amount":-2.54296875},{"first":119,"second":46,"amount":-2.54296875},{"first":120,"second":99,"amount":-0.41015625},{"first":120,"second":100,"amount":-0.41015625},{"first":120,"second":101,"amount":-0.41015625},{"first":120,"second":103,"amount":-0.41015625},{"first":120,"second":111,"amount":-0.41015625},{"first":120,"second":113,"amount":-0.41015625},{"first":121,"second":34,"amount":0.3076171875},{"first":121,"second":39,"amount":0.3076171875},{"first":121,"second":44,"amount":-2.1943359375},{"first":121,"second":46,"amount":-2.1943359375},{"first":121,"second":97,"amount":-0.3076171875},{"first":121,"second":99,"amount":-0.2666015625},{"first":121,"second":100,"amount":-0.2666015625},{"first":121,"second":101,"amount":-0.2666015625},{"first":121,"second":103,"amount":-0.2666015625},{"first":121,"second":111,"amount":-0.3076171875},{"first":121,"second":113,"amount":-0.2666015625},{"first":122,"second":99,"amount":-0.328125},{"first":122,"second":100,"amount":-0.328125},{"first":122,"second":101,"amount":-0.328125},{"first":122,"second":103,"amount":-0.328125},{"first":122,"second":111,"amount":-0.328125},{"first":122,"second":113,"amount":-0.328125},{"first":123,"second":74,"amount":-0.41015625},{"first":123,"second":85,"amount":-0.41015625}]}'),r=t.t(s,2);const w=String.fromCharCode(26);function isNewline(e){return!!/[\n\r]/.test(e)}function equalStyle(e,t,s,i){return!((e||t)&&(e?t?(e.font||s)!==(t.font||s)||(e.size||i)!==(t.size||i)||e.color!==t.color||!!e.bold!=!!t.bold||!!e.italic!=!!t.italic:e.font!==s||e.size!==i||e.color||e.bold||e.italic:t.font!==s||t.size!==i||t.color||t.bold||t.italic))}class MetricCache{constructor(){this.cache=[new Map],this.maxMaps=4,this.limit=256}makeKey(e,t,s){t={font:t,size:s,style:e.style,styles:e.styles,text:e.text};return JSON.stringify(t)}lookup(t){for(let e=0;e<this.cache.length;e++){var s=this.cache[e].get(t);if(s)return{...s}}return null}update(e,t){var s=this.cache[this.cache.length-1];s.set(e,t),s.size>=this.limit&&(this.cache.length===this.maxMaps&&(e=Math.floor(Math.random()*this.cache.length),this.cache.splice(e,1)),this.cache.push(new Map))}}const n=new class MSDFFontRegistry{constructor(){this.layouts=new Map}hasLayout(e){return this.layouts.get(e)}addLayout(e,t){return this.layouts.set(e,t),t}measureText(e,t,s){t=this.layouts.get(t);return t?t.measureText(e.text):{ascent:36,height:50,descent:14,width:20*e.text.length}}getInfo(e,t){e=this.layouts.get(e);let s;return(s=e?e._opt.font:s)||{common:{lineHeight:t}}}};class Measurer{constructor(){this.cache=new MetricCache}measureText(e,t,s){var i=this.cache.makeKey(e,t,s),a=this.cache.lookup(i);return a||(a=n.measureText(e,t,s),this.cache.update(i,a)),a}lineHeight(e,t){e=n.getInfo(e,t);return e.common?e.common.lineHeight:e.atlas.size}}class Wrap{splitWords(e,i,a){var t,r=e=>!!/[ \f\n\r\t\v\u00A0\u2028\u2029]/.test(e),o=(e,t,s)=>{s&&1<s.length?l.push(Object.assign(e,{styles:s})):s&&1===s.length?l.push(Object.assign(e,{style:s[0].style})):t?l.push(Object.assign(e,{style:t})):l.push(e)},n=(e,t)=>{var s;return e?(equalStyle((s=e[e.length-1]).style,t.style,i,a)?s.end=t.end:e.push(t),e):[t]};let l=[],h,d=0,c="",u=null,p,m;for(let s=0;s<e.length-1;s++){void 0===h&&(h=!r(e[0].text[0]));var f,v,g=e[s],y=g.text;p=g.style,h=h||!r(y[0]);let t=0;for(let e=0;e<y.length;e++)0===d&&0===s&&0===e||(h?r(y[e])&&(m=y.slice(t,e),f=0<c.length&&0===m.length,0<c.length&&(0<m.length&&(v={start:c.length,end:c.length+m.length,style:p},u=n(u,v)),m=c+m,c=""),o({start:d,end:d+m.length,text:m},f?null:p,u),d+=m.length,t=e,h=!1,u=null):(0<e&&(o({start:d,end:d+1,text:y[e-1],style:p,styles:u}),d+=1,t+=1),r(y[e])||(h=!0)));1===(m=y.slice(t,y.length)).length&&r(m)?(o({start:d,end:d+1,text:m,style:p,styles:u}),d+=1):(g={start:c.length,end:c.length+m.length,style:p},u=n(u,g),c+=m)}let s=d;return 0<c.length&&(s=d+c.length,t={start:d,end:s,text:c},u&&1===u.length&&equalStyle(p,u[0].style,i,a)?o(t,p):o(t,null,u)),o({start:s,end:s+1,text:w}),l}mergeRect(e,t){return e?t?{width:e.width+t.width,height:Math.max(e.height,t.height),ascent:Math.max(e.ascent,t.ascent)}:e:t}wrap(e,t,s,i,a,r){var o=t-(r=r||{left:0,top:0,right:0,bottom:0}).left-r.right;let n=[],l=0,h=0,d=[],c=r.left,u=r.top;var p=this.splitWords(e,i,a),m=()=>{0!==n.length&&(n.forEach(e=>{e.ascent=h}),d.push(n),n=[],c=r.left,u+=l,l=0,h=0)};for(let t=0;t<p.length-1;t++){var f=p[t];let e;isNewline(f.text)?(e=s.measureText(f,i,a),t===p.length-1?m():(l=Math.max(l,e.height),h=Math.max(h,e.ascent)),e.left=c,e.top=u,Object.assign(f,e),n.push(f),m(),l=0,h=0):(e=s.measureText(f,i,a),l=Math.max(l,e.height),h=Math.max(h,e.ascent),e.width+c>o&&m(),e.left=c,e.top=u,Object.assign(f,e),c+=e.width,n.push(f))}m();t=p[p.length-1],e=s.measureText(t,i,a);return l=Math.max(l,e.height),h=Math.max(h,e.ascent),e.left=r.left,e.top=u,Object.assign(t,e),n.push(t),m(),[d,p]}}function maybeSelectCommentOrLine(e){var t,s=e.selection,{row:i,column:a}=s.lead,r=e.selectionOrLineString();s.isEmpty()&&(-1===(t=r.indexOf("//"))||a<t||0<t&&0<=":\"'".indexOf(r[t-1])?e.selectLine(i):s.range={start:{row:i,column:t+2},end:{row:i,column:r.length}})}function doEval(e,t,s,i){t=t||(e.selection.isEmpty()?e.lineRange():e.selection.range),i||e.textInRange(t)}Object.assign({},{"clipboard copy":{doc:"placeholder for native copy",exec:e=>!1},"clipboard cut":{doc:"placeholder for native cut",exec:e=>!1},"clipboard paste":{doc:"placeholder for native paste",exec:e=>!1}},{doit:{doc:"Evaluates the selected code or the current line and report the result",exec:async(e,t,s=1)=>{maybeSelectCommentOrLine(e);let i,a;try{t=Object.assign({},t,{inspect:!0,inspectDepth:s}),i=await doEval(e,void 0),a=i.isError?i.value:null}catch(e){a=e}return a&&console.log("**"+a),i}},printit:{doc:"Evaluates selected code or the current line and inserts the result in a printed representation",exec:async(e,t)=>{maybeSelectCommentOrLine(e);let s,i;try{t=Object.assign({},t,{asString:!0}),s=await doEval(e,void 0),i=s.isError?s.value:null}catch(e){i=e}return e.selection.collapseToEnd(),e.insertTextAndSelect(i?String(i)+(i.stack?"\n"+i.stack:""):String(s.value)),s}}});function WI(e){return/^[0-9]+$/.test(e)}let l=[[""],["shift"],["alt"],["alt","shift"],["ctrl"],["ctrl","shift"],["ctrl","alt"],["ctrl","alt","shift"],["meta"],["meta","shift"],["meta","alt"],["meta","alt","shift"],["meta","ctrl"],["meta","ctrl","shift"],["meta","ctrl","alt"],["meta","shift","alt","shift"]],h={shift:1,alt:2,option:2,control:4,ctrl:4,super:8,win:8,meta:8,command:8,cmd:8};function cap(e){return e[0].toUpperCase()+e.slice(1)}function eventToKeyCombo(e,t,s){let i=s.key,a=s.keyIdentifier;if(0<=["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(s.key))return s.key;if(0<=[10,13,8,46].indexOf(s.keyCode))return s.key;if(0===e||1===e)return null;if(!i&&a&&(i=function decodeKeyIdentifier(e,t){let s=e,i=s&&s.replace(/u\+?([\d\w]{4})/gi,(e,t)=>String.fromCharCode(parseInt(t,16)));return" "===(i="Command"!==i&&"Cmd"!==i?i:"Meta")&&(i="Space"),i=8===t?"Backspace":i}(a,s.which||s.keyCode),s.key=i=i[s.shiftKey?"toUpperCase":"toLowerCase"](),function isModifier(e){return!WI(e)&&(e=e.replace(/-$/,"").toLowerCase(),h[e])}(i)))return cap(i[0]);e=l[e];s.code&&(i=function identifyKeyFromCode(e){var t=e.code;if("string"!=typeof t)return null;if(t.startsWith("Key"))return t.slice(3);if(t.startsWith("Numpad"))return t;if(t.startsWith("Digit"))return t.slice(5);if(t.startsWith("Arrow"))return t.slice(5);if(t.match(/^F[0-9]{1-2}$/))return t;switch(t){case"Insert":case"Home":case"PageUp":case"PageDown":return t;case"Period":return".";case"Comma":return",";case"Help":return"Insert";case"Equal":return"=";case"Backslash":case"IntlBackslash":return"\\";case"Minus":return"-";case"BracketRight":return"]";case"BracketLeft":return"[";case"Quote":return"'";case"Backquote":return"`";case"Semicolon":return";";default:return null}}(s)||i);let r=e.map(cap).join("-");return t||(r+=i?"-"+i:""),r}function canonicalizeKeyboardEvent(s){let i=0,a={keyCombo:"",key:"",shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:s.type,keyCode:s.keyCode};Object.keys(h).forEach(e=>{var t=e+"Key";s[t]&&(i|=h[e],a[t]=!0)}),h[s.key.toLowerCase()]&&(a.onlyModifiers=!0);var e=eventToKeyCombo(i,a.onlyModifiers,s);if(!e)return null;if(0===i||1===i)a.keyCombo=e,a.key=s.key,1===i&&(a.onlyShiftModifier=!0,a.isModified=!0);else if(1<i&&(a.isModified=!0),a.onlyModifiers)a.keyCombo=e,a.key=s.key,a.onlyModifiers=!0;else{var t=function canonicalizeFunctionKey(e){switch(e=e.toLowerCase()){case"space":e="space";break;case"esc":e="escape";break;case"return":e="enter";break;case"arrowleft":e="left";break;case"arrowright":e="right";break;case"arrowup":e="up";break;case"arrowdown":e="down"}return["backspace","tab","enter","pause","escape"," ","pageup","pagedown","end","home","left","up","right","down","print","insert","delete","numpad0","numpad1","numpad2","numpad3","numpad4","numpad5","numpad6","numpad7","numpad8","numpad9","numpadenter","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","numlock","scrolllock"].includes(e)?cap(e):""}(s.key);if(t)a.isFunctionKey=!0,a.key=t;else{if(!a.isModified)return null;a.onlyShiftModifier?a.key=s.key:a.key=s.key[0].toUpperCase()+s.key.slice(1)}a.keyCombo=e}return a}let c=0;function runLength(e){return e.map(e=>e.text).reduce((e,t)=>t.length+e,0)}class Doc{constructor(e){this.runs=[],this.intervals=[],this.selections={},this.defaultFont=e.defaultFont||"Roboto",this.defaultSize=e.defaultSize||10}load(e){this.canonicalize(e)}setDefault(e,t){this.defaultFont=e||this.defaultFont,this.defaultSize=t||this.defaultSize}doEvent(e){"insert"===e.type?this.doInsert(e.user,e.runs):"delete"===e.type?this.doDelete(e.user,e.backspace):"select"===e.type?this.doSelect(e.user,e.start,e.end,e.isBol):"setStyle"===e.type&&this.doSetStyle(e.user,e.style,e.merge)}doInsert(t,s){var i=this.ensureSelection(t),a=0<s.length&&"\n"===s[s.length-1].text;if(i.start===i.end){let[,e]=this.findRun(i.start);var r=this.intervals[e];r.end!==i.start&&r.start!==i.start?(this.splitRunAt(e,i.start-r.start),e+=1):r.end===i.start&&(e+=1),this.runs.splice(e,0,...s),this.canonicalize(this.runs,r.start),this.updateSelectionsInsert(t,i.start,runLength(s),a)}else this.doDelete(t,!0),this.doInsert(t,s)}doDelete(e,t){var s=this.ensureSelection(e);let i,a;var r=this.length();if(s.start===s.end){if(!t&&s.start===r||t&&0===s.start)return;a=t?(i=s.start-1,s.end):(i=s.start,s.end+1)}else i=s.start,a=s.end;let[,o]=this.findRun(i);r=this.intervals[o];r.end!==i&&(this.splitRunAt(o,i-r.start),o+=1);let[,n]=this.findRun(a);t=this.intervals[n],s=a-t.start;a!==t.end&&0!=s?(this.splitRunAt(n,s),n+=1):a===t.end&&(n+=1),this.runs.splice(o,n-o),this.canonicalize(this.runs),this.updateSelectionsDelete(e,i,a)}doSelect(e,t,s,i){this.selections[e.id]={start:t,end:s,isBol:i,color:e.color}}doSetStyle(r,o,n){r=this.selections[r.id];if(r.start!==r.end){var l,h=r.start,d=r.end;let[e,t]=this.findRun(h),s=this.intervals[t],i=(s.start!==h&&this.splitRunAt(t,h-s.start),[e,t]=this.findRun(d),(s=this.intervals[t]).end!==d&&this.splitRunAt(t,d-s.start),h),a=0;for(;i<d&&a<1e4;)a++,[e,t]=this.findRun(i),(s=this.intervals[t]).end<=d&&(l=n?{...e.style,...o}:{...o},e.style=l,i=s.end);this.canonicalize(this.runs)}}length(){return this.intervals[this.intervals.length-1].end-1}copyRun(e){var t;return e&&((t={}).text=e.text,e.style&&(t.style=e.style),t)}canonicalize(i){let a=[],r=[],o=0;var n,l,h=()=>{a.push({text:w}),r.push({start:o,end:o+1})};if(0===i.length)h();else{let e=this.copyRun(i[0]),t=1,s=this.copyRun(i[t]);for(;s&&s.text!==w;)equalStyle(e.style,s.style)?e.text+=s.text:(n=o+e.text.length,l={start:o,end:n},o=n,a.push(e),r.push(l),e=s),t++,s=this.copyRun(i[t]);var d=o+e.text.length,c={start:o,end:d};a.push(e),r.push(c),o=d,a[a.length-1].text!==w&&h()}this.runs=a,this.intervals=r}styleAt(e){var[e,,]=this.findRun(e);return e.style}save(e,t){var s,i,a,r,o=this.runs,n=this.intervals,e=void 0!==e?e:0,t=void 0!==t?t:this.length();let l,h,d;if([s,i]=this.findRun(e),[a,r]=this.findRun(t),i===r)return d=n[i],[h=this.copyRun({text:s.text.slice(e-d.start,t-d.start)})];var c=[];l=s,d=n[i],h=this.copyRun({text:l.text.slice(e-d.start)},!0),c.push(h);for(let e=i+1;e<=r-1;e++)h=this.copyRun(o[e]),c.push(h);return d=n[r],(h=this.copyRun({text:a.text.slice(0,t-d.start)})).text!==w&&c.push(h),c}plainText(e,t){return this.save(e,t).map(e=>e.text).join("")}splitRunAt(e,t){var s=this.runs[e],i=this.intervals[e],a=this.copyRun({text:s.text.slice(0,t),style:s.style}),s=this.copyRun({text:s.text.slice(t,s.text.length),style:s.style});this.runs.splice(e,1,a,s),a={start:i.start,end:i.start+t},s={start:i.start+t,end:i.end},this.intervals.splice(e,1,a,s)}findRun(t){var s=this.runs,i=this.intervals;let a;for(let e=0;e<s.length;e++)if((a=i[e]).start<=t&&t<a.end)return[s[e],e];return t===a.end?[s[s.length-1],s.length-1]:[null,null]}updateSelectionsInsert(e,t,s,i){for(var a in this.selections){var r=this.selections[a];a===e.id?this.selections[a]={start:t+s,end:t+s,isBol:i,color:e.color}:t<r.start?this.selections[a]={start:r.start+s,end:r.end+s,isBol:i,color:r.color}:r.start<t&&t<r.end&&(this.selections[a]={start:r.start,end:r.end+s,isBol:i,color:r.color})}}updateSelectionsDelete(e,t,s){var i,a=s-t;for(i in this.selections){var r=this.selections[i],[r,,]=(i===e.id?this.selections[i]={start:t,end:t,color:e.color}:s<=r.start?this.selections[i]={start:r.start-a,end:r.end-a,color:r.color}:r.end<=t||(t<=r.start&&r.end<=s?this.selections[i]={start:t,end:t,color:r.color}:t<r.start&&s<r.end?this.selections[i]={start:t,end:r.end-a,color:r.color}:r.start<=t&&s<r.end?this.selections[i]={start:r.start,end:r.end-a,color:r.color}:r.start<=t&&t<r.end&&(this.selections[i]={start:r.start,end:t,color:r.color})),this.findRun(this.selections[i].start-1));this.selections[i].isBol=r&&isNewline(r.text[r.text.length-1])}}setSelections(e){this.selections=JSON.parse(JSON.stringify(e))}getSelections(){return JSON.parse(JSON.stringify(this.selections))}ensureSelection(e){let t=this.selections[e.id];return t||(t={start:0,end:0,color:e.id},this.selections[e.id]=t),t}snapshotFrom(e,t,s){return{type:"snapshot",user:t,content:{runs:e.runs,selections:JSON.parse(JSON.stringify(e.selections))},timezone:s}}undoEvent(i,e,t){var s=e.queue,a=i.user;var r=function findLast(t,s){for(let e=t.length-1;0<=e;e--)if(t[e].user.id===s.user.id&&t[e].timezone===i.timezone&&"snapshot"!==t[e].type)return e;return-1}(s,i);if(!(r<0)){var o=s[r],n=function findSnapshot(e,t){for(;0<=t;t--)if("snapshot"===e[t].type)return t;return-1}(s,r);if(!(n<0)){var l=s[n].content,h=(t.load(l.runs),t.setSelections(l.selections),[]);for(let e=0;e<=n;e++)h.push(s[e]);for(let e=n+1;e<r;e++)t.doEvent(s[e]),h.push(s[e]);for(let e=r+1;e<s.length;e++)"snapshot"!==s[e].type&&(t.doEvent(s[e]),h.push(s[e]));e.timezone++,o.timezone=e.timezone,e.undoStacks[a.id]||(e.undoStacks[a.id]=[]),e.undoStacks[a.id].push(o),e.selections=t.getSelections(),e.runs=t.save(),e.queue=h}}return e.timezone}receiveEditEvents(e,s,t){let i=s.queue;var a=e[0].user;if(s.timezone%10==0&&i.push(this.snapshotFrom(s,a,s.timezone)),s.timezone++,0<i.length&&i[i.length-1].timezone>e[0].timezone+60)return[s.timezone,!1];let r=[];var o,n={...s.selections};let l=function findFirst(t,s){if(0!==t.length){if(t[i.length-1].timezone<s.timezone)return t.length;for(let e=t.length-1;0<=e;e--)if(t[e].timezone<s.timezone)return e+1}return 0}(i,e[0]);e.forEach(e=>{let t=e;if(0<=l)for(let e=l;e<i.length;e++)t=function transform(e,t){if("select"===e.type){if("insert"===t.type)return t.pos<=e.start?{...e,start:e.start+t.length,end:e.end+t.length}:e.start<=t.pos&&t.pos<=e.end?{...e,end:e.end+t.length}:e;if("delete"===t.type){if(e.end<=t.start)return e;if(t.start<=e.start&&e.end<=t.end)return{...e,start:t.start,end:t.start};if(t.end<=e.start)return e;if(e.start<=t.start&&e.end<t.end)return{...e,end:t.start};if(t.start<=e.start&&t.end<e.end)return{...e,start:t.start,end:e.end-t.end}}if("select"===t.type);}return e}(t,i[e]);t.timezone=s.timezone,r.push(t)}),i.push(...r),l=i.findIndex(e=>e.timezone>s.timezone-60);for(let e=i.length-1;0<=e;e--)delete n[i[e].user.id];for(o in n)delete s.selections[o],delete s.undoStacks[o];i.splice(0,l),t.setSelections(s.selections);let h=!1;return r.forEach(e=>{h=h||"insert"===e.type||"delete"===e.type,t.doEvent(e)}),s.runs=t.save(),s.selections=t.getSelections(),[s.timezone,h]}}class Warota{constructor(e,t){this.doc=t||new Doc,this._width=0,e.margins?this.margins=e.margins:this.margins=e.margins={left:0,top:0,right:0,bottom:0},this.options=e,this.scrollLeft=0,this.scrollTop=0,this.relativeScrollBarWidth=.02,this.showsScrollbar=e.showScrollBar,this.isScrollable=!0,this.resize(e.width,e.height),this.resizeToNumLinesOrFontSize(e),this.events=[],this.timezone=0}resetEvents(){this.events=[]}width(e){return void 0===e?this._width:(this._width=e,null)}setTimezone(e){this.timezone=e}resize(e,t){this.screenWidth=e,this.screenHeight=t}resizeToNumLinesOrFontSize(e){this.defaultMeasurer=new Measurer;var t=this.defaultMeasurer.lineHeight(e.font,e.fontSize),s=e.margins.top+e.margins.bottom,i=e.height-s,i=(e.fontSize?e.numLines=i/e.fontSize:(e.numLines||(e.numLines=10),e.fontSize=i/e.numLines),e.numLines*t),i=i+s*(e.fontSize/t),s=(this.pixelY=i)/this.screenHeight;this.pixelX=this.screenWidth*s,this.pixelX*this.relativeScrollBarWidth<=30&&(this.relativeScrollBarWidth=30/this.pixelX),this.width(this.pixelX*(1-(this.showsScrollbar?this.relativeScrollBarWidth:0))),this.lineHeight=t}resetMeasurer(){this.defaultMeasurer=new Measurer}layout(){(void 0===this.lastFontLoadedTimeChecked||this.lastFontLoadedTimeChecked<c)&&(this.resetMeasurer(),this.lastFontLoadedTimeChecked=c);var e=this.options||{},t=e.singleLine?Number.MAX_VALUE:this._width,s=this.margins.left+this.margins.right,i=this.margins.top+this.margins.bottom,[t,a]=(new Wrap).wrap(this.doc.runs,t,this.defaultMeasurer,this.doc.defaultFont,this.doc.defaultSize,this.options.margins);this.lines=t,this.words=a,this.hasLastEnter=!1,0<=this.lines.length-2&&(a=(a=this.lines[this.lines.length-2])[a.length-1],this.hasLastEnter=isNewline(a.text));let r;r=e.singleLine?t[0][t[0].length-1]:t[t.length-1][0],e.autoResize&&(this.newWidth=r.left+r.width+s,this.newHeight=r.top+r.height+i),this.docHeight=r.top+r.height}visibleBounds(){var e=this.docHeight;return{left:this.scrollLeft*this.pixelX,top:this.scrollTop*e,width:this.pixelX,height:this.pixelY}}visibleTextBounds(){var e=this.visibleBounds(),t=e.width*(1-(this.showsScrollbar?this.relativeScrollBarWidth:0)),s=e.height;return{l:e.left,t:e.top,w:t,h:e.height,b:e.top+s,r:e.left+t}}draw(i,e){let{left:t,top:a,width:r,height:o}=e;this.words.forEach(s=>{if(!(s.left+s.width<t||s.top>a+o||s.top+s.height<a||s.left>t+r))if(s.styles){let t=s.left;s.styles.forEach(e=>{i.fillStyle=e.style||{color:"black"},i.fillText(s.text.slice(e.start,e.end),t,s.top+s.ascent),t+=e.width})}else i.fillStyle=s.style||"black",i.fillText(s.text,s.left,s.top+s.ascent)})}drawSelections(t){for(var e in t.save(),this.doc.selections){var s,e=this.doc.selections[e];e.end===e.start?(t.fillStyle="barSelection "+e.color,s=this.barRect(e),t.fillRect(s.left,s.top,s.width,s.height)):(t.fillStyle="boxSelection "+e.color,this.selectionRects(e).forEach(e=>{t.fillRect(e.left,e.top,e.width,e.height)}))}t.restore()}drawScrollbar(e){var{l:t,t:s,h:i,w:a}=this.scrollbarBounds();e.save(),e.fillStyle="scrollBar",e.fillRect(t,0,a,this.pixelY),e.fillStyle="scrollKnob",e.fillRect(t+3,s,a-6,i),e.restore()}scrollbarBounds(){var{pixelX:e,pixelY:t,scrollTop:s,relativeScrollBarWidth:i}=this,a=t/this.docHeight,i=e*(this.showsScrollbar?i:0);return{l:e-i,t:s*t,w:i,h:1<a?t-3:Math.max(t/100*5,t*a-6)}}scrollBy(e,t){this.setScroll(this.scrollLeft=e,this.scrollTop+t)}setScroll(e,t){var{pixelY:s,docHeight:i}=this;this.scrollTop=Math.max(0,Math.min(1-s/i,t))}findLine(s,e,i){var t=this.lines;if(void 0!==e&&void 0!==i){let e=t.findIndex(e=>{var t=e.reduce((e,t)=>Math.max(e,t.height),0),e=e[0];return e.top<=i&&i<e.top+t});return[t[e=e<0?t.length-1:e],e]}let a=t.findIndex(e=>{var t=e[0],e=e[e.length-1];return t.start<=s&&s<e.end});return[t[a=a<0?t.length-1:a],a]}findWord(t,s,i){if(void 0!==s&&void 0!==i){var[a,,]=this.findLine(t,s,i);let e=a.findIndex(e=>e.left<=s&&s<e.left+e.width);return a[e=e<0?s<a[0].left?0:a.length-1:e]}var[a,,]=this.findLine(t,s,i);let e=a.findIndex(e=>e.start<=t&&t<e.end);return a[e=e<0?s<a[0].left?0:a.length-1:e]}insert(e,t){e=Event.insert(e,t,this.timezone);this.events.push(e)}delete(e,t){e=Event.delete(e,t,this.timezone);this.events.push(e)}select(e,t,s,i){e=Event.select(e,t,s,i,this.timezone);this.lastSelect={start:t,end:s},this.events.push(e)}setStyle(e,t,s){e=Event.setStyle(e,t,s);this.events.push(e)}doEvent(e){this.doc.doEvent(e),this.layout()}positionFromIndex(e){var t,s,i=this.findWord(e);return 0===e&&i.text===w?{left:0+((s=this.margins||{}).left||0),top:0+(s.top||0),width:0,height:i.height}:(s=e-i.start,(e={...i}).text=i.text.slice(0,s),t=this.defaultMeasurer.measureText(e,this.doc.defaultFont,this.doc.defaultSize),e.text=i.text.slice(0,1+s),s=this.defaultMeasurer.measureText(e,this.doc.defaultFont,this.doc.defaultSize),{left:i.left+t.width,top:i.top,width:s.width-t.width,height:i.height})}indexFromPosition(e,t){var s=this.findWord(null,e,t);let i=0;var a=e-s.left;if(a<0)return s.start;if(s.text===w)return s.start;if(isNewline(s.text))return s.start;var r={...s};for(let e=0;e<=s.text.length;e++){r.text=s.text.slice(0,0!==e?e:1);var o,n=((o=this.defaultMeasurer.measureText(r,this.doc.defaultFont,this.doc.defaultSize)).width-i)/2;if(i<=a&&a<i+n)return s.start+(0===e?0:e-1);if(i+n<=a&&a<o.width)return s.start+e;i=o.width}return s.end}isBol(e,t){var s,[t,,]=this.findLine(null,e,t),t=t[0];return e<t.left||(t.text===w?this.hasLastEnter:((s={...t}).text=t.text.slice(0,1),s=this.defaultMeasurer.measureText(s,this.doc.defaultFont,this.doc.defaultSize).width/2,e-t.left<s))}changeLine(e,t,s){var[,i]=this.findLine(t);return 0<s&&i===this.lines.length-2?this.hasLastEnter?this.lines[this.lines.length-1][0].start:t:(t=this.positionFromIndex(t),(i=i+s)<0?0:i>=this.lines.length?this.lines[this.lines.length-1][0].start:1!==(s=this.lines[i]).length||1!==s[0].text.length||"\n"!==s[0].text&&"\r"!==s[0].text?this.indexFromPosition(t.left,s[0].top):s[0].start)}lineHeightAt(e){var t;return 0===this.doc.length()?this.defaultMeasurer.measureText({text:"x"},this.doc.defaultFont,this.doc.defaultSize).height:([e,t]=this.findLine(e),e.reduce((e,t)=>Math.max(t.height,e),0))}barRect(e){let t=e.start;var s,i,a;return 0===t?(a=this.positionFromIndex(t),i=this.lineHeightAt(t),{left:a.left-1,top:a.top,width:2,height:i}):t===this.doc.length()?e.isBol?(a=this.positionFromIndex(t),i=this.lineHeightAt(t),{left:a.left-1,top:a.top,width:2,height:i}):([a,s]=this.findLine(t-1),t=a[a.length-1].end-1,i=this.positionFromIndex(t),a=this.lineHeightAt(t),{left:i.left+i.width-1,top:i.top,width:2,height:a}):(i=this.positionFromIndex(t),a=this.lineHeightAt(t),e.isBol,{left:i.left-1,top:i.top,width:2,height:a})}selectionRects(e){let{start:t,end:s}=e;var[e,i]=this.findLine(t);let[a,r]=this.findLine(s);if(void 0===e||void 0===a)return[];if(i===r)return e=this.positionFromIndex(t),o=this.positionFromIndex(s),h=this.lineHeightAt(t),[{left:e.left,top:e.top,width:o.left-e.left,height:h}];var o=[];let n=this.positionFromIndex(t);var l,e=this.lineHeightAt(t),h=(s===this.doc.length()&&isNewline((h=this.findWord(s-1)).text[h.length-1])&&(s--,[l,h]=this.findLine(s),r=h),this.options.margins.right+this.options.margins.left),d=this.positionFromIndex(s);this.lineHeightAt(s);return o.push({left:n.left,top:n.top,width:this.width()-n.left-h,height:e}),2<=r-i&&(n=this.lines[i+1][0],o.push({left:this.options.margins.left,top:n.top,width:this.width()-h,height:d.top-n.top})),n=this.lines[r][0],e=this.lineHeightAt(s),o.push({left:this.options.margins.left,top:d.top,width:d.left-this.options.margins.left,height:e}),o}isScrollbarClick(e,t){var s;return!!this.showsScrollbar&&(s=this.relativeScrollBarWidth*this.pixelX,this.pixelX-s-3<=e)}mouseDown(e,t,s,i){this.isScrollbarClick(e,t)?this.scrollBarClick={type:"clicked",scrollBarVOffset:t-this.scrollbarBounds().t,scrollBarTopOnDown:this.scrollTop,realStartY:s,startX:e,startY:t}:(s=this.indexFromPosition(e,t),e=this.isBol(e,t),this.extendingSelection=null,this.selectDragStart=s,this.select(i,s,s,e)),this.keyboardX=null}mouseMove(s,i,e,a){if(null!==this.selectDragStart){s=this.indexFromPosition(s,i);let e,t;if(s||0===s){this.focusChar=s,t=this.selectDragStart>s?(this.extendingSelection="top",e=s,this.selectDragStart):(this.extendingSelection="bottom",e=this.selectDragStart,s);i=this.lastSelect;if(i&&(i.start!==e||i.end!==t))return this.select(a,e,t),"selectionChanged"}return null}return this.scrollBarClick?({realStartY:s,scrollBarTopOnDown:i}=this.scrollBarClick,a=this.docHeight,e=(e-s)*Math.max(1,a/this.pixelY)/a+i,this.scrollBarClick.type="move",this.setScroll(0,e),"scrollChanged"):null}mouseUp(e,t,s,i){this.scrollBarClick?(this.scrollBarClick.type,this.scrollBarClick=null,this.wasScrollBarClick=!0):this.wasScrollBarClick=!1,this.selectDragStart=null,this.keyboardX=null,this.lastSelect=null}backspace(e){this.delete(e,!0)}handleKey(e,t,s,i){let{start:a,end:r,isBol:o}=this.doc.selections[e.id]||{start:0,end:0,color:e.color};var n=this.doc.length();let l=!1,h,d;if(s){if(!this.keyboardSelect)switch(t){case 37:case 38:case 36:case 33:this.keyboardSelect=-1;break;case 39:case 40:case 35:case 34:this.keyboardSelect=1}}else this.keyboardSelect=0;let c=1===this.keyboardSelect?r:a;var u,p,m=c;let f,v=!1;switch(t){case 37:s||a===r?0<c&&c--:c=a,o=!1,v=!0;break;case 39:s||a===r?c<n&&([g,y]=this.findLine(c),h=g,d=y,c++):c=r,v=!0;break;case 40:var[g,y]=this.findLine(c);h=g,d=y,c=this.changeLine(e,c,1),f=m===c,v=!0;break;case 38:c=this.changeLine(e,c,-1),o=!1,v=!0;break;case 8:case 46:this.backspace(e),l=!0}if(v){switch(this.keyboardSelect){case 0:a=r=c;break;case-1:a=c;break;case 1:r=c}a===r&&(this.keyboardSelect=0),a>r&&(this.keyboardSelect=-this.keyboardSelect,p=r,r=a,a=p),h&&([u,p]=this.findLine(c),o=d!==p&&this.hasLastEnter||f),this.select(e,a,r,o),l=!0}return i&&65===t&&(this.select(e,0,n),window.editor=this,l=!0),l}selectionText(e){e=this.doc.selections[e.id];return e?this.doc.plainText(e.start,e.end):""}}class Event{static insert(e,t,s){return{type:"insert",user:e,runs:t,length:runLength(t),timezone:s}}static delete(e,t,s){return{type:"delete",backspace:t,user:e,timezone:s}}static select(e,t,s,i,a){return{type:"select",user:e,start:t,end:s,isBol:i,timezone:a}}static setStyle(e,t,s){return{type:"setStyle",user:e,style:t,merge:s}}}const i=new((0,d.y7)(b.THREE))({font:r});class KeyFocusManager extends o.ViewService{constructor(e){super(e||"KeyFocusManager"),this.setKeyboardInput(null),this.hiddenInput=document.querySelector("#hiddenInput"),this.copyElement=document.querySelector("#copyElement"),this.hiddenInput||(this.hiddenInput=document.createElement("input"),this.hiddenInput.id="hiddenInput",this.hiddenInput.style.setProperty("position","absolute"),this.hiddenInput.style.setProperty("left","-120px"),this.hiddenInput.style.setProperty("top","-120px"),this.hiddenInput.style.setProperty("transform","scale(0)"),this.hiddenInput.style.setProperty("width","100px"),this.hiddenInput.style.setProperty("height","100px"),document.body.appendChild(this.hiddenInput),this.hiddenInput.addEventListener("input",e=>{e.stopPropagation(),this.keyboardInput&&this.keyboardInput.input(e)},!0),this.hiddenInput.addEventListener("keydown",e=>{e.stopPropagation(),this.keyboardInput&&this.keyboardInput.keyDown(e)},!0),this.hiddenInput.addEventListener("copy",e=>{this.keyboardInput&&this.keyboardInput.copy(e)}),this.hiddenInput.addEventListener("paste",e=>{this.keyboardInput&&this.keyboardInput.paste(e)})),this.copyElement||(this.copyElement=document.createElement("input"),this.copyElement.id="copyElement",this.copyElement.style.setProperty("position","absolute"),this.copyElement.style.setProperty("left","-120px"),this.copyElement.style.setProperty("top","-120px"),this.copyElement.style.setProperty("transform","scale(0)"),this.copyElement.style.setProperty("width","100px"),this.copyElement.style.setProperty("height","100px"),document.body.appendChild(this.copyElement))}setKeyboardInput(e){this.hiddenInput&&!e&&this.hiddenInput.blur(),(this.keyboardInput=e)&&this.hiddenInput.focus()}destroy(){this.keyboardInput=null,this.hiddenInput=document.querySelector("#hiddenInput"),this.hiddenInput&&this.hiddenInput.remove(),super.destroy()}}class SyncedStateManager extends o.ViewService{constructor(e){super(e||"SyncedStateManager"),this.isSynced=!1,this.subscribe(this.viewId,"synced","synced")}synced(e){console.log("synced manager",e),this.isSynced=e}}class FontModelManager extends o.ModelService{static defaultFont(){return"Roboto"}init(e){super.init(e||"FontModelManager"),this.fonts=new Map;var{chars:e,common:t,info:s,kernings:i,pages:a}=r;this.askFont({name:s.face,font:{chars:e,common:t,info:s,kernings:i,pages:a}}),this.subscribe(this.id,"askFont",this.askFont),this.loading=new Map,this.subscribe(this.id,"fontLoadStart","fontLoadStart"),this.subscribe(this.id,"fontLoadOne","fontLoadOne"),this.subscribe(this.id,"fontLoadDone","fontLoadDone")}get(e){return this.fonts.get(e)}keys(){return this.fonts.keys()}askFont(e){e.font&&this.fonts.set(e.name,e.font),this.publish(this.id,"fontAsked",e.name)}fontLoadStart({key:e,name:t}){this.loading.set(e,{name:t,array:[]})}fontLoadOne({key:e,buf:t}){e=this.loading.get(e);e?e.array.push(t):console.log("inconsistent message")}fontLoadDone(e){var s=this.loading.get(e);if(s){var i=s.array,a=i.reduce((e,t)=>e+t.length,0),r=new Uint8Array(a);let t=0;for(let e=0;e<i.length;e++)r.set(i[e],t),t+=i[e].length;a=new TextDecoder("utf-8").decode(r),a=JSON.parse(a);this.askFont({name:s.name,font:a}),this.loading.delete(e)}else console.log("inconsistent message")}}FontModelManager.register("FontModelManager");class FontViewManager extends o.ViewService{constructor(e,t){super(t||"FontViewManager"),this.fonts=new Map,this.isLoading={},this.fudgeFactors=new Map,this.fudgeFactors.set("Roboto",{yoffset:30})}setModel(e){this.model=e;for(var[t,s]of this.model.fonts.entries())this.askFont(t,s)}get(e){return this.fonts.get(e)}askFont(h,t){if(this.fonts.get(h))return Promise.resolve(this.fonts.get(h));if(!this.isLoading[h]){let e=(window.microverseDir||"./")+"assets/fonts",s=e+`/${h}.png`;this.isLoading[h]=t?Promise.resolve(t):new Promise((s,i)=>{a()(e+`/${h}.json`,(e,t)=>{e&&i(e),s(t)})}),this.isLoading[h]=this.isLoading[h].then(l=>{let t=new b.THREE.TextureLoader;return new Promise((n,e)=>{t.load(s,e=>{var t=new d.sP,s=l.common?l.common.scaleW:l.atlas.width,i=l.common?l.common.scaleH:l.atlas.height,a=new Image(s,i),r=document.createElement("canvas"),s=(r.width=s,r.height=i,r.getContext("2d")),i=(s.drawImage(e.image,0,0),s.getImageData(0,0,r.width,r.height)),e=t.process(l,i.data);s.putImageData(e,0,0);let o=new b.THREE.Texture(e);o.minFilter=b.THREE.LinearMipMapLinearFilter,o.magFilter=b.THREE.LinearFilter,o.generateMipmaps=!0,o.anisotropy=1,a.src=r.toDataURL("image/png"),a.onload=()=>{o.needsUpdate=!0},this.fonts.set(h,{font:l,texture:o}),delete this.isLoading[h],(this.model.fonts.get(h)?null:l)?this.sendLargeFont(h,l):this.publish(this.model.id,"askFont",{name:h}),n(this.fonts.get(h))},null,()=>{this.isLoading[h]=!1,e(new Error("failed to load font: "+h))})})})}return this.isLoading[h]}sendLargeFont(e,t){var t=JSON.stringify(t),s=(new TextEncoder).encode(t);let i=0;var a=Math.random();for(this.publish(this.model.id,"fontLoadStart",{key:a,name:e});i<s.length;){var r=s.slice(i,i+2880);this.publish(this.model.id,"fontLoadOne",{key:a,buf:r}),i+=2880}this.publish(this.model.id,"fontLoadDone",a)}destroy(){this.fonts.forEach((e,t)=>{e.material&&(e.material.dispose(),e.material=null)})}}class TextFieldActor extends e.Z4{init(e){this.fonts=this.service("FontModelManager"),this.doc=new Doc({defaultFont:this.fonts.constructor.defaultFont(),defaultSize:10}),this.doc.load(e.runs||[]),this.content={runs:[],selections:{},undoStacks:{},timezone:0,queue:[],editable:!0},e.textScale||(e.textScale=.0025),super.init(e),this.subscribe(this.id,"load","loadAndReset"),this.subscribe(this.id,"editEvents","receiveEditEvents"),this.subscribe(this.id,"accept","publishAccept"),this.subscribe(this.id,"undoRequest","undoRequest"),this.subscribe(this.id,"setExtent","setExtent"),this.subscribe(this.sessionId,"view-exit","viewExit"),this.listen("dismiss","dismiss");var t=e.width/e.textScale,s=e.height/e.textScale;this.setExtent({width:t,height:s}),this.depth=e.depth||0,e.noDismissButton||this.setupDismissButton(),e.scrollBar&&this.setupScrollBar(e),e.readOnly&&(s=((t=e.margins)&&void 0!==t.left?t.left:0)+(t&&void 0!==t.right?t.right:0),t=i.measureText(this.value),this.measurement={width:(t.width+s)*e.textScale,height:t.height*e.textScale})}get pawn(){return TextFieldPawn}static defaultMeasurement(e){return i.measureText(e)}static types(){return{"Warota.Doc":Doc}}load(e){let t;t="string"==typeof e?[{text:e}]:e,this.doc.load(t),this.publishChanged(),this.needsUpdate()}save(){return{runs:this.doc.runs,defaultFont:this.doc.defaultFont,defaultSize:this.doc.defaultSize}}setExtent(e){this.extent=e}loadAndReset(e){let t;t="string"==typeof e?[{text:e}]:e,this.content={runs:t,selections:{},undoStacks:{},timezone:0,queue:[],editable:!0},this.doc.load(t),this.publishAccept(),this.needsUpdate()}receiveEditEvents(e){var[,e]=this.doc.receiveEditEvents(e,this.content,this.doc);e&&this.publishChanged(),this.needsUpdate()}publishAccept(){this.publish(this.id,"text",{id:this.id,text:this.doc.plainText()})}publishChanged(){this.publish(this.id,"changed",{id:this.id})}viewExit(e){delete this.content.selections[e],this.needsUpdate()}needsUpdate(){this.say("screenUpdate",this.content.timezone)}undoRequest(t){let s;var i=this.content.queue;for(let e=i.length-1;0<=e;e--){var a=i[e];if(a.user.id===t.id&&"snapshot"!==a.type&&"select"!==a.type){s=i[e];break}}s&&(this.doc.undoEvent(s,this.content,this.doc),this.needsUpdate())}setDefault(e,t){return this.doc.setDefault(e,t)}styleAt(e){return this.doc.styleAt(e)}updateOptions(e){super.updateOptions(e);var t=e.width/e.textScale,s=e.height/e.textScale;this.setExtent({width:t,height:s}),this.dismissButton&&this.dismissButton.destroy(),e.noDismissButton||this.setupDismissButton(),e.scrollBar&&this.setupScrollBar(e)}get value(){return this.doc.plainText()}set value(e){return this.load(e)}setupDismissButton(){this.dismissButton=DismissButtonActor.create({type:"object",backgroundColor:this._cardData.backgroundColor,parent:this,translation:this.dismissButtonPosition(),noSave:!0,color:2236962}),this.subscribe(this.dismissButton.id,"dismiss","dismiss")}setupScrollBar(e){this.scrollBar&&this.scrollBar.destroy(),e.scrollBar&&(this.scrollBar=TextScrollBarActor.create({type:"object",name:"scroll bar",noSave:!0,parent:this,barColor:e.barColor,knobColor:e.knobColor,barWidth:e.barWidth}))}dismissButtonPosition(){var e=void 0===this._cardData.barWidth?.1:this._cardData.barWidth,e=this._cardData.scrollBar?e:0;return[this._cardData.width/2-.072+e,this._cardData.height/2-.072,.06]}dismiss(){this.destroy()}}TextFieldActor.register("TextFieldActor");class TextFieldPawn extends e.Df{constructor(e){super(e),this.addToLayers("pointer"),this.widgets={},this.setupEditor(),this.setupMesh(),this.fonts=this.service("FontViewManager"),this.listen("fontAsked","fontAsked"),this.listen("screenUpdate","screenUpdate"),this.setupFonts(),this.actor._cardData.readOnly||(this.addEventListener("pointerDown","onPointerDown"),this.addEventListener("pointerMove","onPointerMove"),this.addEventListener("pointerUp","onPointerUp"),this.addEventListener("keyDown","keyDown")),this.subscribe(this.id,"scroll","scroll"),this.listen("cardDataSet","cardDataUpdated"),this.scrollBarRatio=0}destroy(){["geometry","material","textGeometry","textMaterial"].forEach(e=>{this[e]&&this[e].dispose(),this[e]=null}),super.destroy()}textScale(){return this.actor._cardData.textScale}test(){}needsUpdate(){this.screenUpdate(this.warota.timezone)}randomColor(e){return`hsl(${Math.floor(parseInt(e,36)/(36**10/360))}, 40%, 40%)`}cardDataUpdated(e){var t,s,i;e.o.backgroundColor===e.v.backgroundColor&&e.o.frameColor===e.v.frameColor&&e.o.fullBright===e.v.fullBright||({depth:e,backgroundColor:t,frameColor:s,fullBright:i}=e.v,this.material=this.makePlaneMaterial(e,t,s,i),this.plane.material=this.material)}changeMaterial(e,t){this.textMaterial&&this.textMaterial.dispose();let s;if(this.fonts.get(e))return e=this.fonts.get(e).texture,this.textMaterial=new b.THREE.RawShaderMaterial((0,d.N8)({map:e,textureSize:e.image.width,side:b.THREE.BackSide,transparent:!0},b.THREE)),t&&((s=new b.THREE.Mesh(this.textGeometry,this.textMaterial)).name="text"),s}setupFonts(){var e=this.actor.doc.defaultFont;this.fontAsked(e).then(()=>{var e=Array.from(this.actor.fonts.keys()).map(e=>this.fonts.askFont(e));return Promise.all(e)}).then(()=>{this.warota.resetMeasurer(),this.needsUpdate()})}setupTextMesh(e,t,s){var i;this.textGeometry||(i=(0,d.aB)(b.THREE),this.textGeometry=new i({defaultColor:new b.THREE.Color(s)}),this.textMesh=this.changeMaterial(e,!0),this.textMesh.renderOrder=123,this.plane.add(this.textMesh)),(i=n.hasLayout(e))||(i=new((0,d.y7)(b.THREE))({font:t}),n.addLayout(e,i))}updateMesh(e){var t,s,{fontName:e,drawnStrings:i}=e;this.fonts.get(e)&&(t=this.fonts.get(e).font,s=this.fonts.fudgeFactors.get(e),e=n.hasLayout(e))&&(e=e.computeGlyphs({font:t,drawnStrings:i,fudgeFactor:s}),this.textMesh.scale.x=this.textScale(),this.textMesh.scale.y=-this.textScale(),this.textGeometry.update({font:t,glyphs:e}))}updateShape(e){super.updateShape(e),["geometry","material","textGeometry","textMaterial"].forEach(e=>{this[e]&&this[e].dispose(),this[e]=null}),this.setupMesh(),this.setupFonts()}setupMesh(){let{depth:e,opacity:t}=this.actor._cardData,s=(void 0===e&&(e=.01),this.actor._cardData.cornerRadius),{backgroundColor:i,frameColor:a,fullBright:r}=(void 0===s&&(s=.05),this.actor._cardData);i=i||16777215,a=a||6710886,void 0===r&&(r=!1),0===e?this.geometry=new b.THREE.PlaneGeometry(0,0):this.geometry=this.roundedCornerGeometry(0,0,e,s);var o=this.makePlaneMaterial(e,i,a,r);void 0!==t&&1!==t&&(Array.isArray(o)?o:[o]).forEach(e=>{e.transparent=!0,e.opacity=t}),this.material=o,this.plane=new b.THREE.Mesh(this.geometry,this.material),this.plane.castShadow=!0,this.plane.name=this.actor.name,this.shape.add(this.plane),this.clippingPlanes=[new b.THREE.Plane(new b.THREE.Vector3(0,1,0),0),new b.THREE.Plane(new b.THREE.Vector3(0,-1,0),0),new b.THREE.Plane(new b.THREE.Vector3(-1,0,0),0),new b.THREE.Plane(new b.THREE.Vector3(1,0,0),0)]}setupEditor(){var e=this.actor.doc.defaultFont,t=this.actor.doc.defaultSize,s=this.actor.extent,i=this.actor._cardData.autoResize,a=this.actor._cardData.singleLine,r=this.actor._cardData.margins,e={width:s.width,height:s.height,font:e,fontSize:t,autoResize:i,singleLine:a,margins:r};this.warota=new Warota(e,this.actor.doc),this.warota.width(s.width),this.options=e,this.user={id:this.viewId,color:this.randomColor(this.viewId)},this.selections={},this.subscribe(this.viewId,"synced","synced")}fontAsked(t){return this.fonts.askFont(t).then(e=>this.setupTextMesh(t,e.font,this.actor._cardData.color||0)).then(()=>(this.warota.resetMeasurer(),this.screenUpdate(this.warota.timezone)))}computeClippingPlanes(){var t=this.plane.geometry.parameters.height,s=this.plane.geometry.parameters.width,i=[],a=this.plane;if(Number.isNaN(a.matrixWorld.elements[0]))return[];for(let e=0;e<4;e++)i[e]=new b.THREE.Plane,i[e].copy(this.clippingPlanes[e]),i[e].constant=e<2?t/2:s/2,i[e].applyMatrix4(a.matrixWorld);return i._width=s,i._height=t,i}setWidth(e){this.publish(this.actor.id,"setWidth",e),this.width(e)}width(e){this.warota.width(e),this.screenUpdate(this.warota.timezone)}synced(e){this.isSynced=e,this.isSynced&&(this.warota.resetMeasurer(),this.screenUpdate(this.warota.timezone))}getSynced(){var e=this.service("SyncedStateManager");return(e||this).isSynced}accept(){this.publish(this.actor.id,"accept")}cookEvent(e){var t,s;if(e.xyz)return e=new b.THREE.Vector3(...e.xyz),t=this.renderObject.matrixWorld.clone().invert(),e=e.applyMatrix4(t),t=this.plane.geometry.parameters.width,s=this.plane.geometry.parameters.height,{x:(t/2+e.x)/this.textScale(),y:(s/2-e.y+this.getScrollTop(s))/this.textScale()}}onPointerDown(e){!this.actor._cardData.readOnly&&(this.service("KeyFocusManager").setKeyboardInput(this),e=this.cookEvent(e))&&this.warota.mouseDown(e.x,e.y,e.y,this.user)}onPointerMove(e){this.actor._cardData.readOnly||(e=this.cookEvent(e))&&(this.warota.mouseMove(Math.max(e.x,0),e.y,e.y,this.user),this.changed())}onPointerUp(e){this.actor._cardData.readOnly||(e=this.cookEvent(e))&&(this.warota.mouseUp(e.x,e.y,e.y,this.user),this.changed())}newCanonicalizeEvent(e){var t,s;return"input"!==e.type||"insertText"!==e.inputType||e.isComposing?null:(s=(t=this.service("KeyFocusManager")).hiddenInput.value,{keyCombo:t.hiddenInput.value="",key:s,shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:e.type,keyCode:e.keyCode})}eventFromField(){var e=this.service("KeyFocusManager"),t=e.hiddenInput.value;return{keyCombo:e.hiddenInput.value="",key:t,shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:"",keyCode:0}}simpleInput(e,t){var s=this.user,i=this.actor.content.selections[this.viewId],i=this.actor.styleAt(Math.max(i?i.start-1:0,0));return this.warota.insert(s,[{text:e,style:i}]),this.changed(!0),t.preventDefault(),!0}input(e){var t,s,i;if(!this.actor._cardData.readOnly)return!!(t=this.newCanonicalizeEvent(e))&&(s=this.user,i=this.actor.content.selections[this.viewId],i=this.actor.styleAt(Math.max(i?i.start-1:0,0)),this.warota.insert(s,[{text:t.key,style:i}]),this.changed(!0),e.preventDefault(),!0)}keyDown(e){let t;t="Enter"===e.key&&""!==(i=this.service("KeyFocusManager").hiddenInput).value?(i.value="",this.eventFromField()):canonicalizeKeyboardEvent(e);var s,i=this.user;return!t||!!t.onlyModifiers||(["Meta-S","Ctrl-S","Alt-S"].includes(t.keyCombo)?(this.accept(),e.preventDefault(),!0):["Meta-Z","Ctrl-Z","Alt-Z"].includes(t.keyCombo)?(this.undo(),e.preventDefault(),!0):["Meta-C","Ctrl-C","Alt-C"].includes(t.keyCombo)?(this.copy(),e.preventDefault(),!0):["Meta-X","Ctrl-X","Alt-X"].includes(t.keyCombo)?(this.cut(),e.preventDefault(),!0):["Meta-V","Ctrl-V","Alt-V"].includes(t.keyCombo)?(this.paste(),e.preventDefault(),!0):13===t.keyCode?this.actor.enterToAccept?(e.preventDefault(),this.accept(),!0):this.simpleInput("\n",e):32===t.keyCode?this.simpleInput(" ",e):9===t.keyCode?this.simpleInput("\t",e):(s=this.warota.handleKey(i,t.keyCode,t.shiftKey,t.ctrlKey||t.metaKey))||t.ctrlKey||t.metaKey?(s&&(e.preventDefault(),this.changed(!0)),!1):(this.warota.insert(i,[{text:t.key}]),this.changed(!0),e.preventDefault(),!0))}copy(e){let i=navigator.userAgent.match(/ipad|iphone/i),a=this.warota.selectionText(this.user);(navigator.clipboard?navigator.clipboard.writeText(a).then(()=>!0,()=>!1):Promise.resolve(!1)).then(e=>{var t,s;e||(e=this.service("KeyFocusManager")["copyElement"],i?((t=document.createRange()).selectNodeContents(e),e.textContent=a,(s=window.getSelection()).removeAllRanges(),s.addRange(t),e.setSelectionRange(0,1e5)):(e.value=a,e.select(),e.setSelectionRange(0,99999)),document.execCommand("copy"))})}cut(e){return this.copy(e),this.warota.insert(this.user,[{text:""}]),this.changed(!0),!0}paste(e){return(navigator.clipboard?navigator.clipboard.readText().then(e=>e,()=>null):Promise.resolve(null)).then(e=>{var t;return null===e?(t=this.service("KeyFocusManager")["copyElement"],t.focus(),t.textContent="",document.execCommand("paste"),t.textContent):e}).then(e=>{this.warota.insert(this.user,[{text:e}]),this.changed(!0)})}undo(){this.publish(this.actor.id,"undoRequest",this.user)}changed(e){var t=this.warota.events;this.warota.resetEvents(),0<t.length&&(this.scrollNeeded=!this.singleLine&&e,this.publish(this.actor.id,"editEvents",t))}screenUpdate(e){this.warota.timezone=e,this.getSynced()&&(this.warota.layout(),this.showText(),this.setExtent(),this.showSelections(),this.scrollNeeded)&&(this.scrollNeeded=!1)}showText(){var t=[];for(let e=0;e<this.warota.words.length-1;e++){var s=this.warota.words[e],s={x:s.left,y:s.top,string:s.text,style:s.style&&s.style.color};t.push(s)}var e=this.actor.extent;this.updateMesh({fontName:this.warota.doc.defaultFont,extent:e,drawnStrings:t})}setStyle(e){this.warota.setStyle(this.user,e,!1),this.changed()}mergeStyle(e){this.warota.setStyle(this.user,e,!0),this.changed()}getScrollTop(e){var t=this.warota.docHeight*this.textScale();return t<=e?0:(t-e+.1)*this.scrollBarRatio}setExtent(){var e,t=this.actor.extent,s=this.actor.depth,i=this.actor._cardData.cornerRadius||.05,a=this.actor._cardData.autoResize;this.textMesh&&(e=(a?this.warota.newWidth:t.width)*this.textScale(),a=(a?this.warota.docHeight:t.height)*this.textScale(),e===this.plane.geometry.parameters.width&&a===this.plane.geometry.parameters.height&&s===this.plane.geometry.parameters.depth||(i=0===s?new b.THREE.PlaneGeometry(e,a):this.roundedCornerGeometry(e,a,s,i),this.plane.geometry=i,this.geometry&&(this.geometry.dispose(),this.geometry=null),this.geometry=i),i=this.getScrollTop(a),this.textMesh.position.x=-e/2,this.textMesh.position.y=a/2+i,this.textMesh.position.z=s+.005,this.setScrollBarExtent(t,{width:e,height:a}),s={left:0,top:i/this.textScale(),bottom:(a+i)/this.textScale(),right:e/this.textScale()},this.textMesh.material.uniforms.corners.value=new b.THREE.Vector4(s.left,s.top,s.right,s.bottom))}setTextRenderingBounds(e){this.textMesh?.material?.uniforms?.corners&&(this.textMesh.material.uniforms.corners.value=new b.THREE.Vector4(e.left,e.top,e.right,e.bottom))}setScrollBarExtent(e,t){var s=(0,o.GetPawn)(this.actor.scrollBar?.id);if(s){let e=this.plane.geometry.parameters.height;var i=this.warota.docHeight*this.textScale(),a=this.getScrollTop(e),r=.1/e,a=(i>e&&(e-=.1),a/i),i=Math.min(e/i,1),i=Math.max(r,i);s.setExtent(t,a,i)}}scroll(e){this.scrollBarRatio=e,this.needsUpdate()}ensureSelection(e){let t=this.selections[e];let s=this.actor.content.selections[e].color;if(s=s||"blue",!t){let e=new b.THREE.Mesh(new b.THREE.PlaneBufferGeometry(.1,.1),new b.THREE.MeshBasicMaterial({color:s}));e.visible=!1,this.plane.add(e),e.name="caret",e.onBeforeRender=()=>this.selectionBeforeRender(e);var i=[];for(let t=0;t<3;t++){let e=new b.THREE.Mesh(new b.THREE.PlaneBufferGeometry(0,0),new b.THREE.MeshBasicMaterial({color:s}));e.visible=!1,e.name="box"+t,e.onBeforeRender=()=>this.selectionBeforeRender(e),this.plane.add(e),i.push(e)}t={bar:e,boxes:i}}return this.selections[e]=t}selectionBeforeRender(e){e.material.clippingPlanes=this.computeClippingPlanes()}showSelections(){var e,t=this.actor.depth||0,s={};for(e in this.selections)s[e]=this.selections[e];var i,a,r=this.textScale(),o=this.plane.geometry.parameters.width,n=this.plane.geometry.parameters.height,l=this.getScrollTop(n);for(i in this.actor.content.selections){delete s[i];var h=this.ensureSelection(i),d=(h.boxes.forEach(e=>e.visible=!1),this.actor.content.selections[i]);if(d.end===d.start){var c=h.bar,u=(c.visible=!0,this.warota.barRect(d)),p=(u.width=r<=.001?5:2,new b.THREE.PlaneBufferGeometry(u.width*r,u.height*r)),m=c.geometry,p=(c.geometry=p,m&&m.dispose(),-o/2+(u.left+6)*r),m=n/2-(u.top+u.height/2+4)*r+l;c.position.set(p,m,t+.001)}else{var f=this.warota.selectionRects(d),v=h.boxes;for(let e=0;e<3;e++){var g,y,w,_=v[e],x=f[e];_.visible=!1,x&&(g=-o/2+(x.width/2+x.left+8)*r,y=n/2-(x.top+x.height/2+4)*r+l,w=x.width*r,x=x.height*r,w=new b.THREE.PlaneBufferGeometry(w,x,2,2),_.geometry=w,_.position.set(g,y,t+.001),_.visible=!0)}}}for(a in s)this.selections[a].bar.removeFromParent(),this.selections[a].boxes.forEach(e=>e.removeFromParent()),delete this.selections[a];this.publish(this.id,"selectionUpdated")}addWidget(e,t){this.widgets[e]&&this.removeWidget(e,t),this.widgets[e]=t,this.selectionPane.appendChild(t)}removeWidget(e,t){delete this.widgets[e],t.remove()}get hitNormal(){return[0,0,1]}}class DismissButtonActor extends e.Z4{get pawn(){return DismissButtonPawn}}DismissButtonActor.register("DismissButtonActor");class DismissButtonPawn extends e.Df{constructor(e){super(e),this.addToLayers("pointer"),this.back&&(this.shape.remove(this.back),this.shape.children=[]);var e=void 0!==this.actor._cardData.backgroundColor?this.actor._cardData.backgroundColor:13421772,t=void 0!==this.actor._cardData.color?this.actor._cardData.color:2236962,s=new b.THREE.BoxGeometry(.08,.08,1e-5),e=new b.THREE.MeshStandardMaterial({color:e,side:b.THREE.DoubleSide}),s=(this.back=new b.THREE.Mesh(s,e),new b.THREE.BoxGeometry(.07,.02,.001)),e=new b.THREE.MeshStandardMaterial({color:t,side:b.THREE.DoubleSide}),t=new b.THREE.Mesh(s,e);t.position.set(0,0,1e-5),this.back.add(t),this.shape.add(this.back),this.addEventListener("pointerDown","dismiss")}dismiss(e){this.publish(this.actor.id,"dismiss")}}class TextScrollBarActor extends e.Z4{get pawn(){return TextScrollBarPawn}}TextScrollBarActor.register("TextScrollBarActor");class TextScrollBarPawn extends e.Df{constructor(e){super(e);var t=void 0===e._cardData.barColor?6710886:e._cardData.barColor,s=void 0===e._cardData.knobColor?13421772:e._cardData.knobColor,e=void 0===e._cardData.barWidth?.1:e._cardData.barWidth,i=new b.THREE.PlaneGeometry(e,0),t=new b.THREE.MeshBasicMaterial({color:t,side:b.THREE.DoubleSide}),i=(this.scrollMesh=new b.THREE.Mesh(i,t),this.scrollMesh.name="scroll",new b.THREE.PlaneGeometry(e,0)),t=new b.THREE.MeshBasicMaterial({color:s,side:b.THREE.DoubleSide});this.scrollKnobMesh=new b.THREE.Mesh(i,t),this.scrollKnobMesh.name="scrollKnob",this.scrollKnobMesh.position.set(0,0,.001),this.scrollMesh.add(this.scrollKnobMesh),this.shape.add(this.scrollMesh),this.addEventListener("pointerDown","pointerDown"),this.addEventListener("pointerMove","pointerMove"),this.addEventListener("pointerUp","pointerUp")}pointerDown(e){this.interactionPlane=new b.THREE.Plane;var t=(0,o.v3_transform)([0,0,1],this.global);this.interactionPlane.setFromNormalAndCoplanarPoint(new b.THREE.Vector3(...t),new b.THREE.Vector3(...e.xyz)),this.getMyAvatar().addFirstResponder("pointerMove",{},this)}pointerMove(e){var t=new b.THREE.Vector3(...e.ray.origin),e=new b.THREE.Vector3(...e.ray.direction),t=new b.THREE.Ray(t,e).intersectPlane(this.interactionPlane,new b.THREE.Vector3),e=this.cookEvent(t.toArray());this.parent&&this.publish(this.parent.id,"scroll",e)}pointerUp(e){this.getMyAvatar().removeFirstResponder("pointerMove",{},this)}cookEvent(e){var t;if(e)return e=new b.THREE.Vector3(...e),t=this.shape.matrixWorld.clone().invert(),e=e.applyMatrix4(t),e=(t=this.scrollMesh.geometry.parameters.height)/2-e.y,Math.max(Math.min(e/t,1),0)}setExtent(e,t,s){var i=void 0===this.actor._cardData.barWidth?.1:this.actor._cardData.barWidth,a=(this.scrollMesh.geometry.parameters.height!==e.height&&(a=new b.THREE.PlaneGeometry(i,e.height),this.scrollMesh.geometry.dispose(),this.scrollMesh.geometry=a),e.height*s),s=(this.scrollKnobMesh.geometry.parameters.height!==a&&(s=new b.THREE.PlaneGeometry(i,a),this.scrollKnobMesh.geometry.dispose(),this.scrollKnobMesh.geometry=s),e.height/2-e.height*t);this.scrollKnobMesh.position.set(0,s-=a/2,.0015),this.set({translation:[e.width/2+i/2,0,.001]})}}},8335:(e,t,s)=>{"use strict";s.d(t,{R:()=>WalkManager});class WalkManager extends s(4200).ViewService{constructor(e){super(e||"WalkManager"),this.walkers=[]}setupDefaultWalkers(){[["BuiltinWalker","WalkerPawn","checkPortal"],["BuiltinWalker","WalkerPawn","backoutFromFall"],["BuiltinWalker","WalkerPawn","bvh"]].forEach(e=>this.append(e))}append(e){if(3!==e.length)throw new Error('walker spec should be in the form of "[ModuleName, BehaviorName, methodName]"');this.walkers.push(e)}insertBefore(e,t){if(!t)return this.append(e);t=this.findIndex(t);if(0<=t){if(3!==e.length)throw new Error('walker spec should be in the form of "[ModuleName, BehaviorName, methodName]"');this.walkers.splice(t,0,e)}}remove(e){e=this.findIndex(e);0<=e&&this.walkers.splice(e,1)}findIndex(t){return this.walkers.findIndex(e=>e[0]==t[0]+"$"+t[1]&&e[2]===t[2])}removeAll(){this.walkers=[]}walk(t,s,i,a){for(let e=0;e<this.walkers.length;e++){var r=this.walkers[e],[r,o]=t.actor.behaviorManager.lookup(r[0],r[1]).invoke(t,r[2],s,i,a);if(o)return r;s=r}return s}}},9087:(e,t,s)=>{"use strict";s.d(t,{m:()=>AssetManager});var i=s(3782);class AssetManager extends s(4200).ViewService{constructor(e){super(e||"AssetManager"),this.assetManager=new i.me}}},188:(e,t,s)=>{"use strict";function startHelpMenu(){closeAllDialogs(),function createHelpMenu(){var e=`
    <div id="helpDialog" class="dialogPanel no-select">
    <button id="close-button" type="button" class="btn btn-danger btn-x topright">x</button>
        <div id="share-container" class="content-container">
            <div id="help-title" class="panel-title">Help</div>
            <div id="table-wrapper">
                <div id="table-scroll" id="scrollbar">
                    <table class="help-table">
                        <tr class="help-row">
                            <td>
                                <p class="table-head">Navigate</p>
                                <p class="table-desc">Move around using the joystick, or WASD keys.</p>
                            </td>
                            <td class="icon-column">
                                <div class="icons">
                                    <div class="help-pane-icon move-icon"></div>
                                    <div class="help-pane-icon wasd-icon"></div>
                                </div>
                            </td>
                        </tr>
                        <tr class="help-row">
                            <td>
                                <p class="table-head">Look</p>
                                <p class="table-desc">Click and drag to change camera look position.</p>
                            </td>
                        <td class="icon-column">
                            <div class="icons"><div class="help-pane-icon look-icon"></div>
                        </td>
                    </tr>
                    <tr class="help-row">
                        <td>
                            <p class="table-head">Manipulate</p>
                            <p class="table-desc">Ctrl + click on an object to open and cycle through the "gizmo" tools. The icon of a multi-pane tool is a button to open the property sheet tool.</p>
                        </td>
                        <td class="icon-column">
                            <div class="icons">
                                <div class="help-pane-icon ctrlclick-icon"></div>
                            </div>
                        </td>
                    </tr>
                    <tr class="help-row">
                        <td>
                            <p class="table-head">Fullscreen</p>
                            <p class="table-desc">Make your browser fullscreen.</p>
                        </td>
                        <td class="icon-column"><i class="fas fa-solid fa-expand icons"></i></td>
                    </tr>
                    <tr class="help-row">
                        <td>
                            <p class="table-head">Home</p>
                            <p class="table-desc">Reset location back to original landing place.</p>
                        </td>
                        <td class="icon-column"><i class="fas fa-solid fa-house-user icons"></i></td>
                    </tr>
                    <tr class="help-row">
                        <td>
                            <p class="table-head">Gather</p>
                            <p class="table-desc">Shows how many users in a world. Click to "gather" all users to you.</p>
                        </td>
                        <td class="icon-column"><i class="fas fa-solid fa-users icons"></i></td>
                    </tr>
                    <tr class="help-row">
                        <td>
                            <p class="table-head">Import</p>
                            <p class="table-desc">Import any of these formats from your desktop directly
                                 into the Microverse World. Either drag and drop, or choose the import menu item.</p>
                        </td>
                        <td class="icon-column">
                            <div class="icons">
                                <div class="help-pane-icon import-icon help-menu-icon"></div>
                            </div>
                        </td>
                     </tr>
                     <tr class="help-row">
                         <td>
                             <p class="table-head">Connect</p>
                             <p class="table-desc">Click connect to link your text editor to edit behavior files.</p>
                         </td>
                         <td class="icon-column">
                             <div class="icons">
                                 <div class="help-pane-icon connect-icon help-menu-icon"</div>
                             </div>
                         </td>
                     </tr>
                     <tr class="help-row">
                         <td>
                             <p class="table-head">Share</p>
                             <p class="table-desc">Save your Microverse as a .vrse file to share or use the QR code to share the session with others.</p>
                         </td>
                         <td class="icon-column">
                             <div class="icons">
                                 <div class="help-pane-icon share-icon help-menu-icon"></div>
                             </div>
                         </td>
                     </tr>
                     <tr class="help-row">
                         <td>
                             <p class="table-head">Settings</p>
                             <p class="table-desc">Update your in-world nickname, select from default avatars or paste a link to your own.</p>
                         </td>
                         <td class="icon-column">
                             <div class="icons">
                                 <div class="help-pane-icon settings-icon help-menu-icon"></div>
                             </div>
                         </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>`.trim(),t=document.createElement("div"),e=(t.innerHTML=e,t.querySelector("#helpDialog")),t=e.querySelector("#close-button");filterDomEventsOn(e),t.onclick=()=>closeAllDialogs(),document.body.appendChild(e)}(),hideShellControls()}s.d(t,{ts:()=>closeAllDialogs,gA:()=>filterDomEventsOn,aP:()=>hideShellControls,TV:()=>function setupWorldMenuButton(e,t,s){{var i,a;l||(i=document.createElement("div"),(r=document.createElement("div")).id="statsDiv",(a=document.createElement("div")).id="qrDiv",r.classList.add("statsHidden"),i.appendChild(a),i.appendChild(r),t.root=i,t.badge=!1,t.qrcode=a,t.stats=r,t.makeSessionWidgets(s),a.onclick=null,function initWorldMenu(e){var t=document.createElement("div"),s=(t.id="worldMenu",t.classList.add("worldMenu"),`
<div id="worldMenu-load" class="menu-label menu-item">
    <div class="menu-icon import-icon"></div>
    <span class="menu-label-text">Import</span>
</div>
<div id="worldMenu-connect" class="menu-label menu-item">
    <div class="menu-icon connect-icon" id="connectIcon"></div>
    <span class="menu-label-text" id="connectBtn">Connect</span>
</div>
<div id="worldMenu-gather" class="menu-label menu-item">
    <div class="menu-icon presentationMode-icon"></div>
    <span class="menu-label-text">Gather</span>
</div>
<div id="worldMenu-shareButton" class="menu-label menu-item">
    <div class="menu-icon share-icon"></div>
    <span class="menu-label-text">Share</span>
</div>
<div id="worldMenu-settings" class="menu-label menu-item">
    <div class="menu-icon settings-icon"></div>
    <span class="menu-label-text">Settings</span>
</div>
<div id="worldMenu-helpButton" class="menu-label menu-item">
    <div class="menu-icon help-icon"></div>
    <span class="menu-label-text">Help</span>
</div>
`.trim()),i=document.createElement("div"),s=(i.innerHTML=s,i.querySelector("#worldMenu-load")),a=i.querySelector("#worldMenu-connect"),r=i.querySelector("#worldMenu-settings"),o=i.querySelector("#worldMenu-shareButton"),n=i.querySelector("#worldMenu-helpButton"),i=i.querySelector("#worldMenu-gather");t.appendChild(e),e.id="worldMenu-qr",e.classList.add("menu-qr","menu-item"),t.appendChild(s),t.appendChild(a),t.appendChild(i),t.appendChild(o),t.appendChild(r),t.appendChild(n),filterDomEventsOn(l=t),h=!1,document.getElementById("hud").appendChild(l)}(i))}var r=document.querySelector("#worldMenuBtn");r.onclick=()=>toggleMenu(e),filterDomEventsOn(r)},_s:()=>function updateWorldMenu(e){h&&setMenuItems(e)}});var a=s(3917);let l=null,h=!1,r=null,o=!!("ontouchstart"in window);function loadPressed(a){if(!r){var e=document.createElement("div");e.innerHTML='<input id="imageinput" type="file" accept="application/json,image/*,.glb,.obj..fbx,.wrl,.zip,.svg,.vrse,.exr,.pdf,.mp3,.wav">',r=e.firstChild;r.onchange=()=>{for(const i of r.files){e=i.name,s=void 0;let t=0<=(s=e.lastIndexOf("."))?e.slice(s+1).toLowerCase():null;new Promise(e=>{let t=new FileReader;t.onload=()=>e(t.result),t.readAsArrayBuffer(i)}).then(e=>{"vrse"===t?a.loadvrse(e):a.analyzeAndUploadFile(e,i.name,t)})}var e,s;r.value=""}}document.getElementById("hud").appendChild(r),r.click(),h&&toggleMenu()}function connectFeedback(e){var t=document.getElementById("connectBtn"),s=document.getElementById("connectIcon");e?(t.textContent="Connected",t.classList.add("connected"),s.classList.remove("connect-icon"),s.classList.add("connected-icon")):(t.textContent="Connect",t.classList.remove("connected"),s.classList.add("connect-icon"),s.classList.remove("connected-icon"))}function setMenuItems(t){var e=l.querySelector("#worldMenu-gather"),s=e.querySelector("span");t.actor.service("PlayerManager").presentationMode?s.textContent="Stop Gathering":s.textContent="Gather";let i;(i=l.querySelector("#worldMenu-qr")).onclick=e=>{e.preventDefault(),e.stopPropagation(),e.shiftKey||o?function switchQRView(){var e=l.querySelector("#qrDiv"),t=l.querySelector("#statsDiv"),s=t.querySelector("#innerDiv").childNodes[1],i="statsHidden";s&&s.classList.add(i),t.style.height="176px",e.classList.contains(i)?(e.classList.toggle(i,!1),t.classList.toggle(i,!0)):(e.classList.toggle(i,!0),t.classList.toggle(i,!1))}():function qrPressed(e,t){var s=document.createElement("div");s.innerHTML=`<a id="link" target="_blank" rel="noopener noreferrer" href="${t}"></a>`,document.getElementById("hud").appendChild(s),s.querySelector("#link").click(),s.remove()}(0,window.location)},(i=l.querySelector("#worldMenu-load")).onclick=e=>{e.preventDefault(),e.stopPropagation(),loadPressed(t)},(i=l.querySelector("#worldMenu-connect")).onclick=()=>function connectPressed(e){(e=e.service("BehaviorViewManager"))&&e.setURL("ws://localhost:9011",connectFeedback)}(t),(i=l.querySelector("#worldMenu-settings"))&&(i.onclick=()=>function settingsPressed(e){e&&(e.showSettingsMenu(),(0,a.sendToShell)("hud",{joystick:!1,fullscreen:!1})),toggleMenu()}(t)),(i=l.querySelector("#worldMenu-shareButton"))&&(i.onclick=()=>{!function sharePressed(e){e&&(e.showShareMenu(),(0,a.sendToShell)("hud",{joystick:!1,fullscreen:!1})),toggleMenu()}(t)}),(i=l.querySelector("#worldMenu-helpButton"))&&(i.onclick=()=>function helpPressed(e){e&&(startHelpMenu(),(0,a.sendToShell)("hud",{joystick:!1,fullscreen:!1})),toggleMenu()}(t)),(i=e)&&(i.onclick=()=>{t.actor.service("PlayerManager").presentationMode?function forceStop(e){e.say("stopPresentation"),h}(t):t.comeToMe()})}function toggleMenu(e){h?(l.classList.remove("menuVisible"),h=!1):(setMenuItems(e),h=!0,l.classList.add("menuVisible"))}function filterDomEventsOn(e){e.onpointerdown=e=>e.stopPropagation(),e.onpointerup=e=>e.stopPropagation(),e.onpointermove=e=>e.stopPropagation(),e.onwheel=e=>e.stopPropagation()}function closeAllDialogs(){document.querySelectorAll(".dialogPanel").forEach(e=>e.remove()),(0,a.sendToShell)("hud",{joystick:!0,fullscreen:!0});var e=document.querySelector("#homeBtn");e&&(e.style.display="flex")}function hideShellControls(){(0,a.sendToShell)("hud",{joystick:!1,fullscreen:!1});var e=document.querySelector("#homeBtn");e&&(e.style.display="none")}!function loadCSS(){if(!document.head.querySelector("#settings-css"))return new Promise((e,t)=>{var s=window.microverseDir||"./",i=document.createElement("link");i.rel="stylesheet",i.type="text/css",i.id="settings-css",i.href=s+"assets/css/settings.css",i.onload=e,i.onerror=t,document.head.appendChild(i)});Promise.resolve(!0)}()},4072:(e,t,s)=>{"use strict";s.d(t,{H:()=>WorldSaver});var r=s(3654);s(4200);class WorldSaver{constructor(e){this.map=new Map,this.id=0,this.defaultClass=e}newId(){return(++this.id).toString().padStart(4,"0")}save(e){var t,s,i=[];for([t,s]of e.service("ActorManager").actors)s.isCard&&!s.noSave&&i.push(s);var a=this.topologicalSort(i),a=this.collectData(a);return{behaviorModules:e.service("BehaviorModelManager").save(),cards:a}}topologicalSort(e){for(var t=new Map,s=[...e],i=new Map;0<s.length;){var a=s.shift();if(!a._parent||t.get(a._parent.id))t.set(a.id,a);else{if(i.get(a))throw new Error("actors make a cycle");s.push(a),i.set(a,!0)}}return t}collectData(e){var t,s,i=[];for([t,s]of e){var a={id:this.newId()},r=(this.map.set(s,a),this.collectCardData(s));a.card=r,i.push(a)}return i}collectCardData(s,i){let a={};var e;return s.constructor!==this.defaultClass&&(a.className=s.constructor.name),r.Wh.forEach(e=>{if(s["_"+e])if("parent"===e)if(i){var t=s[e];if(!t)throw new Error("undefined parent used");a[e]=t.id}else{t=this.map.get(s[e]);if(!t)throw new Error("undefined parent used");a[e]=t.id}else a[e]=s["_"+e]}),s._cardData&&((e=Object.keys(s._cardData)).sort(),e.forEach(e=>{a[e]=s._cardData[e]})),a}stringifyInner(s,i){if(void 0!==s){if("number"==typeof s)return Number.isFinite(s)?""+s:"null";if("object"!=typeof s)return JSON.stringify(s);let t;if(Array.isArray(s)){t="[";for(let e=0;e<s.length;e++)0<e&&(t+=","),t+=this.stringifyInner(s[e],i)||"null";return t+"]"}if(null===s)return"null";if(i.has(s))throw new TypeError("Converting circular structure to JSON");var e;if(i.add(s),s.constructor===window.Map)return e={__map:!0,values:[...s]},this.stringifyInner(e,i);var a=Object.keys(s).sort();t="";for(let e=0;e<a.length;e++){var r=a[e],o=this.stringifyInner(s[r],i,t);o&&(""!==t&&(t+=","),t+=JSON.stringify(r)+":"+o)}return i.delete(s),"{"+t+"}"}}stringify(e){var t=new Set;return this.stringifyInner(e,t)}parse(e){return JSON.parse(e,(e,t)=>"object"==typeof t&&null!==t&&t.__map?new Map(t.values):t)}}},3700:()=>{}}]);